<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>NBA GM 單機版 v0.7.3</title>
<style>
body{font-family:Arial;background:#f5f5f5;padding:20px}
h1{margin-bottom:5px}
.version{color:red;font-weight:bold;margin-bottom:15px}
button{margin:4px;padding:6px 12px;cursor:pointer}
table{border-collapse:collapse;background:#fff;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px 10px;text-align:center}
.selected{background:#dff0ff}
.trade{color:orange;font-weight:bold}
#layout{display:flex;gap:20px}
#panel{background:#fff;padding:10px;min-width:220px}
#aiPanel{background:#fff;padding:10px;margin-top:10px;display:none}
</style>
</head>
<body>
<h1>NBA GM 單機版</h1>
<div class="version">（v0.7.3｜一次可選多個新秀 + 新秀只在模擬下一季出現 + 防止 undefined）</div>

<!-- 選隊 -->
<div id="selectTeamUI">
<h2>Step 1：選擇球隊</h2>
<select id="teamSelect"></select>
<button onclick="selectTeam()">開始 GM 生涯</button>
</div>

<!-- 建隊階段 -->
<div id="buildTeam" style="display:none">
<h2>建隊階段：選擇球員加入你的隊伍</h2>
<div id="salaryInfo"></div>
<table id="poolTable">
<thead>
<tr><th>球員</th><th>位置</th><th>OVR</th><th>薪資</th></tr>
</thead>
<tbody></tbody>
</table>
<h3>當前選中隊伍</h3>
<table id="rosterTable">
<thead>
<tr><th>球員</th><th>位置</th><th>OVR</th><th>薪資</th></tr>
</thead>
<tbody></tbody>
</table>
<div id="logBuild" style="margin-top:10px;background:#fff;padding:5px">選擇球員，注意薪資上限與隊伍人數！</div>
<button onclick="confirmTeam()">確認隊伍</button>
</div>

<!-- GM 生涯 -->
<div id="game" style="display:none">
<h2 id="teamTitle"></h2>
<div id="layout">
<div>
<h3>你的球隊</h3>
<table id="roster">
<thead>
<tr><th>球員</th><th>位置</th><th>OVR</th><th>年齡</th><th>薪資</th></tr>
</thead>
<tbody></tbody>
</table>

<h3>自由球員池（簽約新秀，每季最多 2 人）</h3>
<table id="freeAgents">
<thead>
<tr><th>選</th><th>球員</th><th>位置</th><th>OVR</th><th>薪資</th></tr>
</thead>
<tbody></tbody>
</table>
<button onclick="signFreeAgents()">簽約選中球員</button>
<h4 id="logFreeAgent" style="background:#fff;padding:5px;margin-top:5px">自由球員池</h4>
</div>

<div id="panel">
<h3>球員操作</h3>
<div id="playerInfo">請選擇球員</div>
<button onclick="trainPlayer()">訓練</button><br>
<button onclick="toggleTrade()">標記為交易籌碼</button>
<br><br>
<button onclick="nextSeason()">模擬下一季</button>
<br><br>
<button onclick="toggleAIView()">查看其他隊伍</button>
<div id="aiPanel"></div>
<br>
<button onclick="restartGame()">重啟生涯</button>
</div>
</div>
<div id="log" style="margin-top:15px;background:#fff;padding:10px">GM 準備就緒</div>
</div>

<script>
// ===== 設定 =====
const SALARY_CAP=120;
const MAX_PLAYERS=15;
const INITIAL_POOL_MIN=30;
const INITIAL_POOL_MAX=40;
const NEW_DRAFT_PER_SEASON=30;
const MAX_SIGN=2;
const MAX_AI_SIGN=2;

// NBA 球員清單（示例）
// 建議補齊完整名單避免人不夠
const nbaPlayers=[
{name:"Stephen Curry",pos:"PG",ovr:78},
{name:"LeBron James",pos:"SF",ovr:82},
{name:"Kevin Durant",pos:"SF",ovr:80},
{name:"Giannis Antetokounmpo",pos:"PF",ovr:81},
{name:"Luka Doncic",pos:"PG",ovr:79},
{name:"Joel Embiid",pos:"C",ovr:80},
{name:"Anthony Davis",pos:"PF",ovr:77},
{name:"Kawhi Leonard",pos:"SF",ovr:78},
{name:"James Harden",pos:"SG",ovr:79},
{name:"Jayson Tatum",pos:"SF",ovr:76},
{name:"Bradley Beal",pos:"SG",ovr:75},
{name:"Damian Lillard",pos:"PG",ovr:77},
{name:"Jimmy Butler",pos:"SF",ovr:76},
{name:"Chris Paul",pos:"PG",ovr:75},
{name:"Devin Booker",pos:"SG",ovr:76},
{name:"Karl-Anthony Towns",pos:"C",ovr:75},
{name:"Zion Williamson",pos:"PF",ovr:74},
{name:"Trae Young",pos:"PG",ovr:74},
{name:"Rudy Gobert",pos:"C",ovr:74},
{name:"Donovan Mitchell",pos:"SG",ovr:73},
{name:"Ja Morant",pos:"PG",ovr:73},
{name:"Jrue Holiday",pos:"PG",ovr:72},
{name:"Bam Adebayo",pos:"C",ovr:72},
{name:"Paul George",pos:"SF",ovr:73},
{name:"DeMar DeRozan",pos:"SF",ovr:72},
{name:"Draymond Green",pos:"PF",ovr:71},
{name:"Klay Thompson",pos:"SG",ovr:71},
];

// 球隊資料
const teamData = {Warriors:[],Lakers:[],Celtics:[],Nuggets:[],Bucks:[]};

let playerTeam=null;
let roster=[];
let pool=[];  // 自由球員池只放新秀
let aiTeams={};
let selectedRosterIndex=null;
let selectedFreeAgentIndices=[]; // 多選
let currentSalary=0;
let aiView=false;
let signedThisSeason=0;
let newDraftThisSeason=[]; // 新秀待加入

// ===== 工具 =====
function randInt(min,max){return Math.floor(Math.random()*(max-min+1))+min;}
function shuffle(arr){for(let i=arr.length-1;i>0;i--){let j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}

// ===== 初始化自由球員池 (建隊用) =====
function initPool(){
 pool=[];
 shuffle(nbaPlayers);
 let count=randInt(INITIAL_POOL_MIN,INITIAL_POOL_MAX);
 for(let i=0;i<count;i++){
   let p={...nbaPlayers[i],age:18,salary:randInt(5,15),trade:false};
   pool.push(p);
 }
}

// ===== 選隊 =====
const sel=document.getElementById("teamSelect");
Object.keys(teamData).forEach(t=>{
 let o=document.createElement("option");
 o.value=t;o.textContent=t;
 sel.appendChild(o);
});

function selectTeam(){
 playerTeam=sel.value;
document.getElementById("buildTeam").style.display="block";
document.getElementById("salaryInfo").textContent="薪資上限 $"+SALARY_CAP+"M，當前 $0M";
initPool();
renderPool();
renderRosterTable();
document.getElementById("selectTeamUI").style.display="none";
}

// ===== 建隊渲染 =====
function renderPool(){
 const tb=document.querySelector("#poolTable tbody");
 tb.innerHTML="";
 pool.forEach((p,i)=>{
  if(!p || !p.name) return;
  const tr=document.createElement("tr");
  tr.innerHTML=`<td>${p.name}</td><td>${p.pos}</td><td>${p.ovr}</td><td>$${p.salary}M</td>`;
  tr.onclick=()=>{addToRoster(i)};
  tb.appendChild(tr);
 });
}
function renderRosterTable(){
 const tb=document.querySelector("#rosterTable tbody");
 tb.innerHTML="";
 roster.forEach((p,i)=>{
   if(!p || !p.name) return;
   const tr=document.createElement("tr");
   tr.innerHTML=`<td>${p.name}</td><td>${p.pos}</td><td>${p.ovr}</td><td>$${p.salary}M</td>`;
   tb.appendChild(tr);
 });
}

// ===== 加入 roster 建隊 =====
function addToRoster(i){
 if(roster.length>=MAX_PLAYERS){alert("隊伍已滿");return;}
 let p=pool[i];
 if(!p || !p.name) return;
 if(currentSalary+p.salary>SALARY_CAP){alert("超過薪資上限");return;}
 roster.push(p);
 currentSalary+=p.salary;
 pool.splice(i,1);
renderPool();
renderRosterTable();
document.getElementById("salaryInfo").textContent=`薪資上限 $${SALARY_CAP}M，當前 $${currentSalary}M`;
}

// ===== 確認隊伍 =====
function confirmTeam(){
 Object.keys(teamData).forEach(t=>{
   if(t!==playerTeam){aiTeams[t]=[];}
 });
 // 分配剩餘球員給 AI 每隊最多2個
 pool.forEach(p=>{
   if(!p || !p.name) return;
   let teams=Object.keys(aiTeams);
   let t=teams[randInt(0,teams.length-1)];
   if(aiTeams[t].length<MAX_AI_SIGN){aiTeams[t].push(p);}
 });
 pool = pool.filter(p => !Object.values(aiTeams).flat().includes(p));
 document.getElementById("buildTeam").style.display="none";
 document.getElementById("game").style.display="block";
 document.getElementById("teamTitle").textContent="你是 "+playerTeam+" 的 GM";
 renderRoster(); renderFreeAgents(); renderRosterTable();
 log("建隊完成！開始 GM 生涯");
 saveGame();
}

// ===== GM 生涯渲染 =====
function renderRoster(){
 const tb=document.querySelector("#roster tbody");
 tb.innerHTML="";
 roster.forEach((p,i)=>{
  if(!p || !p.name) return;
  const tr=document.createElement("tr");
  if(i===selectedRosterIndex) tr.classList.add("selected");
  tr.innerHTML=`<td>${p.name}${p.trade?" <span class='trade'>TRADE</span>":""}</td><td>${p.pos}</td><td>${p.ovr}</td><td>${p.age}</td><td>$${p.salary}M</td>`;
  tr.onclick=()=>{selectedRosterIndex=i;highlightRoster();};
  tb.appendChild(tr);
 });
}
function highlightRoster(){renderRoster();}

// ===== 訓練 =====
function trainPlayer(){
 if(selectedRosterIndex===null){alert("請先選球員");return;}
 let p=roster[selectedRosterIndex];
 let gain=0;
 if(p.age<=24) gain=randInt(1,3);
 else if(p.age<=29) gain=randInt(0,2);
 else gain=randInt(0,1);
 p.ovr=Math.min(99,p.ovr+gain);
 log(`${p.name} 訓練成長：+${gain} OVR`);
 renderRoster();
 saveGame();
}

// ===== 交易標記 =====
function toggleTrade(){
 if(selectedRosterIndex===null){alert("請先選球員");return;}
 const p=roster[selectedRosterIndex];
 p.trade=!p.trade;
 log(`${p.name} ${p.trade?"已":"取消"}列入交易名單`);
 renderRoster();
 saveGame();
}

// ===== 渲染新秀池 (可多選) =====
function renderFreeAgents(){
 const tb=document.querySelector("#freeAgents tbody");
 tb.innerHTML="";
 pool.forEach((p,i)=>{
   if(!p || !p.name) return;
   const tr=document.createElement("tr");
   const checked = selectedFreeAgentIndices.includes(i) ? "checked" : "";
   tr.innerHTML=`<td><input type="checkbox" ${checked} onclick="toggleSelectFreeAgent(${i})"></td><td>${p.name}</td><td>${p.pos}</td><td>${p.ovr}</td><td>$${p.salary}M</td>`;
   tb.appendChild(tr);
 });
}
function toggleSelectFreeAgent(i){
 const idx=selectedFreeAgentIndices.indexOf(i);
 if(idx===-1) selectedFreeAgentIndices.push(i);
 else selectedFreeAgentIndices.splice(idx,1);
 renderFreeAgents();
}

// ===== 簽約新秀 =====
function signFreeAgents(){
 if(selectedFreeAgentIndices.length===0){alert("請選球員"); return;}
 if(selectedFreeAgentIndices.length>MAX_SIGN) {alert(`最多簽 ${MAX_SIGN} 個新秀`); return;}
 for(let i=selectedFreeAgentIndices.sort((a,b)=>b-a)){ // 從大到小刪
   let p=pool[i];
   if(!p || !p.name) continue;
   if(roster.length>=MAX_PLAYERS){alert("隊伍已滿"); break;}
   if(currentSalary+p.salary>SALARY_CAP){alert("薪資超過限制"); continue;}
   roster.push(p);
   currentSalary+=p.salary;
   pool.splice(i,1);
 }
 selectedFreeAgentIndices=[];
 // AI 每隊簽 2 個
 Object.keys(aiTeams).forEach(t=>{
   let added=0;
   for(let i=0;i<pool.length && added<MAX_AI_SIGN;i++){
     let np=pool[i];
     if(!np || !np.name) continue;
     aiTeams[t].push(np);
     pool.splice(i,1);
     added++;
     i--;
   }
 });
 renderRoster(); renderFreeAgents();
 log("簽約完成，本季結束");
 saveGame();
}

// ===== 模擬下一季 =====
function nextSeason(){
 roster.forEach(p=>p.age++);
 signedThisSeason=0;
 generateNewDraft();
 renderRoster(); renderFreeAgents();
 log("新賽季開始，新秀已加入自由球員池");
 saveGame();
}

// ===== 生成新秀 =====
function generateNewDraft(){
 newDraftThisSeason=[];
 let availablePlayers=nbaPlayers.filter(p=>!roster.some(r=>r.name===p.name)&&!Object.values(aiTeams).flat().some(r=>r.name===p.name)&&!pool.some(r=>r.name===p.name));
 if(availablePlayers.length===0){ // 自動生成 placeholder
   for(let i=0;i<NEW_DRAFT_PER_SEASON;i++){
     let p={name:"新人"+randInt(100,999),pos:["PG","SG","SF","PF","C"][randInt(0,4)],ovr:randInt(65,75),age:18,salary:randInt(5,15),trade:false};
     newDraftThisSeason.push(p);
   }
 } else {
   shuffle(availablePlayers);
   for(let i=0;i<NEW_DRAFT_PER_SEASON;i++){
     let p={...availablePlayers[i%availablePlayers.length],age:18,salary:randInt(5,15),trade:false};
     newDraftThisSeason.push(p);
   }
 }
 pool = pool.concat(newDraftThisSeason);
}

// ===== 查看 AI 球隊 =====
function toggleAIView(){
 aiView=!aiView;
 const panel=document.getElementById("aiPanel");
 if(aiView){
   let html="";
   Object.keys(aiTeams).forEach(t=>{
     html+=`<h4>${t}</h4><table border=1><tr><th>球員</th><th>位置</th><th>OVR</th><th>薪資</th></tr>`;
     aiTeams[t].forEach(p=>{
       if(!p || !p.name) return;
       html+=`<tr><td>${p.name}</td><td>${p.pos}</td><td>${p.ovr}</td><td>$${p.salary}M</td></tr>`;
     });
     html+="</table>";
   });
   panel.innerHTML=html;
   panel.style.display="block";
 } else {panel.style.display="none";}
}

// ===== 存檔 / 讀檔 =====
function saveGame(){
 localStorage.setItem("NBA_GM_roster",JSON.stringify(roster));
 localStorage.setItem("NBA_GM_pool",JSON.stringify(pool));
 localStorage.setItem("NBA_GM_team",playerTeam);
 localStorage.setItem("NBA_GM_aiTeams",JSON.stringify(aiTeams));
}

function loadGame(){
 const r=localStorage.getItem("NBA_GM_roster");
 const p=localStorage.getItem("NBA_GM_pool");
 const t=localStorage.getItem("NBA_GM_team");
 const a=localStorage.getItem("NBA_GM_aiTeams");
 if(r&&p&&t&&a){
  roster=JSON.parse(r);
  pool=JSON.parse(p);
  playerTeam=t;
  aiTeams=JSON.parse(a);
  document.getElementById("selectTeamUI").style.display="none";
  document.getElementById("buildTeam").style.display="none";
  document.getElementById("game").style.display="block";
  document.getElementById("teamTitle").textContent="你是 "+playerTeam+" 的 GM";
  renderRoster();renderFreeAgents();renderRosterTable();
  log("讀取存檔完成！");
 }
}

// ===== 重啟 =====
function restartGame(){
 if(confirm("確定要刪除存檔並重啟生涯嗎？")){
  localStorage.clear();
  location.reload();
 }
}

// ===== 日誌 =====
function log(msg){
 const l=document.getElementById("log");
 l.textContent=msg;
}

// ===== 初始化 =====
window.addEventListener("DOMContentLoaded",()=>{loadGame();});
</script>
</body>
</html>
