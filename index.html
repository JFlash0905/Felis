<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NBA GM Game — Full (Manual FA + Multi-Trade + Cap + Training)</title>
  <style>
    :root{
      --bg:#0b0f14;--card:#111827;--panel:#0b1220;--stroke:#243044;
      --text:#e5e7eb;--muted:#9ca3af;--accent:#22c55e;--warn:#f59e0b;--bad:#ef4444;--blue:#60a5fa;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif}
    body{margin:0;background:linear-gradient(180deg,#070a10,#0b0f14);color:var(--text)}
    header{
      padding:14px 16px;border-bottom:1px solid #1f2937;position:sticky;top:0;
      background:rgba(11,15,20,.92);backdrop-filter:blur(10px);z-index:10;
      display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;
    }
    header h1{margin:0;font-size:16px}
    header .muted{color:var(--muted);font-size:12px}
    main{padding:16px;max-width:1240px;margin:0 auto}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:1100px){.grid{grid-template-columns: 430px 1fr}}
    .card{background:rgba(17,24,39,.92);border:1px solid #1f2937;border-radius:12px;padding:12px}
    .panel{background:rgba(7,16,33,.55);border:1px solid #1f2937;border-radius:12px;padding:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row.space{justify-content:space-between}
    button,select,input{
      background:var(--panel);color:var(--text);
      border:1px solid var(--stroke);border-radius:10px;
      padding:10px 10px;font-size:14px
    }
    button{cursor:pointer}
    button.primary{background:linear-gradient(180deg,#22c55e,#16a34a);border:none;color:#041007;font-weight:800}
    button.ghost{background:transparent}
    button.warn{background:rgba(245,158,11,.13);border:1px solid rgba(245,158,11,.5)}
    button.danger{background:rgba(239,68,68,.13);border:1px solid rgba(239,68,68,.5)}
    button.blue{background:rgba(96,165,250,.14);border:1px solid rgba(96,165,250,.5)}
    button:disabled{opacity:.45;cursor:not-allowed}
    select{min-width:180px}
    .pill{padding:4px 8px;border-radius:999px;border:1px solid var(--stroke);color:var(--muted);font-size:12px}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .kpi .box{flex:1 1 120px;background:var(--panel);border:1px solid var(--stroke);border-radius:12px;padding:10px}
    .kpi .box b{font-size:18px}
    .muted{color:var(--muted)}
    .tiny{font-size:12px}
    .bigTitle{font-size:18px;margin:0 0 6px 0}
    .teamGrid{display:grid;grid-template-columns:1fr;gap:8px}
    @media(min-width:860px){.teamGrid{grid-template-columns:1fr 1fr}}
    .teamBtn{
      width:100%;text-align:left;display:flex;justify-content:space-between;align-items:center;gap:10px;
      padding:12px;border-radius:12px
    }
    .teamBtn b{font-size:14px}
    .teamBtn small{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #1f2937;font-size:13px;vertical-align:top}
    th{color:#cbd5e1;text-align:left}
    tr:hover td{background:rgba(255,255,255,.02)}
    .star{color:#fde68a}
    .tag{font-size:12px;color:var(--muted);border:1px solid var(--stroke);border-radius:999px;padding:2px 8px}
    .warnTxt{color:#fcd34d}
    .goodTxt{color:#86efac}
    .badTxt{color:#fca5a5}
    .linkBtn{background:transparent;border:none;padding:0;color:#93c5fd;cursor:pointer}
    .linkBtn:hover{text-decoration:underline}
    .cols2{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:940px){.cols2{grid-template-columns:1fr 1fr}}
    .miniList{max-height:320px;overflow:auto;background:var(--panel);border:1px solid var(--stroke);border-radius:12px;padding:8px}
    .miniList .item{padding:8px;border-bottom:1px solid rgba(255,255,255,.06)}
    .miniList .item:last-child{border-bottom:none}
    .log{max-height:220px;overflow:auto;background:var(--panel);border:1px solid var(--stroke);border-radius:12px;padding:10px}
    .log p{margin:6px 0;font-size:13px}
    .modalBackdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.6);
      display:none;align-items:center;justify-content:center;padding:16px;z-index:50;
    }
    .modal{
      width:min(820px,100%);background:rgba(17,24,39,.97);
      border:1px solid #263244;border-radius:14px;padding:14px;
    }
    .modal h2{margin:0 0 8px 0;font-size:18px}
    .modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}
    .modal .body{background:var(--panel);border:1px solid var(--stroke);border-radius:12px;padding:12px}
    .modal input{width:100%}
    .banner{
      padding:10px;border-radius:12px;border:1px solid rgba(245,158,11,.35);
      background:rgba(245,158,11,.08);
    }
    .checkRow{
      display:flex;gap:10px;align-items:flex-start;justify-content:space-between;
      padding:8px;border-bottom:1px solid rgba(255,255,255,.06)
    }
    .checkRow:last-child{border-bottom:none}
    .checkRow label{display:flex;gap:10px;align-items:flex-start;cursor:pointer}
    .checkRow input{margin-top:3px}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body>
<header>
  <div>
    <h1>NBA GM Game — Full</h1>
    <div class="muted">純手動自由市場｜休賽季輪流簽｜多換一交易｜薪資上限｜訓練（TP/疲勞/POT）｜自動存檔</div>
  </div>
  <div class="row">
    <span class="pill" id="hdrStatus">未選隊</span>
    <button class="danger" id="btnReset">Reset</button>
  </div>
</header>

<main>
  <div class="grid">
    <!-- LEFT -->
    <section class="card">
      <div class="row space">
        <div>
          <div class="tiny muted">目前階段</div>
          <div class="row">
            <b id="phaseTitle">選隊</b>
            <span class="pill" id="phasePill">Step 1/7</span>
          </div>
        </div>
        <div class="row">
          <button class="ghost" id="btnExport">Export Save JSON</button>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="kpi">
        <div class="box">
          <div class="tiny muted">賽季</div>
          <b id="kpiSeason">-</b>
        </div>
        <div class="box">
          <div class="tiny muted">進度</div>
          <b id="kpiDay">-</b>
        </div>
        <div class="box">
          <div class="tiny muted">你的戰績</div>
          <b><span id="kpiW">0</span>-<span id="kpiL">0</span></b>
        </div>
        <div class="box">
          <div class="tiny muted">薪資 / Cap</div>
          <b id="kpiSalary">-</b>
        </div>
        <div class="box">
          <div class="tiny muted">訓練 TP</div>
          <b id="kpiTP">-</b>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="panel">
        <div class="row space">
          <b>比賽 / 賽季推進</b>
          <span class="pill" id="seasonHint">-</span>
        </div>
        <div style="height:10px"></div>
        <div class="row">
          <button class="primary" id="btnSim1">模擬 1 天</button>
          <button class="ghost" id="btnSim7">模擬 7 天</button>
          <button class="ghost" id="btnSimAll">模擬到季末</button>
          <button class="warn" id="btnNewSeason">新賽季</button>
        </div>
        <div class="tiny muted" style="margin-top:8px">
          1 天 = 全聯盟 15 場。<br/>
          <span class="warnTxt">季末：選秀（30 人釋出）→ 休賽季自由市場（輪流簽）→ 開季。</span>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="panel">
        <div class="row space">
          <b>事件紀錄</b>
          <button class="ghost danger" id="btnClearLog">清空</button>
        </div>
        <div style="height:8px"></div>
        <div class="log" id="log"></div>
      </div>

      <div style="height:10px"></div>

      <details>
        <summary class="muted">Import Save JSON（貼上覆蓋）</summary>
        <div style="height:8px"></div>
        <input id="importBox" placeholder='把 Export 的 JSON 貼這裡，按 Import' />
        <div style="height:8px"></div>
        <button class="warn" id="btnImport" style="width:100%">Import（覆蓋存檔）</button>
        <div class="tiny muted" style="margin-top:6px">Import 會直接套用你貼上的狀態。</div>
      </details>
    </section>

    <!-- RIGHT -->
    <section class="card">

      <!-- SCREEN: TEAM -->
      <div id="screenTeam">
        <p class="bigTitle">Step 1：選擇你的隊伍</p>
        <p class="muted tiny" style="margin-top:-2px">選完就鎖定，除非 Reset。</p>
        <div class="teamGrid" id="teamGrid"></div>
      </div>

      <!-- SCREEN: CORE -->
      <div id="screenCore" style="display:none">
        <div class="row space">
          <div>
            <p class="bigTitle">Step 2：選 2–3 位基石（候選90）</p>
            <p class="muted tiny" style="margin-top:-2px">選到 2 位才可進主介面，最多 3 位。</p>
          </div>
          <div class="row">
            <span class="tag" id="coreCountTag">已選 0</span>
            <button class="primary" id="btnFinishCore" disabled>完成建隊 →</button>
          </div>
        </div>

        <div class="panel">
          <div class="row space">
            <b>基石候選池</b>
            <span class="pill muted">點卡片選取 / 取消</span>
          </div>
          <div style="height:8px"></div>
          <div class="teamGrid" id="coreGrid"></div>
        </div>
      </div>

      <!-- SCREEN: HUB -->
      <div id="screenHub" style="display:none">
        <div class="row space">
          <div>
            <p class="bigTitle">主介面</p>
            <div class="muted tiny">名單｜訓練｜交易｜自由市場（手動）｜推賽季｜看排名。</div>
          </div>
          <div class="row">
            <span class="pill" id="hubTeamPill">-</span>
            <button class="ghost" id="btnGoTrain">訓練</button>
            <button class="ghost" id="btnGoFA">自由市場</button>
            <button class="blue" id="btnGoTrade">交易中心</button>
          </div>
        </div>

        <div id="hubBanner" style="display:none;margin-top:10px"></div>

        <div class="cols2" style="margin-top:10px">
          <div class="panel">
            <div class="row space">
              <b>你的球員名單</b>
              <span class="pill muted" id="rosterCapPill">-</span>
            </div>
            <table id="rosterTable"></table>
          </div>

          <div class="panel">
            <div class="row space">
              <b>聯盟排名</b>
              <span class="pill muted">依勝率排序</span>
            </div>
            <table id="standingsTable"></table>
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="panel">
          <div class="row space">
            <b>聯盟基石概覽</b>
            <span class="pill muted">每隊 2–3 位</span>
          </div>
          <div class="miniList" id="leagueCoresList"></div>
        </div>
      </div>

      <!-- SCREEN: TRADE -->
      <div id="screenTrade" style="display:none">
        <div class="row space">
          <div>
            <p class="bigTitle">交易中心（多換一 / 一換多）</p>
            <div class="tiny muted">用勾選清單選人；會檢查名單上限與薪資上限。</div>
          </div>
          <div class="row">
            <button class="ghost" id="btnBackHubFromTrade">← 回主介面</button>
          </div>
        </div>

        <div class="panel">
          <div class="row space">
            <b>選擇對手隊伍</b>
            <span class="pill" id="tradeHintPill">-</span>
          </div>
          <div style="height:10px"></div>

          <div class="row">
            <select id="oppSelect"></select>
            <button class="ghost" id="btnRefreshTrade">刷新清單</button>
          </div>

          <div style="height:12px"></div>

          <div class="cols2">
            <div class="panel" style="background:rgba(11,18,32,.8)">
              <div class="row space">
                <b>你送出（可多選）</b>
                <span class="pill" id="giveSummary">-</span>
              </div>
              <div class="tiny muted" style="margin-top:6px">建議：用多個輪換湊到想換的球星。</div>
              <div style="height:8px"></div>
              <div class="miniList" id="giveList"></div>
            </div>

            <div class="panel" style="background:rgba(11,18,32,.8)">
              <div class="row space">
                <b>你得到（可多選）</b>
                <span class="pill" id="getSummary">-</span>
              </div>
              <div class="tiny muted" style="margin-top:6px">牽涉基石倍率更高。</div>
              <div style="height:8px"></div>
              <div class="miniList" id="getList"></div>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="row space">
            <div class="tiny muted" id="tradeRuleInfo">-</div>
            <button class="primary" id="btnTrade">送出交易</button>
          </div>

          <div class="tiny muted" style="margin-top:8px" id="tradeAfterInfo">-</div>
        </div>
      </div>

      <!-- SCREEN: FREE AGENCY -->
      <div id="screenFA" style="display:none">
        <div class="row space">
          <div>
            <p class="bigTitle">自由市場（純手動）</p>
            <div class="tiny muted">例行賽可隨時簽；休賽季會依戰績倒序輪流簽（你的回合才可簽）。</div>
          </div>
          <div class="row">
            <button class="ghost" id="btnBackHubFromFA">← 回主介面</button>
          </div>
        </div>

        <div id="faBanner" style="display:none;margin-top:10px"></div>

        <div class="panel" style="margin-top:10px">
          <div class="row space">
            <b>自由球員清單</b>
            <span class="pill" id="faHintPill">-</span>
          </div>
          <div style="height:10px"></div>

          <div class="row">
            <input id="faSearch" placeholder="搜尋名字（例如 Curry）" style="flex:1;min-width:220px" />
            <select id="faPosFilter">
              <option value="">全部位置</option>
              <option value="PG">PG</option>
              <option value="SG">SG</option>
              <option value="SF">SF</option>
              <option value="PF">PF</option>
              <option value="C">C</option>
            </select>
            <select id="faSort">
              <option value="ovr">OVR 高→低</option>
              <option value="age">年齡 低→高</option>
              <option value="name">名字 A→Z</option>
            </select>
          </div>

          <div style="height:10px"></div>

          <div class="cols2">
            <div class="panel" style="background:rgba(11,18,32,.8)">
              <b>可簽球員（Top 60 顯示）</b>
              <div class="tiny muted" style="margin-top:6px">點名字看詳情；按「簽下」會檢查薪資上限。</div>
              <div style="height:8px"></div>
              <div class="miniList" id="faList"></div>
            </div>

            <div class="panel" style="background:rgba(11,18,32,.8)">
              <b>你的名單</b>
              <div class="tiny muted" style="margin-top:6px">名單滿或超 cap 就不能簽（可用交易/釋出調整）。</div>
              <div style="height:8px"></div>
              <div class="miniList" id="faMyRoster"></div>
            </div>
          </div>

          <div class="tiny muted" style="margin-top:10px">
            <b>選秀：</b>季末會從新秀池釋出 30 人（每隊 1 位），依排名倒序選。
          </div>
        </div>
      </div>

    </section>
  </div>
</main>

<!-- Modal -->
<div class="modalBackdrop" id="modalBackdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <h2 id="modalTitle">Title</h2>
    <div class="body" id="modalBody"></div>
    <div class="actions" id="modalActions"></div>
  </div>
</div>

<script>
/* =========================
   NBA GM — FULL VERSION
   ========================= */

const LS_KEY = "nba_gm_full_manualfa_multitrade_cap_training_v1";

const MAX_ROSTER = 12;
const DEFAULT_GAMES_PER_TEAM = 20;

// Salary Cap (Hard Cap)
const CAP = 120;

// Offseason FA rounds (turn-based)
const OFFSEASON_FA_ROUNDS = 4;

const TEAMS = [
  "Atlanta Hawks","Boston Celtics","Brooklyn Nets","Charlotte Hornets","Chicago Bulls",
  "Cleveland Cavaliers","Dallas Mavericks","Denver Nuggets","Detroit Pistons","Golden State Warriors",
  "Houston Rockets","Indiana Pacers","LA Clippers","Los Angeles Lakers","Memphis Grizzlies",
  "Miami Heat","Milwaukee Bucks","Minnesota Timberwolves","New Orleans Pelicans","New York Knicks",
  "Oklahoma City Thunder","Orlando Magic","Philadelphia 76ers","Phoenix Suns","Portland Trail Blazers",
  "Sacramento Kings","San Antonio Spurs","Toronto Raptors","Utah Jazz","Washington Wizards"
];

const rand = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
const el = id => document.getElementById(id);

function escapeHtml(s){
  return (s??"").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================
   Data: Core 90 + FA 90 -> single ACTIVE pool
   Rookie 200 -> released 30 per season
   ========================= */

// Core candidates (real names)
const CORE_90_RAW = [
  {name:"Nikola Jokic",pos:"C"},{name:"Giannis Antetokounmpo",pos:"PF"},{name:"Luka Doncic",pos:"PG"},
  {name:"Shai Gilgeous-Alexander",pos:"PG"},{name:"Joel Embiid",pos:"C"},{name:"Jayson Tatum",pos:"SF"},
  {name:"Stephen Curry",pos:"PG"},{name:"LeBron James",pos:"SF"},{name:"Kevin Durant",pos:"SF"},
  {name:"Anthony Davis",pos:"PF"},{name:"Devin Booker",pos:"SG"},{name:"Kawhi Leonard",pos:"SF"},
  {name:"Jimmy Butler",pos:"SF"},{name:"Damian Lillard",pos:"PG"},{name:"Ja Morant",pos:"PG"},
  {name:"Anthony Edwards",pos:"SG"},{name:"Donovan Mitchell",pos:"SG"},{name:"Tyrese Haliburton",pos:"PG"},
  {name:"Jalen Brunson",pos:"PG"},{name:"Jaylen Brown",pos:"SG"},{name:"Kyrie Irving",pos:"PG"},
  {name:"Karl-Anthony Towns",pos:"C"},{name:"Bam Adebayo",pos:"C"},{name:"Domantas Sabonis",pos:"C"},
  {name:"Paul George",pos:"SF"},{name:"De'Aaron Fox",pos:"PG"},{name:"Jamal Murray",pos:"PG"},
  {name:"Tyrese Maxey",pos:"SG"},{name:"Zion Williamson",pos:"PF"},{name:"Trae Young",pos:"PG"},
  {name:"Victor Wembanyama",pos:"C"},{name:"Paolo Banchero",pos:"PF"},{name:"Scottie Barnes",pos:"SF"},
  {name:"Cade Cunningham",pos:"PG"},{name:"Evan Mobley",pos:"PF"},{name:"Franz Wagner",pos:"SF"},
  {name:"Alperen Sengun",pos:"C"},{name:"Jaren Jackson Jr.",pos:"PF"},{name:"Desmond Bane",pos:"SG"},
  {name:"Mikal Bridges",pos:"SF"},{name:"Brandon Ingram",pos:"SF"},{name:"Lauri Markkanen",pos:"PF"},
  {name:"Julius Randle",pos:"PF"},{name:"Pascal Siakam",pos:"PF"},{name:"Rudy Gobert",pos:"C"},
  {name:"Kristaps Porzingis",pos:"C"},{name:"Jrue Holiday",pos:"PG"},{name:"James Harden",pos:"SG"},
  {name:"DeMar DeRozan",pos:"SF"},{name:"Deandre Ayton",pos:"C"},{name:"Darius Garland",pos:"PG"},
  {name:"Dejounte Murray",pos:"PG"},{name:"LaMelo Ball",pos:"PG"},{name:"Jarrett Allen",pos:"C"},
  {name:"Zach LaVine",pos:"SG"},{name:"Draymond Green",pos:"PF"},{name:"Klay Thompson",pos:"SG"},
  {name:"Chris Paul",pos:"PG"},{name:"Bradley Beal",pos:"SG"},{name:"Michael Porter Jr.",pos:"SF"},
  {name:"Aaron Gordon",pos:"PF"},{name:"CJ McCollum",pos:"SG"},{name:"Jalen Williams",pos:"SF"},
  {name:"Chet Holmgren",pos:"C"},{name:"Khris Middleton",pos:"SF"},{name:"Tobias Harris",pos:"PF"},
  {name:"Myles Turner",pos:"C"},{name:"OG Anunoby",pos:"SF"},{name:"Devin Vassell",pos:"SG"},
  {name:"Anfernee Simons",pos:"SG"},{name:"Jabari Smith Jr.",pos:"PF"},{name:"Keegan Murray",pos:"PF"},
  {name:"Brandon Miller",pos:"SF"},{name:"Scoot Henderson",pos:"PG"},{name:"Amen Thompson",pos:"SG"},
  {name:"Ausar Thompson",pos:"SF"},{name:"Jalen Duren",pos:"C"},{name:"Shaedon Sharpe",pos:"SG"},
  {name:"Jerami Grant",pos:"PF"},{name:"Deandre Hunter",pos:"SF"},{name:"Cameron Johnson",pos:"SF"},
  {name:"Kyle Kuzma",pos:"PF"},{name:"Fred VanVleet",pos:"PG"},{name:"Austin Reaves",pos:"SG"},
  {name:"Marcus Smart",pos:"PG"},{name:"Derrick White",pos:"PG"}
];

const FA_90_RAW = [
  {name:"Brook Lopez",pos:"C"},{name:"Bobby Portis",pos:"PF"},{name:"Malcolm Brogdon",pos:"PG"},
  {name:"Terry Rozier",pos:"PG"},{name:"Jordan Clarkson",pos:"SG"},{name:"D'Angelo Russell",pos:"PG"},
  {name:"Buddy Hield",pos:"SG"},{name:"Josh Hart",pos:"SF"},{name:"Clint Capela",pos:"C"},
  {name:"Nikola Vucevic",pos:"C"},{name:"Jakob Poeltl",pos:"C"},{name:"Jonas Valanciunas",pos:"C"},
  {name:"John Collins",pos:"PF"},{name:"Collin Sexton",pos:"SG"},{name:"Bojan Bogdanovic",pos:"SF"},
  {name:"Bogdan Bogdanovic",pos:"SG"},{name:"Harrison Barnes",pos:"SF"},{name:"PJ Washington",pos:"PF"},
  {name:"Jaden McDaniels",pos:"SF"},{name:"Herb Jones",pos:"SF"},{name:"Trey Murphy III",pos:"SF"},
  {name:"Alex Caruso",pos:"SG"},{name:"Kentavious Caldwell-Pope",pos:"SG"},{name:"Bruce Brown",pos:"SG"},
  {name:"Spencer Dinwiddie",pos:"PG"},{name:"Caris LeVert",pos:"SG"},{name:"Dillon Brooks",pos:"SF"},
  {name:"Kyle Lowry",pos:"PG"},{name:"Lonzo Ball",pos:"PG"},{name:"Evan Fournier",pos:"SG"},
  {name:"Kevin Love",pos:"PF"},{name:"Al Horford",pos:"C"},{name:"Steven Adams",pos:"C"},
  {name:"Andre Drummond",pos:"C"},{name:"Jusuf Nurkic",pos:"C"},{name:"Kelly Olynyk",pos:"C"},
  {name:"Jae Crowder",pos:"PF"},{name:"Royce O'Neale",pos:"SF"},{name:"Reggie Jackson",pos:"PG"},
  {name:"Patty Mills",pos:"PG"},{name:"Tim Hardaway Jr.",pos:"SG"},{name:"Luke Kennard",pos:"SG"},
  {name:"Kyle Anderson",pos:"PF"},{name:"Daniel Gafford",pos:"C"},{name:"Mitchell Robinson",pos:"C"},
  {name:"Isaiah Hartenstein",pos:"C"},{name:"Naz Reid",pos:"C"},{name:"Gary Trent Jr.",pos:"SG"},
  {name:"Norman Powell",pos:"SG"},{name:"Ivica Zubac",pos:"C"},{name:"Seth Curry",pos:"SG"},
  {name:"Joe Ingles",pos:"SF"},{name:"Eric Gordon",pos:"SG"},{name:"Danny Green",pos:"SG"},
  {name:"Mike Conley",pos:"PG"},{name:"Russell Westbrook",pos:"PG"},{name:"Derrick Rose",pos:"PG"},
  {name:"Patrick Beverley",pos:"PG"},{name:"Cory Joseph",pos:"PG"},{name:"Gary Payton II",pos:"SG"},
  {name:"Tyus Jones",pos:"PG"},{name:"Monte Morris",pos:"PG"},{name:"Caleb Martin",pos:"SF"},
  {name:"Max Strus",pos:"SG"},{name:"Duncan Robinson",pos:"SF"},{name:"Josh Richardson",pos:"SG"},
  {name:"Cam Payne",pos:"PG"},{name:"Gordon Hayward",pos:"SF"},{name:"Robert Covington",pos:"PF"},
  {name:"P.J. Tucker",pos:"PF"},{name:"Davis Bertans",pos:"PF"},{name:"Joe Harris",pos:"SF"},
  {name:"Rui Hachimura",pos:"PF"},{name:"Christian Wood",pos:"C"},{name:"Mo Bamba",pos:"C"},
  {name:"Cedi Osman",pos:"SF"},{name:"Jae'Sean Tate",pos:"SF"},{name:"Cameron Reddish",pos:"SF"},
  {name:"Dennis Schroder",pos:"PG"},{name:"Alec Burks",pos:"SG"},{name:"Reggie Bullock",pos:"SF"},
  {name:"Dario Saric",pos:"PF"},{name:"Mason Plumlee",pos:"C"},{name:"Jeff Green",pos:"PF"},
  {name:"Thaddeus Young",pos:"PF"},{name:"Goran Dragic",pos:"PG"},{name:"Markieff Morris",pos:"PF"},
  {name:"Marcus Morris",pos:"PF"},{name:"Shake Milton",pos:"SG"},{name:"Delon Wright",pos:"PG"},
  {name:"Torrey Craig",pos:"SF"}
];

// Rookie pool (200-ish; dedup & avoid duplicates on release)
const ROOKIE_200_RAW = [
  {name:"Bilal Coulibaly",pos:"SF"},{name:"Jarace Walker",pos:"PF"},{name:"Cam Whitmore",pos:"SF"},
  {name:"Taylor Hendricks",pos:"PF"},{name:"Cason Wallace",pos:"SG"},{name:"Brandin Podziemski",pos:"SG"},
  {name:"Jaime Jaquez Jr.",pos:"SF"},{name:"Dereck Lively II",pos:"C"},{name:"Keyonte George",pos:"PG"},
  {name:"Gradey Dick",pos:"SG"},{name:"Ausar Thompson",pos:"SF"},{name:"Amen Thompson",pos:"SG"},
  {name:"Scoot Henderson",pos:"PG"},{name:"Brandon Miller",pos:"SF"},{name:"Jalen Duren",pos:"C"},
  {name:"Shaedon Sharpe",pos:"SG"},{name:"Tari Eason",pos:"PF"},{name:"Jeremy Sochan",pos:"PF"},
  {name:"Walker Kessler",pos:"C"},{name:"Bennedict Mathurin",pos:"SG"},{name:"Jaden Ivey",pos:"SG"},
  {name:"Keegan Murray",pos:"PF"},{name:"Jabari Smith Jr.",pos:"PF"},{name:"Josh Giddey",pos:"PG"},
  {name:"Derrick Rose",pos:"PG"},{name:"Blake Griffin",pos:"PF"},{name:"John Wall",pos:"PG"},
  {name:"Kobe Bryant",pos:"SG"},{name:"Michael Jordan",pos:"SG"},{name:"Tim Duncan",pos:"PF"},
  {name:"Dirk Nowitzki",pos:"PF"},{name:"Kevin Garnett",pos:"PF"},{name:"Steve Nash",pos:"PG"},
  {name:"Allen Iverson",pos:"SG"},{name:"Vince Carter",pos:"SG"},{name:"Dwyane Wade",pos:"SG"},
  {name:"Shaquille O'Neal",pos:"C"},{name:"Hakeem Olajuwon",pos:"C"},{name:"David Robinson",pos:"C"},
  {name:"Karl Malone",pos:"PF"},{name:"John Stockton",pos:"PG"},{name:"Charles Barkley",pos:"PF"},
  {name:"Magic Johnson",pos:"PG"},{name:"Larry Bird",pos:"SF"},{name:"Kareem Abdul-Jabbar",pos:"C"},
  {name:"Wilt Chamberlain",pos:"C"},{name:"Bill Russell",pos:"C"},
  {name:"Tracy McGrady",pos:"SG"},{name:"Carmelo Anthony",pos:"SF"},{name:"Chris Bosh",pos:"PF"},
  {name:"Manu Ginobili",pos:"SG"},{name:"Tony Parker",pos:"PG"},{name:"Chauncey Billups",pos:"PG"},
  {name:"Ben Wallace",pos:"C"},{name:"Rip Hamilton",pos:"SG"},{name:"Gilbert Arenas",pos:"PG"},
  {name:"Amar'e Stoudemire",pos:"PF"},{name:"Shawn Marion",pos:"PF"},
  {name:"Jason Kidd",pos:"PG"},{name:"Grant Hill",pos:"SF"},{name:"Penny Hardaway",pos:"PG"},
  {name:"Alonzo Mourning",pos:"C"},{name:"Dikembe Mutombo",pos:"C"},{name:"Yao Ming",pos:"C"},
  {name:"Pau Gasol",pos:"PF"},{name:"Marc Gasol",pos:"C"},{name:"Zach Randolph",pos:"PF"},
  {name:"Joe Johnson",pos:"SG"},{name:"Jamal Crawford",pos:"SG"},{name:"Andre Iguodala",pos:"SF"},
  {name:"Tyson Chandler",pos:"C"},{name:"Joakim Noah",pos:"C"},{name:"Kyle Korver",pos:"SG"},
  {name:"J.J. Redick",pos:"SG"},{name:"Mike Conley",pos:"PG"},{name:"DeMarcus Cousins",pos:"C"},
  // Fillers (still real NBA names)
  {name:"Kemba Walker",pos:"PG"},{name:"Gordon Hayward",pos:"SF"},{name:"Isaiah Thomas",pos:"PG"},
  {name:"Paul Millsap",pos:"PF"},{name:"David West",pos:"PF"},{name:"Brandon Roy",pos:"SG"},
  {name:"Rudy Gay",pos:"SF"},{name:"Shane Battier",pos:"SF"},{name:"Tayshaun Prince",pos:"SF"},
  {name:"Baron Davis",pos:"PG"},{name:"Deron Williams",pos:"PG"},{name:"Carlos Boozer",pos:"PF"},
  {name:"Peja Stojakovic",pos:"SF"},{name:"Clyde Drexler",pos:"SG"},{name:"Dominique Wilkins",pos:"SF"},
  {name:"James Worthy",pos:"SF"},{name:"Reggie Miller",pos:"SG"},{name:"Gary Payton",pos:"PG"},
  {name:"Shawn Kemp",pos:"PF"},{name:"Chris Webber",pos:"PF"}
];

function normalizeName(n){ return (n||"").trim(); }
function dedupListByName(list){
  const seen = new Set();
  const out = [];
  for(const x of list){
    const name = normalizeName(x.name);
    if(!name) continue;
    if(seen.has(name)) continue;
    seen.add(name);
    out.push({name, pos:x.pos});
  }
  return out;
}

function hashToId(str){
  let h = 2166136261;
  for(let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  h = (h>>>0) % 900000 + 1000;
  return h;
}

function makeActivePlayer(name, pos, tier){
  const id = hashToId(name);
  let ovr, age;
  if(tier==="core"){
    ovr = rand(86, 98);
    age = rand(23, 35);
  }else{
    ovr = rand(74, 85);
    age = rand(24, 36);
  }
  return {
    id, name, pos, ovr, age,
    pot: clamp(ovr + rand(3,12), ovr+3, 99),
    fatigue: 0,
    isCore:false, team:null, rookie:false
  };
}

const CORE_90 = dedupListByName(CORE_90_RAW);
const FA_90 = dedupListByName(FA_90_RAW);
const ROOKIE_POOL_200 = dedupListByName(ROOKIE_200_RAW);

function buildActivePool(){
  const seen = new Set();
  const ACTIVE = [];
  const add = (arr,tier)=>arr.forEach(x=>{
    const name = normalizeName(x.name);
    if(seen.has(name)) return;
    seen.add(name);
    ACTIVE.push(makeActivePlayer(name, x.pos, tier));
  });
  add(CORE_90, "core");
  add(FA_90, "fa");
  return ACTIVE;
}

const ACTIVE_POOL = buildActivePool();

/* =========================
   State / Persistence
   ========================= */

function defaultState(){
  return {
    version: 20,
    phase: "TEAM",
    teamLocked: false,
    userTeam: null,
    userTeamId: null,

    activePool: ACTIVE_POOL,
    rookiePool: ROOKIE_POOL_200,
    rookieCursor: 0,

    corePool: [],
    chosenCoreIds: [],

    league: null,
    freeAgents: [],

    season: 1,
    gamesPerTeam: DEFAULT_GAMES_PER_TEAM,
    dayIndex: 0,
    scheduleDays: [],

    offseason: {
      active:false,
      draftDone:false,
      rookies:[],
      fa: { active:false, order:[], round:1, maxRounds:OFFSEASON_FA_ROUNDS, turnIndex:0 }
    },

    training: { tp:0, lastDayAwarded:-1 },

    log: [],
    createdAt: Date.now(),
    updatedAt: Date.now(),
  };
}

let state = loadState() ?? defaultState();
syncState();
renderAll();

function saveState(){
  state.updatedAt = Date.now();
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}
function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return null;
    const parsed = JSON.parse(raw);
    if(!parsed || typeof parsed !== "object") return null;
    return parsed;
  }catch{ return null; }
}
function hardReset(){
  localStorage.removeItem(LS_KEY);
  state = defaultState();
  syncState();
  renderAll();
}

function buildCorePoolFromActive(active){
  const sorted = [...active].sort((a,b)=>b.ovr-a.ovr);
  return sorted.slice(0, 90).map(p=>({...p}));
}

function buildLeague(teamNames){
  return teamNames.map((name, id)=>({ id, name, w:0, l:0, roster:[] }));
}

function generateSeasonSchedule(teamIds, days){
  const schedule = [];
  for(let d=0; d<days; d++){
    const arr = [...teamIds];
    shuffle(arr);
    const matchups = [];
    for(let i=0;i<arr.length;i+=2){
      matchups.push([arr[i], arr[i+1]]);
    }
    schedule.push(matchups);
  }
  return schedule;
}
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j = rand(0,i);
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function syncState(){
  state.offseason = state.offseason || {active:false,draftDone:false,rookies:[],fa:{active:false,order:[],round:1,maxRounds:OFFSEASON_FA_ROUNDS,turnIndex:0}};
  state.training = state.training || { tp:0, lastDayAwarded:-1 };

  state.corePool = buildCorePoolFromActive(state.activePool || ACTIVE_POOL);

  if(state.league && state.league.length===30 && (!state.scheduleDays || state.scheduleDays.length===0)){
    state.scheduleDays = generateSeasonSchedule(state.league.map(t=>t.id), state.gamesPerTeam);
  }

  if(state.league && (!state.freeAgents || !Array.isArray(state.freeAgents))){
    state.freeAgents = buildFreeAgentPoolFromActive();
  }
  saveState();
}

/* =========================
   Modal
   ========================= */
function openModal({title, bodyHtml, actions}){
  el("modalTitle").textContent = title;
  el("modalBody").innerHTML = bodyHtml;
  const actionsBox = el("modalActions");
  actionsBox.innerHTML = "";
  actions.forEach(a=>{
    const btn = document.createElement("button");
    btn.textContent = a.label;
    btn.className = a.className || "ghost";
    btn.addEventListener("click", ()=>{ if(a.onClick) a.onClick(); });
    actionsBox.appendChild(btn);
  });
  el("modalBackdrop").style.display = "flex";
}
function closeModal(){ el("modalBackdrop").style.display = "none"; }
el("modalBackdrop").addEventListener("click",(e)=>{
  if(e.target === el("modalBackdrop")) closeModal();
});

/* =========================
   Salary / Value / Fatigue
   ========================= */

function playerSalary(p){
  let base = Math.round((p.ovr - 60) * 1.8);
  if(p.isCore) base += 8;
  if(p.rookie) base = Math.max(4, base - 6);
  return Math.max(4, base);
}
function teamSalary(team){
  return (team.roster||[]).reduce((s,p)=>s + playerSalary(p), 0);
}
function playerValue(p){
  let v = p.ovr;
  if(p.isCore) v += 22;
  return v;
}
function totalValue(players){ return players.reduce((s,p)=>s + playerValue(p), 0); }
function totalSalary(players){ return players.reduce((s,p)=>s + playerSalary(p), 0); }

function rosterFull(team){ return (team.roster?.length ?? 0) >= MAX_ROSTER; }

function recoverFatigueDaily(){
  if(!state.league) return;
  for(const t of state.league){
    for(const p of (t.roster||[])){
      p.fatigue = Math.max(0, (p.fatigue ?? 0) - 8);
    }
  }
}

/* =========================
   Pools (FA from active excluding rostered)
   ========================= */
function buildFreeAgentPoolFromActive(){
  const usedNames = new Set();
  if(state.league){
    for(const t of state.league){
      for(const p of (t.roster||[])) usedNames.add(p.name);
    }
  }
  return (state.activePool||ACTIVE_POOL)
    .filter(p=>!usedNames.has(p.name))
    .map(p=>({ ...p, isCore:false, team:null, rookie:false }));
}

function allUsedNamesSet(){
  const used = new Set();
  if(state.league){
    for(const t of state.league){
      for(const p of (t.roster||[])) used.add(p.name);
    }
  }
  if(state.freeAgents){
    for(const p of state.freeAgents) used.add(p.name);
  }
  return used;
}

/* =========================
   Standings / Sim
   ========================= */
function teamOVR(team){
  const roster = team.roster || [];
  if(roster.length===0) return 60;
  const values = roster.map(p=>p.ovr + (p.isCore ? 2 : 0));
  const avg = values.reduce((s,x)=>s+x,0)/values.length;
  return Math.round(avg);
}
function winProb(ovrA, ovrB){
  const diff = ovrA - ovrB;
  return 1/(1+Math.pow(10, -diff/15));
}
function simulateGame(teamA, teamB){
  const oA = teamOVR(teamA);
  const oB = teamOVR(teamB);
  const pA = winProb(oA, oB);
  const aWin = Math.random() < pA;

  const base = 98 + rand(-6, 10);
  const spread = clamp(Math.round((oA-oB)/2) + rand(-10,10), -22, 22);
  let scoreA = base + Math.max(0, spread) + rand(-8,8);
  let scoreB = base + Math.max(0, -spread) + rand(-8,8);
  if(scoreA===scoreB){ scoreA += rand(1,5); }

  if(aWin){
    if(scoreA<scoreB) [scoreA,scoreB]=[scoreB,scoreA];
    teamA.w++; teamB.l++;
  }else{
    if(scoreB<scoreA) [scoreA,scoreB]=[scoreB,scoreA];
    teamB.w++; teamA.l++;
  }
  return { aWin, scoreA, scoreB, oA, oB, pA };
}
function standingsSorted(){
  return [...state.league].sort((x,y)=>{
    const px = x.w/(x.w+x.l || 1);
    const py = y.w/(y.w+y.l || 1);
    if(py!==px) return py-px;
    return teamOVR(y)-teamOVR(x);
  });
}

/* =========================
   Training (TP, fatigue, POT)
   ========================= */
function awardTrainingPointsForDay(){
  if(!state.training) state.training = { tp:0, lastDayAwarded:-1 };
  if(state.training.lastDayAwarded === state.dayIndex) return;
  state.training.tp += 2;
  state.training.lastDayAwarded = state.dayIndex;
}

function trainPlayer(teamId, playerId){
  const team = state.league[teamId];
  const p = team.roster.find(x=>x.id===playerId);
  if(!p) return { ok:false, reason:"找不到球員" };
  if(!state.training) state.training = { tp:0, lastDayAwarded:-1 };
  if(state.training.tp < 2) return { ok:false, reason:"訓練點數不足（需要 2 TP）" };

  state.training.tp -= 2;

  const fatiguePenalty = (p.fatigue ?? 0) >= 60 ? 0.6 : ((p.fatigue ?? 0) >= 30 ? 0.85 : 1.0);
  const agePenalty = (p.age >= 32) ? 0.6 : (p.age >= 28 ? 0.85 : 1.0);
  const rookieBonus = p.rookie ? 1.15 : 1.0;

  let delta = 0;
  const roll = Math.random();
  if(roll < 0.15) delta = 2;
  else if(roll < 0.65) delta = 1;
  else delta = 0;

  const factor = fatiguePenalty * agePenalty * rookieBonus;
  const realGain = Math.random() < factor ? delta : Math.max(0, delta-1);

  const before = p.ovr;
  if(realGain > 0){
    p.ovr = Math.min(p.pot ?? 99, p.ovr + realGain);
    if(p.pot != null && p.pot < 99 && Math.random()<0.08) p.pot += 1;
    p.fatigue = Math.min(100, (p.fatigue ?? 0) + 20);
  }else{
    p.fatigue = Math.min(100, (p.fatigue ?? 0) + 10);
  }
  return { ok:true, gain: p.ovr - before, player:p };
}

/* =========================
   Free Agency (Pure manual)
   - Regular season: user can sign anytime (manual)
   - Offseason: turn-based; only user can sign when it's user's turn
   ========================= */
function signFreeAgent(teamId, playerId){
  const team = state.league[teamId];
  if(rosterFull(team)) return { ok:false, reason:"名單已滿" };

  const idx = state.freeAgents.findIndex(p=>p.id===playerId);
  if(idx<0) return { ok:false, reason:"找不到自由球員" };

  const p = state.freeAgents[idx];

  // Salary cap check
  if(teamSalary(team) + playerSalary(p) > CAP){
    return { ok:false, reason:`超過薪資上限：簽下後會是 ${teamSalary(team)+playerSalary(p)}/${CAP}` };
  }

  // Offseason turn-based restriction (only for user team)
  if(state.offseason?.active && state.offseason?.fa?.active){
    const fa = state.offseason.fa;
    const currentTeamId = fa.order[fa.turnIndex];
    if(teamId !== currentTeamId){
      return { ok:false, reason:"目前不是這支球隊的回合" };
    }
    if(teamId !== state.userTeamId){
      return { ok:false, reason:"休賽季只有你需要手動簽；AI 會自動跳過（純手動設定）" };
    }
  }

  state.freeAgents.splice(idx,1);
  team.roster.push({ ...p, isCore:false, team: team.name, rookie: !!p.rookie });

  return { ok:true, player:p };
}

function startOffseasonFreeAgency(rounds = OFFSEASON_FA_ROUNDS){
  const order = standingsSorted().slice().reverse().map(t=>t.id); // worst -> best
  state.offseason.fa = { active:true, order, round:1, maxRounds:rounds, turnIndex:0 };
  log(`休賽季自由市場開始：共 ${rounds} 輪，依上季戰績倒序輪流。`, "warnTxt");
  saveState();
  nextFATurn();
}

function advanceTurn(){
  const fa = state.offseason.fa;
  fa.turnIndex++;
  if(fa.turnIndex >= fa.order.length){
    fa.turnIndex = 0;
    fa.round++;
  }
  saveState();
  nextFATurn();
}

function nextFATurn(){
  const fa = state.offseason?.fa;
  if(!state.offseason?.active || !fa?.active) return;

  if(state.freeAgents.length === 0){
    fa.active = false;
    saveState();
    log("休賽季自由市場結束：自由球員用完。", "warnTxt");
    return;
  }
  if(fa.round > fa.maxRounds){
    fa.active = false;
    saveState();
    log(`休賽季自由市場結束：已完成 ${fa.maxRounds} 輪。`, "warnTxt");
    return;
  }

  const teamId = fa.order[fa.turnIndex];
  const team = state.league[teamId];

  // full roster or already cap-stuck (optional: still let them try) -> skip
  if(rosterFull(team)){
    advanceTurn();
    return;
  }

  // Only user signs (pure manual): AI always skip
  if(teamId !== state.userTeamId){
    advanceTurn();
    return;
  }

  // User turn: prompt choices
  openUserFAModal(team);
}

function openUserFAModal(team){
  const fa = state.offseason.fa;
  const mySalary = teamSalary(team);

  const show = [...state.freeAgents]
    .sort((a,b)=>b.ovr-a.ovr)
    .slice(0, 12);

  const rows = show.map(p=>{
    const sal = playerSalary(p);
    const can = !rosterFull(team) && (mySalary + sal <= CAP);
    return `
      <div class="row space" style="padding:8px;border-bottom:1px solid rgba(255,255,255,.06)">
        <div>
          <b>${escapeHtml(p.name)}</b>
          <div class="tiny muted">${escapeHtml(p.pos)} · OVR ${p.ovr} · 薪資 ${sal} · 你的薪資 ${mySalary}/${CAP}</div>
        </div>
        <button class="primary" data-sign="${p.id}" ${can ? "" : "disabled"}>簽下</button>
      </div>
    `;
  }).join("");

  openModal({
    title:`休賽季自由市場（第 ${fa.round}/${fa.maxRounds} 輪）你的回合：${team.name}`,
    bodyHtml: `
      <div class="tiny muted">你這回合可簽 1 人或 Skip。純手動：AI 不簽。</div>
      <div style="height:10px"></div>
      <div class="body" id="userFABox" style="padding:0">${rows || `<div class="tiny muted" style="padding:10px">沒有可簽球員</div>`}</div>
      <div class="tiny warnTxt" style="margin-top:10px">提示：若你被薪資卡住，先交易/釋出再回來。</div>
    `,
    actions:[
      {label:"Skip（跳過）", className:"ghost", onClick: ()=>{ closeModal(); advanceTurn(); renderAll(); }},
      {label:"打開自由市場頁", className:"blue", onClick: ()=>{ closeModal(); state.phase="FA"; saveState(); renderAll(); }}
    ]
  });

  setTimeout(()=>{
    const box = document.getElementById("userFABox");
    if(!box) return;
    box.querySelectorAll("button[data-sign]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const pid = Number(btn.getAttribute("data-sign"));
        const res = signFreeAgent(state.userTeamId, pid);
        if(res.ok){
          log(`休賽季FA：你簽下 ${res.player.name}（${res.player.pos} ${res.player.ovr}，薪資 ${playerSalary(res.player)}）`, "goodTxt");
        }else{
          log(`簽約失敗：${res.reason}`, "badTxt");
        }
        closeModal();
        advanceTurn();
        renderAll();
      });
    });
  },0);
}

/* =========================
   Draft (release 30 rookies/season)
   ========================= */
function genRookieBatch(count=30){
  const used = allUsedNamesSet();
  const out = [];
  let tries = 0;

  while(out.length < count && tries < 3000){
    tries++;
    if(state.rookieCursor >= state.rookiePool.length) break;

    const src = state.rookiePool[state.rookieCursor];
    state.rookieCursor++;

    if(!src) break;
    if(used.has(src.name)) continue;
    used.add(src.name);

    const ovr = rand(72, 80);
    out.push({
      id: 200000 + state.rookieCursor,
      name: src.name,
      pos: src.pos,
      ovr,
      age: rand(19, 22),
      pot: clamp(ovr + rand(6,18), ovr+6, 99),
      fatigue: 0,
      isCore:false,
      rookie:true,
      team:null
    });
  }
  return out;
}

function beginOffseasonIfNeeded(){
  if(state.offseason?.active) return;

  state.offseason.active = true;
  state.offseason.draftDone = false;
  state.offseason.rookies = genRookieBatch(30);
  state.offseason.fa = { active:false, order:[], round:1, maxRounds:OFFSEASON_FA_ROUNDS, turnIndex:0 };

  saveState();

  openModal({
    title:"休賽季開始",
    bodyHtml: `
      <div class="tiny muted">例行賽結束，進入休賽季：</div>
      <ul class="tiny muted" style="margin:8px 0 0 18px;line-height:1.6">
        <li>選秀（每隊 1 位，依排名倒序）</li>
        <li>自由市場（${OFFSEASON_FA_ROUNDS} 輪，倒序輪流；純手動：只有你簽）</li>
        <li>按「新賽季」開季</li>
      </ul>
    `,
    actions:[
      {label:"開始選秀", className:"primary", onClick: ()=>{ closeModal(); runDraft(); }},
      {label:"先看自由市場", className:"ghost", onClick: ()=>{ closeModal(); state.phase="FA"; saveState(); renderAll(); }}
    ]
  });
}

function runDraft(){
  if(!state.offseason.active || state.offseason.draftDone) {
    openModal({ title:"選秀狀態", bodyHtml:`<div class="tiny muted">選秀已完成或尚未進入休賽季。</div>`,
      actions:[{label:"OK", className:"primary", onClick: closeModal}] });
    return;
  }

  const order = standingsSorted().slice().reverse().map(t=>t.id); // worst first
  const myId = state.userTeamId;
  const rookies = state.offseason.rookies;

  const pickLoop = (idx)=>{
    if(idx>=order.length){
      state.offseason.draftDone = true;
      saveState();
      log(`選秀完成：本季釋出新秀 30 人（池子累積 ${state.rookiePool.length - state.rookieCursor} 人未釋出）。`, "warnTxt");
      openModal({
        title:"選秀完成",
        bodyHtml:`<div class="tiny muted">接著進入休賽季自由市場（輪流簽）。</div>`,
        actions:[
          {label:"開始休賽季自由市場", className:"primary", onClick: ()=>{ closeModal(); startOffseasonFreeAgency(OFFSEASON_FA_ROUNDS); renderAll(); }},
          {label:"稍後再說", className:"ghost", onClick: closeModal}
        ]
      });
      return;
    }

    const teamId = order[idx];
    const team = state.league[teamId];

    if(rosterFull(team)){
      pickLoop(idx+1);
      return;
    }
    if(rookies.length===0){
      state.offseason.draftDone = true;
      saveState();
      startOffseasonFreeAgency(OFFSEASON_FA_ROUNDS);
      renderAll();
      return;
    }

    if(teamId === myId){
      const options = rookies.slice(0,5);
      const rows = options.map(r=>{
        const sal = playerSalary(r);
        const can = teamSalary(team) + sal <= CAP;
        return `
          <div class="row space" style="padding:8px;border-bottom:1px solid rgba(255,255,255,.06)">
            <div>
              <b>${escapeHtml(r.name)}</b>
              <div class="tiny muted">${escapeHtml(r.pos)} · OVR ${r.ovr} · POT ${r.pot} · 薪資 ${sal}</div>
            </div>
            <button class="primary" data-pick="${r.id}" ${can ? "" : "disabled"}>選他</button>
          </div>
        `;
      }).join("");

      openModal({
        title:`你的選秀順位：${team.name}`,
        bodyHtml: `
          <div class="tiny muted">從前 5 新秀中選 1 位加入球隊（會檢查薪資上限）。</div>
          <div style="height:10px"></div>
          <div class="body" id="draftOptions" style="padding:0">${rows}</div>
        `,
        actions:[{label:"取消", className:"ghost", onClick: closeModal}]
      });

      setTimeout(()=>{
        const box = document.getElementById("draftOptions");
        if(!box) return;
        box.querySelectorAll("button[data-pick]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const pid = Number(btn.getAttribute("data-pick"));
            const rIdx = rookies.findIndex(x=>x.id===pid);
            if(rIdx<0) return;
            const rookie = rookies.splice(rIdx,1)[0];

            if(teamSalary(team) + playerSalary(rookie) > CAP){
              log(`選秀失敗：${rookie.name} 會讓你超 cap`, "badTxt");
              return;
            }

            team.roster.push({ ...rookie, team: team.name });
            saveState();
            closeModal();
            log(`你選到新秀：${rookie.name}（${rookie.pos} ${rookie.ovr}，薪資 ${playerSalary(rookie)}）`, "goodTxt");
            pickLoop(idx+1);
          });
        });
      },0);

    }else{
      // AI picks best fit by need and within cap (simple)
      const need = mostNeededPos(team);
      let pickIndex = rookies.findIndex(r=>r.pos===need && (teamSalary(team)+playerSalary(r) <= CAP));
      if(pickIndex<0) pickIndex = rookies.findIndex(r=>teamSalary(team)+playerSalary(r) <= CAP);
      if(pickIndex<0){ pickLoop(idx+1); return; } // cap-stuck
      const rookie = rookies.splice(pickIndex,1)[0];
      team.roster.push({ ...rookie, team: team.name });
      pickLoop(idx+1);
    }
  };

  pickLoop(0);
}

/* =========================
   Offseason / Season progression
   ========================= */
function simulateOneDay(){
  if(!state.league) return;

  // Training points + recovery always happen when you simulate a day (even if offseason stopped)
  awardTrainingPointsForDay();

  if(state.offseason?.active){
    // Offseason day simulation is not used in this version. Keep TP award & fatigue recovery.
    recoverFatigueDaily();
    saveState();
    log("目前是休賽季：請完成選秀/休賽季自由市場，然後按「新賽季」。", "warnTxt");
    return;
  }

  if(state.dayIndex >= state.gamesPerTeam){
    log("季末已到，進入休賽季。", "warnTxt");
    beginOffseasonIfNeeded();
    return;
  }

  const today = state.scheduleDays[state.dayIndex];
  const myId = state.userTeamId;
  let myGameSummary = null;

  for(const [aId,bId] of today){
    const A = state.league[aId];
    const B = state.league[bId];
    const res = simulateGame(A,B);

    if(aId===myId || bId===myId){
      const me = (aId===myId) ? A : B;
      const opp= (aId===myId) ? B : A;
      const meScore = (aId===myId) ? res.scoreA : res.scoreB;
      const oppScore= (aId===myId) ? res.scoreB : res.scoreA;
      const win = (meScore > oppScore);
      myGameSummary = `${me.name} ${meScore}–${oppScore} ${opp.name}（${win?"勝":"敗"}）`;
    }
  }

  recoverFatigueDaily();

  state.dayIndex++;
  if(myGameSummary) log(`Day ${state.dayIndex}: ${myGameSummary}`, "goodTxt");

  if(state.dayIndex >= state.gamesPerTeam){
    log("例行賽結束！進入休賽季。", "warnTxt");
    beginOffseasonIfNeeded();
  }

  saveState();
}

function startNewSeason(){
  if(!state.league) return;

  if(state.offseason?.active && !state.offseason.draftDone){
    openModal({
      title:"還沒完成選秀",
      bodyHtml:`<div class="tiny warnTxt"><b>建議先完成選秀</b>，不然你少一個補強機會。</div>`,
      actions:[
        {label:"現在選秀", className:"primary", onClick: ()=>{ closeModal(); runDraft(); }},
        {label:"直接開季", className:"warn", onClick: ()=>{ closeModal(); reallyStartNewSeason(); }}
      ]
    });
    return;
  }

  if(state.offseason?.active && state.offseason?.fa?.active){
    openModal({
      title:"休賽季自由市場還沒結束",
      bodyHtml:`<div class="tiny muted">目前還在輪流簽的過程。你可以先把回合跑完（或一直 Skip），再開季。</div>`,
      actions:[
        {label:"繼續跑回合", className:"primary", onClick: ()=>{ closeModal(); nextFATurn(); }},
        {label:"強制結束並開季", className:"warn", onClick: ()=>{ closeModal(); state.offseason.fa.active=false; reallyStartNewSeason(); }}
      ]
    });
    return;
  }

  reallyStartNewSeason();
}

function reallyStartNewSeason(){
  state.season += 1;
  state.dayIndex = 0;
  for(const t of state.league){ t.w=0; t.l=0; }
  state.scheduleDays = generateSeasonSchedule(state.league.map(t=>t.id), state.gamesPerTeam);

  state.offseason.active = false;
  state.offseason.draftDone = false;
  state.offseason.rookies = [];
  state.offseason.fa = { active:false, order:[], round:1, maxRounds:OFFSEASON_FA_ROUNDS, turnIndex:0 };

  log(`新賽季 S${state.season} 開始（每隊 ${state.gamesPerTeam} 場）。`, "warnTxt");
  saveState();
}

/* =========================
   Team building / Cores
   ========================= */
function aiPickCoresFromCorePool(corePool, usedIds, min=2, max=3){
  const need = rand(min, max);
  const picked = [];
  const pickedPos = new Set();

  const candidates = corePool.filter(p=>!usedIds.has(p.id)).sort((a,b)=>b.ovr-a.ovr);

  for(const p of candidates){
    if(picked.length>=need) break;
    if(!pickedPos.has(p.pos)){
      picked.push(p);
      pickedPos.add(p.pos);
      usedIds.add(p.id);
    }
  }
  if(picked.length < need){
    for(const p of candidates){
      if(picked.length>=need) break;
      if(usedIds.has(p.id)) continue;
      picked.push(p);
      usedIds.add(p.id);
    }
  }
  return picked;
}

function chooseTeam(teamName){
  state.userTeam = teamName;
  state.teamLocked = true;
  state.phase = "CORE";
  state.chosenCoreIds = [];
  state.corePool = buildCorePoolFromActive(state.activePool);
  saveState();
  renderAll();
}

function finalizeCoreAndLeague(){
  state.league = buildLeague(TEAMS);
  state.userTeamId = TEAMS.indexOf(state.userTeam);

  const chosen = new Set(state.chosenCoreIds);
  const myCores = state.corePool
    .filter(p=>chosen.has(p.id))
    .map(p=>({...p, isCore:true, team: state.userTeam}));

  // Salary cap check for cores (rare but possible)
  const myCap = myCores.reduce((s,p)=>s+playerSalary(p),0);
  if(myCap > CAP){
    openModal({
      title:"基石選太貴",
      bodyHtml:`<div class="tiny badTxt">你選的基石總薪資 ${myCap}/${CAP} 超過上限。</div>
                <div class="tiny muted" style="margin-top:8px">請改成 2 位基石或選比較便宜的組合。</div>`,
      actions:[{label:"OK", className:"primary", onClick: closeModal}]
    });
    return;
  }

  const usedIds = new Set(myCores.map(p=>p.id));
  state.league[state.userTeamId].roster = myCores;

  // AI cores: still pick 2-3 but will skip picks that break cap (simple)
  for(const team of state.league){
    if(team.id === state.userTeamId) continue;
    const picked = aiPickCoresFromCorePool(state.corePool, usedIds, 2, 3)
      .map(p=>({...p, isCore:true, team: team.name}));
    // ensure within cap: if not, drop the most expensive
    let roster = picked;
    while(roster.length>0 && roster.reduce((s,p)=>s+playerSalary(p),0) > CAP){
      roster.sort((a,b)=>playerSalary(b)-playerSalary(a));
      roster.shift();
    }
    team.roster = roster;
  }

  state.dayIndex = 0;
  state.scheduleDays = generateSeasonSchedule(state.league.map(t=>t.id), state.gamesPerTeam);

  state.freeAgents = buildFreeAgentPoolFromActive();

  state.offseason.active = false;
  state.offseason.draftDone = false;
  state.offseason.rookies = [];
  state.offseason.fa = { active:false, order:[], round:1, maxRounds:OFFSEASON_FA_ROUNDS, turnIndex:0 };

  log(`你已完成建隊：${state.userTeam}（基石 ${myCores.length} 位）。`, "goodTxt");
  log(`賽季 S${state.season} 開始（每隊 ${state.gamesPerTeam} 場）。`, "warnTxt");

  state.phase = "HUB";
  saveState();
  renderAll();
}

function toggleCorePick(playerId){
  const idx = state.chosenCoreIds.indexOf(playerId);
  if(idx >= 0){
    state.chosenCoreIds.splice(idx,1);
  }else{
    if(state.chosenCoreIds.length >= 3){
      openModal({
        title:"已達上限",
        bodyHtml:`<div class="tiny muted">你最多只能選 <b>3</b> 位基石。</div>`,
        actions:[{label:"OK", className:"primary", onClick: closeModal}]
      });
      return;
    }
    state.chosenCoreIds.push(playerId);
  }
  saveState();
  renderAll();
}

/* =========================
   Trade (multi-player, cap check)
   ========================= */
function tradeMultiplierMulti(givePlayers, getPlayers){
  const coreInvolved = [...givePlayers, ...getPlayers].some(p=>p.isCore);
  return coreInvolved ? 1.80 : 1.10;
}

function doTradeMulti(oppTeamId, giveIds, getIds){
  const myTeam = state.league[state.userTeamId];
  const oppTeam = state.league[oppTeamId];

  if(!giveIds.length || !getIds.length){
    return { ok:false, reason:"至少要選 1 位送出 + 1 位得到" };
  }

  const givePlayers = myTeam.roster.filter(p=>giveIds.includes(p.id));
  const getPlayers  = oppTeam.roster.filter(p=>getIds.includes(p.id));

  if(givePlayers.length !== giveIds.length) return { ok:false, reason:"你的送出清單有不存在的球員" };
  if(getPlayers.length  !== getIds.length)  return { ok:false, reason:"你的得到清單有不存在的球員" };

  // roster cap check
  const myAfterCount  = myTeam.roster.length  - givePlayers.length + getPlayers.length;
  const oppAfterCount = oppTeam.roster.length - getPlayers.length  + givePlayers.length;
  if(myAfterCount > MAX_ROSTER)  return { ok:false, reason:`交易後你隊會超過名單上限（${myAfterCount}/${MAX_ROSTER}）` };
  if(oppAfterCount > MAX_ROSTER) return { ok:false, reason:`交易後對手會超過名單上限（${oppAfterCount}/${MAX_ROSTER}）` };

  const giveV = totalValue(givePlayers);
  const getV  = totalValue(getPlayers);
  const mult  = tradeMultiplierMulti(givePlayers, getPlayers);

  // salary cap after trade
  const mySalaryAfter =
    teamSalary(myTeam) - totalSalary(givePlayers) + totalSalary(getPlayers);
  const oppSalaryAfter =
    teamSalary(oppTeam) - totalSalary(getPlayers) + totalSalary(givePlayers);

  if(mySalaryAfter > CAP) return { ok:false, reason:`交易後你隊薪資超過上限（${mySalaryAfter}/${CAP}）` };
  if(oppSalaryAfter > CAP) return { ok:false, reason:`交易後對手薪資超過上限（${oppSalaryAfter}/${CAP}）` };

  // value check
  if(giveV < getV * mult){
    return { ok:false, reason:`對方拒絕：你的總價值 ${giveV.toFixed(0)} 太低，需求 ≥ ${(getV*mult).toFixed(0)}` };
  }

  // execute
  myTeam.roster  = myTeam.roster.filter(p=>!giveIds.includes(p.id));
  oppTeam.roster = oppTeam.roster.filter(p=>!getIds.includes(p.id));

  for(const p of getPlayers) myTeam.roster.push({ ...p, team: myTeam.name });
  for(const p of givePlayers) oppTeam.roster.push({ ...p, team: oppTeam.name });

  saveState();
  return { ok:true, givePlayers, getPlayers, giveV, getV, mult, mySalaryAfter, oppSalaryAfter };
}

/* =========================
   Helpers
   ========================= */
function mostNeededPos(team){
  const count = {PG:0,SG:0,SF:0,PF:0,C:0};
  for(const p of (team.roster||[])) count[p.pos] = (count[p.pos]||0) + 1;
  let best="PG", min=Infinity;
  for(const k of Object.keys(count)){
    if(count[k] < min){ min=count[k]; best=k; }
  }
  return best;
}

function log(msg, cls=""){
  state.log.unshift({ t: Date.now(), msg, cls });
  if(state.log.length>220) state.log.length = 220;
}

/* =========================
   UI
   ========================= */
function setPhaseUI(){
  const phase = state.phase;
  el("screenTeam").style.display  = (phase==="TEAM") ? "" : "none";
  el("screenCore").style.display  = (phase==="CORE") ? "" : "none";
  el("screenHub").style.display   = (phase==="HUB")  ? "" : "none";
  el("screenTrade").style.display = (phase==="TRADE")? "" : "none";
  el("screenFA").style.display    = (phase==="FA")   ? "" : "none";

  let title="選隊", pill="Step 1/7";
  if(phase==="CORE"){ title="選基石"; pill="Step 2/7"; }
  if(phase==="HUB"){ title="主介面"; pill="Step 3/7"; }
  if(phase==="TRADE"){ title="交易"; pill="Step 4/7"; }
  if(phase==="FA"){ title="自由市場"; pill="Step 5/7"; }

  el("phaseTitle").textContent = title;
  el("phasePill").textContent = pill;

  el("hdrStatus").textContent = (state.teamLocked && state.userTeam) ? `已選隊：${state.userTeam}` : "未選隊";

  const myTeam = (state.league && state.userTeamId!=null) ? state.league[state.userTeamId] : null;

  el("kpiSeason").textContent = state.league ? `S${state.season}` : "-";
  el("kpiDay").textContent = state.league
    ? (state.offseason?.active ? `休賽季` : `Day ${Math.min(state.dayIndex+1, state.gamesPerTeam)}/${state.gamesPerTeam}`)
    : "-";
  el("kpiW").textContent = myTeam ? myTeam.w : 0;
  el("kpiL").textContent = myTeam ? myTeam.l : 0;

  el("kpiSalary").textContent = myTeam ? `${teamSalary(myTeam)}/${CAP}` : "-";
  el("kpiTP").textContent = `${state.training?.tp ?? 0}`;

  el("seasonHint").textContent = state.league
    ? (state.offseason?.active ? `休賽季：選秀/輪流簽` : `每隊 ${state.gamesPerTeam} 場`)
    : "尚未建立聯盟";
}

function renderLog(){
  const box = el("log");
  box.innerHTML = state.log.slice(0,90).map(x=>{
    const time = new Date(x.t).toLocaleTimeString("zh-TW",{hour:"2-digit",minute:"2-digit"});
    return `<p class="${x.cls}"><span class="muted">[${time}]</span> ${escapeHtml(x.msg)}</p>`;
  }).join("") || `<p class="muted">（還沒有事件）</p>`;
}

function renderTeamScreen(){
  const grid = el("teamGrid");
  grid.innerHTML = "";
  TEAMS.forEach(t=>{
    const btn = document.createElement("button");
    btn.className = "teamBtn";
    btn.innerHTML = `<div><b>${escapeHtml(t)}</b><div><small>點選後鎖定</small></div></div><span class="pill">選擇</span>`;
    btn.addEventListener("click", ()=>{
      if(state.teamLocked) return;
      openModal({
        title: "確認選隊",
        bodyHtml: `<div class="tiny muted">你確定要選擇：</div>
                  <div style="margin-top:6px;font-size:16px"><b>${escapeHtml(t)}</b></div>
                  <div class="tiny warnTxt" style="margin-top:10px">選完後無法更換（除非 Reset）。</div>`,
        actions: [
          {label:"取消", className:"ghost", onClick: closeModal},
          {label:"確定鎖定", className:"primary", onClick: ()=>{ closeModal(); chooseTeam(t); }}
        ]
      });
    });
    grid.appendChild(btn);
  });
}

function renderCoreScreen(){
  const grid = el("coreGrid");
  grid.innerHTML = "";
  const selected = new Set(state.chosenCoreIds);
  el("coreCountTag").textContent = `已選 ${state.chosenCoreIds.length}`;
  el("btnFinishCore").disabled = (state.chosenCoreIds.length < 2);

  state.corePool.forEach(p=>{
    const isSelected = selected.has(p.id);
    const btn = document.createElement("button");
    btn.className = "teamBtn";
    btn.style.border = isSelected ? "1px solid rgba(34,197,94,.7)" : "1px solid var(--stroke)";
    btn.style.background = isSelected ? "rgba(34,197,94,.12)" : "var(--panel)";
    btn.innerHTML = `
      <div>
        <b>${escapeHtml(p.name)} ${isSelected ? `<span class="star">★</span>` : ""}</b>
        <div><small>${escapeHtml(p.pos)} · OVR ${p.ovr} · 年齡 ${p.age} · 薪資 ${playerSalary({...p,isCore:true})}</small></div>
      </div>
      <span class="pill">${isSelected ? "已選" : "選取"}</span>
    `;
    btn.addEventListener("click", ()=>toggleCorePick(p.id));
    grid.appendChild(btn);
  });

  el("btnFinishCore").onclick = ()=>{
    if(state.chosenCoreIds.length < 2) return;
    finalizeCoreAndLeague();
  };
}

function renderHubBanner(){
  const hubBanner = el("hubBanner");
  if(!state.offseason?.active){
    hubBanner.style.display = "none";
    hubBanner.innerHTML = "";
    return;
  }
  const fa = state.offseason.fa;
  const parts = [];
  parts.push(`<div class="banner"><div class="tiny warnTxt"><b>休賽季進行中</b></div>`);
  parts.push(`<div class="tiny muted" style="margin-top:6px">選秀：${state.offseason.draftDone ? "已完成" : "未完成"}｜自由市場輪流簽：${fa?.active ? "進行中" : "未開始/已結束"}</div>`);
  if(fa?.active){
    const currentTeamId = fa.order[fa.turnIndex];
    parts.push(`<div class="tiny muted" style="margin-top:6px">目前回合：第 ${fa.round}/${fa.maxRounds} 輪 · 輪到 <b>${escapeHtml(state.league[currentTeamId].name)}</b></div>`);
    if(currentTeamId === state.userTeamId){
      parts.push(`<div class="tiny warnTxt" style="margin-top:6px">輪到你了：可以去自由市場簽 1 人，或在彈窗按 Skip。</div>`);
    }
  }
  parts.push(`</div>`);
  hubBanner.style.display = "";
  hubBanner.innerHTML = parts.join("");
}

function renderHubScreen(){
  const myTeam = state.league?.[state.userTeamId];
  el("hubTeamPill").textContent = state.userTeam ? `你的隊伍：${state.userTeam}` : "-";
  el("rosterCapPill").textContent = myTeam ? `名單：${myTeam.roster.length}/${MAX_ROSTER}｜薪資：${teamSalary(myTeam)}/${CAP}` : "-";

  renderHubBanner();

  el("btnGoTrade").onclick = ()=>{ state.phase="TRADE"; saveState(); renderAll(); };
  el("btnGoFA").onclick = ()=>{ state.phase="FA"; saveState(); renderAll(); };
  el("btnGoTrain").onclick = ()=> openTrainingModal();

  const table = el("rosterTable");
  const roster = myTeam?.roster ?? [];

  if(roster.length===0){
    table.innerHTML = `<tr><td class="muted">目前名單是空的。</td></tr>`;
  }else{
    const rows = [...roster]
      .sort((a,b)=> (b.isCore-a.isCore) || (b.ovr-a.ovr))
      .map(p=>`
        <tr>
          <td>
            <button class="linkBtn" data-pid="${p.id}">${escapeHtml(p.name)}</button>
            ${p.isCore ? `<span class="star">★</span>` : ""}
            ${p.rookie ? `<span class="pill">R</span>` : ""}
            <div class="tiny muted">${escapeHtml(p.pos)} · OVR ${p.ovr} · POT ${p.pot ?? 99} · 疲勞 ${p.fatigue ?? 0}</div>
          </td>
          <td>${p.age}</td>
          <td>${playerSalary(p)}</td>
        </tr>
      `).join("");
    table.innerHTML = `
      <thead><tr><th>球員</th><th>年齡</th><th>薪資</th></tr></thead>
      <tbody>${rows}</tbody>
    `;
    table.querySelectorAll("button[data-pid]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const pid = Number(btn.getAttribute("data-pid"));
        const player = roster.find(x=>x.id===pid);
        if(player) showPlayerDetail(player);
      });
    });
  }

  renderStandings();
  renderLeagueCores();
}

function renderStandings(){
  const tbl = el("standingsTable");
  const sorted = standingsSorted();
  const myId = state.userTeamId;
  const rows = sorted.map((t,i)=>{
    const gp = t.w+t.l;
    const pct = gp? (t.w/gp) : 0;
    const ovr = teamOVR(t);
    const highlight = (t.id===myId) ? `style="background:rgba(34,197,94,.08)"` : "";
    return `
      <tr ${highlight}>
        <td>${i+1}</td>
        <td>${escapeHtml(t.name)}</td>
        <td>${t.w}-${t.l}</td>
        <td>${pct.toFixed(3)}</td>
        <td>${ovr}</td>
      </tr>
    `;
  }).join("");
  tbl.innerHTML = `
    <thead><tr><th>#</th><th>球隊</th><th>戰績</th><th>勝率</th><th>隊伍OVR</th></tr></thead>
    <tbody>${rows}</tbody>
  `;
}

function renderLeagueCores(){
  const list = el("leagueCoresList");
  list.innerHTML = state.league.map(team=>{
    const cores = (team.roster||[])
      .filter(p=>p.isCore)
      .map(p=>`${escapeHtml(p.name)} <span class="muted tiny">(${escapeHtml(p.pos)} ${p.ovr})</span> <span class="star">★</span>`)
      .join("<br/>");
    return `
      <div class="item">
        <b>${escapeHtml(team.name)}</b>
        <div class="tiny" style="margin-top:6px">${cores || `<span class="muted">（空）</span>`}</div>
      </div>
    `;
  }).join("");
}

/* ===== Training Modal ===== */
function openTrainingModal(){
  const team = state.league[state.userTeamId];
  const tp = state.training?.tp ?? 0;

  const roster = [...team.roster].sort((a,b)=> (b.rookie-a.rookie) || (a.age-b.age) || (b.ovr-a.ovr));

  const rows = roster.map(p=>`
    <div class="row space" style="padding:8px;border-bottom:1px solid rgba(255,255,255,.06)">
      <div>
        <b>${escapeHtml(p.name)}</b> ${p.isCore?`<span class="star">★</span>`:""} ${p.rookie?`<span class="pill">R</span>`:""}
        <div class="tiny muted">${escapeHtml(p.pos)} · OVR ${p.ovr} / POT ${p.pot ?? 99} · 疲勞 ${p.fatigue ?? 0} · 薪資 ${playerSalary(p)}</div>
      </div>
      <button class="primary" data-train="${p.id}" ${tp>=2 ? "" : "disabled"}>訓練（-2TP）</button>
    </div>
  `).join("");

  openModal({
    title:`訓練中心（TP：${tp}）`,
    bodyHtml: `
      <div class="tiny muted">每次訓練消耗 <b>2 TP</b>。疲勞越高、年齡越大越難成長；新秀更容易進步。</div>
      <div style="height:10px"></div>
      <div class="body" id="trainBox" style="padding:0">${rows}</div>
    `,
    actions:[{label:"關閉", className:"ghost", onClick: closeModal}]
  });

  setTimeout(()=>{
    const box = document.getElementById("trainBox");
    if(!box) return;
    box.querySelectorAll("button[data-train]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const pid = Number(btn.getAttribute("data-train"));
        const res = trainPlayer(state.userTeamId, pid);
        if(!res.ok){
          openModal({ title:"訓練失敗", bodyHtml:`<div class="tiny badTxt">${escapeHtml(res.reason)}</div>`, actions:[{label:"OK", className:"primary", onClick: closeModal}]});
          return;
        }
        log(`訓練：${res.player.name} ${res.gain>0?`提升 +${res.gain} OVR`:"沒有提升"}（疲勞 ${res.player.fatigue}）`, res.gain>0?"goodTxt":"muted");
        saveState();
        closeModal();
        renderAll();
        openTrainingModal();
      });
    });
  },0);
}

/* ===== Trade Screen ===== */
function renderTradeScreen(){
  const myTeam = state.league[state.userTeamId];
  el("tradeHintPill").textContent = `你的隊伍：${myTeam.name}｜薪資 ${teamSalary(myTeam)}/${CAP}`;

  const oppSel = el("oppSelect");
  oppSel.innerHTML = "";
  state.league.forEach(t=>{
    if(t.id===state.userTeamId) return;
    const opt = document.createElement("option");
    opt.value = t.id;
    opt.textContent = t.name;
    oppSel.appendChild(opt);
  });

  setupTradeForOpponent(Number(oppSel.value));
  oppSel.onchange = ()=>setupTradeForOpponent(Number(oppSel.value));
  el("btnRefreshTrade").onclick = ()=>setupTradeForOpponent(Number(oppSel.value));

  el("btnBackHubFromTrade").onclick = ()=>{ state.phase="HUB"; saveState(); renderAll(); };

  el("btnTrade").onclick = ()=>{
    const oppTeamId = Number(oppSel.value);
    const giveIds = getCheckedIds("giveList");
    const getIds  = getCheckedIds("getList");

    const res = doTradeMulti(oppTeamId, giveIds, getIds);
    if(!res.ok){
      openModal({ title:"交易失敗", bodyHtml:`<div class="tiny badTxt">${escapeHtml(res.reason)}</div>`, actions:[{label:"OK", className:"primary", onClick: closeModal}]});
      return;
    }

    const giveList = res.givePlayers.map(p=>`${p.isCore?"★ ":""}${escapeHtml(p.name)} <span class="muted tiny">(${p.pos} ${p.ovr} · 薪資 ${playerSalary(p)})</span>`).join("<br>");
    const getList  = res.getPlayers.map(p=>`${p.isCore?"★ ":""}${escapeHtml(p.name)} <span class="muted tiny">(${p.pos} ${p.ovr} · 薪資 ${playerSalary(p)})</span>`).join("<br>");

    log(`交易成功：送出 ${res.givePlayers.length} 人，得到 ${res.getPlayers.length} 人。`, "goodTxt");

    openModal({
      title:"交易成功",
      bodyHtml: `
        <div class="tiny goodTxt"><b>完成交易！</b></div>
        <div style="height:8px"></div>
        <div class="tiny muted">你送出（總價值 ${res.giveV.toFixed(0)}）：</div>
        <div class="tiny" style="line-height:1.6">${giveList}</div>
        <div style="height:8px"></div>
        <div class="tiny muted">你得到（總價值 ${res.getV.toFixed(0)}）：</div>
        <div class="tiny" style="line-height:1.6">${getList}</div>
        <div style="height:10px"></div>
        <div class="tiny muted">倍率：${res.mult.toFixed(2)}（牽涉基石更難）</div>
        <div class="tiny muted" style="margin-top:6px">你的薪資：${res.mySalaryAfter}/${CAP}</div>
      `,
      actions:[{label:"OK", className:"primary", onClick: ()=>{ closeModal(); renderAll(); }}]
    });
  };
}

function getCheckedIds(listId){
  const list = document.getElementById(listId);
  const ids = [];
  list.querySelectorAll("input[type=checkbox]:checked").forEach(cb=>{
    ids.push(Number(cb.value));
  });
  return ids;
}

function setupTradeForOpponent(oppTeamId){
  const myTeam = state.league[state.userTeamId];
  const oppTeam = state.league[oppTeamId];

  const myRoster = [...myTeam.roster].sort((a,b)=>(b.isCore-a.isCore)||(b.ovr-a.ovr));
  const oppRoster= [...oppTeam.roster].sort((a,b)=>(b.isCore-a.isCore)||(b.ovr-a.ovr));

  const giveBox = el("giveList");
  const getBox  = el("getList");

  giveBox.innerHTML = myRoster.map(p=>`
    <div class="checkRow">
      <label>
        <input type="checkbox" value="${p.id}">
        <div>
          <b>${escapeHtml(p.name)}</b> ${p.isCore?`<span class="star">★</span>`:""} ${p.rookie?`<span class="pill">R</span>`:""}
          <div class="tiny muted">${escapeHtml(p.pos)} · OVR ${p.ovr} · 價值 ${playerValue(p)} · 薪資 ${playerSalary(p)}</div>
        </div>
      </label>
      <button class="linkBtn nowrap" data-detail="${p.id}">詳情</button>
    </div>
  `).join("") || `<div class="item muted">（空）</div>`;

  getBox.innerHTML = oppRoster.map(p=>`
    <div class="checkRow">
      <label>
        <input type="checkbox" value="${p.id}">
        <div>
          <b>${escapeHtml(p.name)}</b> ${p.isCore?`<span class="star">★</span>`:""} ${p.rookie?`<span class="pill">R</span>`:""}
          <div class="tiny muted">${escapeHtml(p.pos)} · OVR ${p.ovr} · 價值 ${playerValue(p)} · 薪資 ${playerSalary(p)}</div>
        </div>
      </label>
      <button class="linkBtn nowrap" data-opdetail="${p.id}">詳情</button>
    </div>
  `).join("") || `<div class="item muted">（空）</div>`;

  giveBox.querySelectorAll("button[data-detail]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const pid = Number(btn.getAttribute("data-detail"));
      const p = myTeam.roster.find(x=>x.id===pid);
      if(p) showPlayerDetail(p);
    });
  });
  getBox.querySelectorAll("button[data-opdetail]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const pid = Number(btn.getAttribute("data-opdetail"));
      const p = oppTeam.roster.find(x=>x.id===pid);
      if(p) showPlayerDetail(p);
    });
  });

  const updateSummary = ()=>{
    const giveIds = getCheckedIds("giveList");
    const getIds  = getCheckedIds("getList");

    const givePlayers = myTeam.roster.filter(p=>giveIds.includes(p.id));
    const getPlayers  = oppTeam.roster.filter(p=>getIds.includes(p.id));

    const giveV = totalValue(givePlayers);
    const getV = totalValue(getPlayers);
    const mult = tradeMultiplierMulti(givePlayers, getPlayers);

    el("giveSummary").textContent = `已選 ${givePlayers.length}｜價值 ${giveV.toFixed(0)}｜薪資 ${totalSalary(givePlayers)}`;
    el("getSummary").textContent  = `已選 ${getPlayers.length}｜價值 ${getV.toFixed(0)}｜薪資 ${totalSalary(getPlayers)}`;

    const myAfterCount  = myTeam.roster.length  - givePlayers.length + getPlayers.length;
    const oppAfterCount = oppTeam.roster.length - getPlayers.length  + givePlayers.length;

    const mySalaryAfter = teamSalary(myTeam) - totalSalary(givePlayers) + totalSalary(getPlayers);
    const oppSalaryAfter= teamSalary(oppTeam)- totalSalary(getPlayers)  + totalSalary(givePlayers);

    el("tradeRuleInfo").innerHTML =
      `AI 規則：你的總價值 ≥ 對手總價值 × <b>${mult.toFixed(2)}</b>（牽涉基石更難）`;

    el("tradeAfterInfo").innerHTML =
      `交易後（預估）：你隊名單 ${myAfterCount}/${MAX_ROSTER} · 薪資 ${mySalaryAfter}/${CAP} ｜ ` +
      `對手名單 ${oppAfterCount}/${MAX_ROSTER} · 薪資 ${oppSalaryAfter}/${CAP}`;
  };

  giveBox.querySelectorAll("input[type=checkbox]").forEach(cb=>cb.addEventListener("change", updateSummary));
  getBox.querySelectorAll("input[type=checkbox]").forEach(cb=>cb.addEventListener("change", updateSummary));
  updateSummary();
}

/* ===== FA Screen ===== */
function renderFAScreen(){
  const myTeam = state.league[state.userTeamId];

  el("btnBackHubFromFA").onclick = ()=>{ state.phase="HUB"; saveState(); renderAll(); };

  const faBanner = el("faBanner");
  const fa = state.offseason?.fa;
  if(state.offseason?.active && fa?.active){
    const currentTeamId = fa.order[fa.turnIndex];
    const isMyTurn = (currentTeamId === state.userTeamId);
    faBanner.style.display = "";
    faBanner.innerHTML = `
      <div class="banner">
        <div class="tiny warnTxt"><b>休賽季輪流簽</b></div>
        <div class="tiny muted" style="margin-top:6px">
          第 ${fa.round}/${fa.maxRounds} 輪 · 目前回合：<b>${escapeHtml(state.league[currentTeamId].name)}</b>
        </div>
        <div class="tiny ${isMyTurn ? "warnTxt" : "muted"}" style="margin-top:6px">
          ${isMyTurn ? "輪到你：你可以在這頁簽 1 人（或等彈窗）。" : "不是你的回合：你在這頁不能簽人。"}
        </div>
        ${isMyTurn ? `<div style="margin-top:8px"><button class="ghost" id="btnSkipTurn">Skip（跳過回合）</button></div>` : ""}
      </div>
    `;
    if(isMyTurn){
      setTimeout(()=>{
        const btn = document.getElementById("btnSkipTurn");
        if(btn) btn.onclick = ()=>{ advanceTurn(); renderAll(); };
      },0);
    }
  }else{
    faBanner.style.display = "none";
    faBanner.innerHTML = "";
  }

  const searchBox = el("faSearch");
  const posFilter = el("faPosFilter");
  const sortSel   = el("faSort");

  const renderFALists = ()=>{
    let list = [...state.freeAgents];

    const q = (searchBox.value||"").trim().toLowerCase();
    if(q) list = list.filter(p=>p.name.toLowerCase().includes(q));

    const pos = posFilter.value;
    if(pos) list = list.filter(p=>p.pos===pos);

    const sort = sortSel.value;
    if(sort==="ovr") list.sort((a,b)=>b.ovr-a.ovr);
    if(sort==="age") list.sort((a,b)=>a.age-b.age);
    if(sort==="name") list.sort((a,b)=>a.name.localeCompare(b.name));

    const show = list.slice(0,60);
    const box = el("faList");

    const isOffTurn = (state.offseason?.active && state.offseason?.fa?.active && state.offseason.fa.order[state.offseason.fa.turnIndex] !== state.userTeamId);
    const canSignBase = !rosterFull(myTeam) && !isOffTurn;

    box.innerHTML = show.map(p=>{
      const sal = playerSalary(p);
      const capOk = teamSalary(myTeam) + sal <= CAP;
      const can = canSignBase && capOk;
      return `
        <div class="item">
          <div class="row space">
            <div>
              <button class="linkBtn" data-faid="${p.id}">${escapeHtml(p.name)}</button>
              <div class="tiny muted">${escapeHtml(p.pos)} · OVR ${p.ovr} · 年齡 ${p.age} · 薪資 ${sal}</div>
            </div>
            <button class="primary" data-sign="${p.id}" ${can ? "" : "disabled"}>簽下</button>
          </div>
        </div>
      `;
    }).join("") || `<div class="item muted">（沒有符合條件的自由球員）</div>`;

    box.querySelectorAll("button[data-faid]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const pid = Number(btn.getAttribute("data-faid"));
        const p = state.freeAgents.find(x=>x.id===pid);
        if(p) showPlayerDetail(p);
      });
    });
    box.querySelectorAll("button[data-sign]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const pid = Number(btn.getAttribute("data-sign"));
        const res = signFreeAgent(state.userTeamId, pid);
        if(!res.ok){
          openModal({ title:"簽約失敗", bodyHtml:`<div class="tiny badTxt">${escapeHtml(res.reason)}</div>`, actions:[{label:"OK", className:"primary", onClick: closeModal}]});
          return;
        }
        log(`你簽下：${res.player.name}（${res.player.pos} ${res.player.ovr}，薪資 ${playerSalary(res.player)}）`, "goodTxt");

        // if offseason turn-based, signing consumes the turn
        if(state.offseason?.active && state.offseason?.fa?.active){
          closeModal();
          advanceTurn();
        }

        saveState();
        renderAll();
      });
    });

    const myBox = el("faMyRoster");
    const roster = [...myTeam.roster].sort((a,b)=>(b.isCore-a.isCore)||(b.ovr-a.ovr));
    myBox.innerHTML = roster.map(p=>`
      <div class="item">
        <button class="linkBtn" data-mepid="${p.id}">${escapeHtml(p.name)}</button>
        ${p.isCore?`<span class="star">★</span>`:""}
        ${p.rookie?`<span class="pill">R</span>`:""}
        <div class="tiny muted">${escapeHtml(p.pos)} · OVR ${p.ovr} · 薪資 ${playerSalary(p)}</div>
      </div>
    `).join("") || `<div class="item muted">（空）</div>`;

    myBox.querySelectorAll("button[data-mepid]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const pid = Number(btn.getAttribute("data-mepid"));
        const p = myTeam.roster.find(x=>x.id===pid);
        if(p) showPlayerDetail(p);
      });
    });

    el("faHintPill").textContent = `自由球員：${state.freeAgents.length}｜你的名單：${myTeam.roster.length}/${MAX_ROSTER}｜薪資：${teamSalary(myTeam)}/${CAP}`;
  };

  searchBox.oninput = renderFALists;
  posFilter.onchange = renderFALists;
  sortSel.onchange = renderFALists;

  renderFALists();
}

/* ===== Player detail ===== */
function showPlayerDetail(p){
  openModal({
    title: "球員詳細資訊",
    bodyHtml: `
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <div style="font-size:18px"><b>${escapeHtml(p.name)}</b>
            ${p.isCore?` <span class="star">★ 基石</span>`:""}
            ${p.rookie?` <span class="pill">R 新秀</span>`:""}
          </div>
          <div class="tiny muted" style="margin-top:4px">${escapeHtml(p.team ?? "自由球員")}</div>
        </div>
        <span class="pill">OVR ${p.ovr}</span>
      </div>
      <div style="height:10px"></div>
      <div class="row">
        <span class="pill">位置：${escapeHtml(p.pos)}</span>
        <span class="pill">年齡：${p.age}</span>
        <span class="pill">POT：${p.pot ?? 99}</span>
        <span class="pill">疲勞：${p.fatigue ?? 0}</span>
        <span class="pill">薪資：${playerSalary(p)}</span>
        <span class="pill">價值：${playerValue(p).toFixed(0)}${p.isCore?"（基石加權）":""}</span>
      </div>
      <div style="height:10px"></div>
      <div class="tiny muted">
        自由市場：純手動。<br/>
        休賽季：依上季戰績倒序輪流簽（你的回合才可簽）。<br/>
        交易：可多換一 / 一換多，且檢查薪資上限。
      </div>
    `,
    actions:[{label:"關閉", className:"primary", onClick: closeModal}]
  });
}

/* =========================
   Controls
   ========================= */
el("btnSim1").addEventListener("click", ()=>{
  if(!state.league){ log("請先完成選隊與選基石。", "warnTxt"); renderAll(); return; }
  simulateOneDay();
  renderAll();
});
el("btnSim7").addEventListener("click", ()=>{
  if(!state.league){ log("請先完成選隊與選基石。", "warnTxt"); renderAll(); return; }
  for(let i=0;i<7;i++){
    if(state.offseason?.active) break;
    simulateOneDay();
  }
  renderAll();
});
el("btnSimAll").addEventListener("click", ()=>{
  if(!state.league){ log("請先完成選隊與選基石。", "warnTxt"); renderAll(); return; }
  while(!state.offseason?.active){
    simulateOneDay();
    if(state.dayIndex>=state.gamesPerTeam) break;
  }
  renderAll();
});
el("btnNewSeason").addEventListener("click", ()=>{
  if(!state.league){ log("請先完成選隊與選基石。", "warnTxt"); renderAll(); return; }
  openModal({
    title:"開始新賽季",
    bodyHtml:`<div class="tiny muted">會把全聯盟戰績清零，重新生成賽程。</div>
             <div class="tiny warnTxt" style="margin-top:8px">（球員、交易、簽約、新秀都保留）</div>`,
    actions:[
      {label:"取消", className:"ghost", onClick: closeModal},
      {label:"開始", className:"primary", onClick: ()=>{ closeModal(); startNewSeason(); renderAll(); }}
    ]
  });
});
el("btnClearLog").addEventListener("click", ()=>{
  state.log = [];
  saveState();
  renderAll();
});

/* ===== Reset / Export / Import ===== */
el("btnReset").addEventListener("click", ()=>{
  openModal({
    title: "Reset（清空全部進度）",
    bodyHtml: `
      <div class="tiny warnTxt"><b>注意：</b>Reset 會清空所有進度，回到選隊畫面。</div>
      <div class="tiny muted" style="margin-top:10px">請在下方輸入 <b>RESET</b>（全大寫）確認。</div>
      <div style="height:10px"></div>
      <input id="resetInput" placeholder="輸入 RESET" />
    `,
    actions:[
      {label:"取消", className:"ghost", onClick: closeModal},
      {label:"確定 Reset", className:"danger", onClick: ()=>{
        const val = (document.getElementById("resetInput")?.value ?? "").trim();
        if(val !== "RESET"){
          openModal({
            title:"輸入錯誤",
            bodyHtml:`<div class="tiny muted">你輸入的是：<b>${escapeHtml(val||"(空)")}</b></div>
                      <div class="tiny warnTxt" style="margin-top:8px">必須完整輸入 <b>RESET</b> 才能清空。</div>`,
            actions:[{label:"OK", className:"primary", onClick: closeModal}]
          });
          return;
        }
        closeModal();
        hardReset();
      }}
    ]
  });
});

el("btnExport").addEventListener("click", ()=>{
  const json = JSON.stringify(state, null, 2);
  const tryCopy = async ()=>{
    try{
      await navigator.clipboard.writeText(json);
      openModal({
        title:"Export 成功",
        bodyHtml:`<div class="tiny muted">已把存檔 JSON 複製到剪貼簿。</div>
                  <div class="tiny muted" style="margin-top:8px">你也可以在下方查看：</div>
                  <pre class="tiny" style="white-space:pre-wrap;background:var(--panel);border:1px solid var(--stroke);padding:10px;border-radius:12px;max-height:240px;overflow:auto">${escapeHtml(json)}</pre>`,
        actions:[{label:"關閉", className:"primary", onClick: closeModal}]
      });
    }catch{
      openModal({
        title:"Export",
        bodyHtml:`<div class="tiny muted">瀏覽器不允許自動複製，請手動複製下面內容：</div>
                  <pre class="tiny" style="white-space:pre-wrap;background:var(--panel);border:1px solid var(--stroke);padding:10px;border-radius:12px;max-height:260px;overflow:auto">${escapeHtml(json)}</pre>`,
        actions:[{label:"關閉", className:"primary", onClick: closeModal}]
      });
    }
  };
  tryCopy();
});

el("btnImport").addEventListener("click", ()=>{
  const raw = (el("importBox").value ?? "").trim();
  if(!raw){
    openModal({ title:"Import 失敗", bodyHtml:`<div class="tiny muted">你沒有貼任何 JSON。</div>`,
      actions:[{label:"OK", className:"primary", onClick: closeModal}] });
    return;
  }
  openModal({
    title:"確認 Import（覆蓋）",
    bodyHtml:`<div class="tiny warnTxt"><b>注意：</b>Import 會覆蓋你目前進度。</div>
              <div class="tiny muted" style="margin-top:8px">確定要套用貼上的存檔嗎？</div>`,
    actions:[
      {label:"取消", className:"ghost", onClick: closeModal},
      {label:"確定 Import", className:"warn", onClick: ()=>{
        try{
          const parsed = JSON.parse(raw);
          if(!parsed || typeof parsed !== "object") throw new Error("bad json");
          if(!parsed.phase) throw new Error("missing phase");
          state = parsed;
          syncState();
          closeModal();
          renderAll();
        }catch{
          closeModal();
          openModal({
            title:"Import 失敗",
            bodyHtml:`<div class="tiny muted">JSON 格式不正確或缺少必要欄位。</div>`,
            actions:[{label:"OK", className:"primary", onClick: closeModal}]
          });
        }
      }}
    ]
  });
});

/* =========================
   Render All
   ========================= */
function renderAll(){
  setPhaseUI();
  renderLog();

  if(state.phase==="TEAM") renderTeamScreen();
  if(state.phase==="CORE") renderCoreScreen();
  if(state.phase==="HUB") renderHubScreen();
  if(state.phase==="TRADE") renderTradeScreen();
  if(state.phase==="FA") renderFAScreen();

  const ready = !!state.league;
  el("btnSim1").disabled = !ready;
  el("btnSim7").disabled = !ready;
  el("btnSimAll").disabled = !ready;
  el("btnNewSeason").disabled = !ready;
}
renderAll();

/* =========================
   Wire: Team/Core flow buttons
   ========================= */
// Team -> Core handled in renderTeamScreen

// Core finish handled in renderCoreScreen

</script>
</body>
</html>
