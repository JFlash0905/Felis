<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NBA GM Game — Phase E</title>
  <style>
    :root{
      --bg:#0b0f14;--card:#111827;--panel:#0b1220;--stroke:#243044;
      --text:#e5e7eb;--muted:#9ca3af;--accent:#22c55e;--warn:#f59e0b;--bad:#ef4444;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif}
    body{margin:0;background:linear-gradient(180deg,#070a10,#0b0f14);color:var(--text)}
    header{
      padding:14px 16px;border-bottom:1px solid #1f2937;position:sticky;top:0;
      background:rgba(11,15,20,.92);backdrop-filter:blur(10px);z-index:10;
      display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;
    }
    header h1{margin:0;font-size:16px}
    header .muted{color:var(--muted);font-size:12px}
    main{padding:16px;max-width:1100px;margin:0 auto}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:980px){.grid{grid-template-columns: 380px 1fr}}
    .card{background:rgba(17,24,39,.92);border:1px solid #1f2937;border-radius:12px;padding:12px}
    .panel{background:rgba(7,16,33,.55);border:1px solid #1f2937;border-radius:12px;padding:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row.space{justify-content:space-between}
    button,select,input{
      background:var(--panel);color:var(--text);
      border:1px solid var(--stroke);border-radius:10px;
      padding:10px 10px;font-size:14px
    }
    button{cursor:pointer}
    button.primary{background:linear-gradient(180deg,#22c55e,#16a34a);border:none;color:#041007;font-weight:800}
    button.ghost{background:transparent}
    button.warn{background:rgba(245,158,11,.13);border:1px solid rgba(245,158,11,.5)}
    button.danger{background:rgba(239,68,68,.13);border:1px solid rgba(239,68,68,.5)}
    button:disabled{opacity:.45;cursor:not-allowed}
    .pill{padding:4px 8px;border-radius:999px;border:1px solid var(--stroke);color:var(--muted);font-size:12px}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .kpi .box{flex:1 1 120px;background:var(--panel);border:1px solid var(--stroke);border-radius:12px;padding:10px}
    .kpi .box b{font-size:18px}
    .muted{color:var(--muted)}
    .tiny{font-size:12px}
    .bigTitle{font-size:18px;margin:0 0 6px 0}
    .teamGrid{display:grid;grid-template-columns:1fr;gap:8px}
    @media(min-width:720px){.teamGrid{grid-template-columns:1fr 1fr}}
    .teamBtn{
      width:100%;text-align:left;display:flex;justify-content:space-between;align-items:center;gap:10px;
      padding:12px;border-radius:12px
    }
    .teamBtn b{font-size:14px}
    .teamBtn small{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #1f2937;font-size:13px;vertical-align:top}
    th{color:#cbd5e1;text-align:left}
    tr:hover td{background:rgba(255,255,255,.02)}
    .star{color:#fde68a}
    .tag{font-size:12px;color:var(--muted);border:1px solid var(--stroke);border-radius:999px;padding:2px 8px}
    .warnTxt{color:#fcd34d}
    .goodTxt{color:#86efac}
    /* Modal */
    .modalBackdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.6);
      display:none;align-items:center;justify-content:center;padding:16px;z-index:50;
    }
    .modal{
      width:min(560px,100%);background:rgba(17,24,39,.97);
      border:1px solid #263244;border-radius:14px;padding:14px;
    }
    .modal h2{margin:0 0 8px 0;font-size:18px}
    .modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}
    .modal .body{background:var(--panel);border:1px solid var(--stroke);border-radius:12px;padding:12px}
    .modal input{width:100%}
    .linkBtn{background:transparent;border:none;padding:0;color:#93c5fd;cursor:pointer}
    .linkBtn:hover{text-decoration:underline}
  </style>
</head>
<body>
<header>
  <div>
    <h1>NBA GM Game — Phase E</h1>
    <div class="muted">選隊一次性｜選 2–3 基石｜點球員看資料｜Reset 需輸入 RESET｜自動存檔</div>
  </div>
  <div class="row">
    <span class="pill" id="hdrStatus">未選隊</span>
    <button class="danger" id="btnReset">Reset</button>
  </div>
</header>

<main>
  <div class="grid">
    <!-- LEFT: PROGRESS / CONTROLS -->
    <section class="card">
      <div class="row space">
        <div>
          <div class="tiny muted">目前階段</div>
          <div class="row">
            <b id="phaseTitle">選隊</b>
            <span class="pill" id="phasePill">Step 1/3</span>
          </div>
        </div>
        <div class="row">
          <button class="ghost" id="btnExport">Export Save JSON</button>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="kpi">
        <div class="box">
          <div class="tiny muted">你的球隊</div>
          <b id="kpiTeam">-</b>
        </div>
        <div class="box">
          <div class="tiny muted">基石數量</div>
          <b><span id="kpiCore">0</span> / 3</b>
        </div>
        <div class="box">
          <div class="tiny muted">狀態</div>
          <b id="kpiState">未開始</b>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="panel">
        <b>規則</b>
        <ul class="tiny muted" style="margin:8px 0 0 18px">
          <li>選隊只能一次，選完後「選隊」介面會消失（除非 Reset）。</li>
          <li>必須選 <b>2–3 位</b> 基石球員才能進主介面。</li>
          <li>Reset 需要輸入 <b>RESET</b>（全大寫）才會清空全部進度。</li>
        </ul>
      </div>

      <div style="height:10px"></div>

      <details>
        <summary class="muted">Import Save JSON（貼上覆蓋）</summary>
        <div style="height:8px"></div>
        <input id="importBox" placeholder='把 Export 的 JSON 貼這裡，按 Import' />
        <div style="height:8px"></div>
        <button class="warn" id="btnImport" style="width:100%">Import（覆蓋存檔）</button>
        <div class="tiny muted" style="margin-top:6px">Import 會直接套用你貼上的狀態。</div>
      </details>

      <div style="height:10px"></div>

      <div class="panel">
        <b>小提醒</b>
        <div class="tiny muted" style="margin-top:6px">
          這是 Phase E 原型，先把「選擇的重量感」做對。下一階段才加交易/比賽/賽季。
        </div>
      </div>
    </section>

    <!-- RIGHT: MAIN VIEW -->
    <section class="card">
      <!-- SCREEN: SELECT TEAM -->
      <div id="screenTeam">
        <p class="bigTitle">Step 1：選擇你的隊伍</p>
        <p class="muted tiny" style="margin-top:-2px">選完就鎖定，除非 Reset。</p>
        <div class="teamGrid" id="teamGrid"></div>
      </div>

      <!-- SCREEN: SELECT CORE -->
      <div id="screenCore" style="display:none">
        <div class="row space">
          <div>
            <p class="bigTitle">Step 2：選 2–3 位基石球員</p>
            <p class="muted tiny" style="margin-top:-2px">選到 2 位才可進主介面，最多 3 位。</p>
          </div>
          <div class="row">
            <span class="tag" id="coreCountTag">已選 0</span>
            <button class="primary" id="btnFinishCore" disabled>完成建隊 →</button>
          </div>
        </div>

        <div class="panel">
          <div class="row space">
            <b>基石球員池</b>
            <span class="pill muted">點卡片選取 / 取消</span>
          </div>
          <div style="height:8px"></div>
          <div class="teamGrid" id="coreGrid"></div>
        </div>
      </div>

      <!-- SCREEN: HUB -->
      <div id="screenHub" style="display:none">
        <div class="row space">
          <div>
            <p class="bigTitle">主介面</p>
            <div class="muted tiny">目前只有名單與球員詳細資訊（Phase E）。</div>
          </div>
          <div class="row">
            <span class="pill" id="hubTeamPill">-</span>
          </div>
        </div>

        <div class="panel">
          <div class="row space">
            <b>你的球員名單</b>
            <span class="pill muted">點球員名字看詳細</span>
          </div>
          <table id="rosterTable"></table>
        </div>

        <div style="height:12px"></div>

        <div class="panel">
          <b>下一步（你之後要加的）</b>
          <div class="tiny muted" style="margin-top:6px">
            交易｜比賽｜賽季｜AI 建隊｜更多球員池… 都可以在這個狀態機上直接擴充。
          </div>
        </div>
      </div>
    </section>
  </div>
</main>

<!-- Modal -->
<div class="modalBackdrop" id="modalBackdrop" role="dialog" aria-modal="true">
  <div class="modal" id="modal">
    <h2 id="modalTitle">Title</h2>
    <div class="body" id="modalBody"></div>
    <div class="actions" id="modalActions"></div>
  </div>
</div>

<script>
/* =========================
   Phase E Core Prototype
   ========================= */

const LS_KEY = "nba_gm_phaseE_save_v1";

const TEAMS = [
  "Atlanta Hawks","Boston Celtics","Brooklyn Nets","Charlotte Hornets","Chicago Bulls",
  "Cleveland Cavaliers","Dallas Mavericks","Denver Nuggets","Detroit Pistons","Golden State Warriors",
  "Houston Rockets","Indiana Pacers","LA Clippers","Los Angeles Lakers","Memphis Grizzlies",
  "Miami Heat","Milwaukee Bucks","Minnesota Timberwolves","New Orleans Pelicans","New York Knicks",
  "Oklahoma City Thunder","Orlando Magic","Philadelphia 76ers","Phoenix Suns","Portland Trail Blazers",
  "Sacramento Kings","San Antonio Spurs","Toronto Raptors","Utah Jazz","Washington Wizards"
];

const POS = ["PG","SG","SF","PF","C"];
const rand = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const pick = arr => arr[rand(0,arr.length-1)];
const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
const el = id => document.getElementById(id);

function escapeHtml(s){
  return (s??"").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ====== Player generation (placeholder)
   你之後要換成「真實 NBA 球員」也沒問題：把 player pool 換成你的 JSON 就行。
*/
function seededName(i){
  const first = ["Jalen","Devin","Jay","Brandon","Tyrese","CJ","Zach","Mikal","Kyrie","Jayson","Anthony","Paolo","Cade","Darius","Jrue","Julius","Bam","Domantas","De'Aaron","LaMelo","Shai","Scottie","Franz","Kawhi","Jimmy","Trae","Luka","Nikola","Joel","Victor","Alperen","Jamal","KAT","Pascal","Donovan","Desmond","Evan","OG","Kristaps","Jaren","Rudy","Ja","DeMar","Bradley"];
  const last  = ["Walker","Green","Brown","Ingram","Haliburton","McCollum","LaVine","Bridges","Irving","Tatum","Edwards","Banchero","Cunningham","Garland","Holiday","Randle","Adebayo","Sabonis","Fox","Ball","Gilgeous-Alexander","Barnes","Wagner","Leonard","Butler","Young","Doncic","Jokic","Embiid","Wembanyama","Sengun","Murray","Towns","Siakam","Mitchell","Bane","Mobley","Anunoby","Porzingis","Jackson","Gobert","Morant","DeRozan","Beal"];
  return `${first[i%first.length]} ${last[(i*7)%last.length]}`;
}
function genPlayer(id){
  const name = seededName(id) + (id>60 ? ` ${String.fromCharCode(65+(id%26))}` : "");
  const pos = pick(POS);
  // 基石池偏強
  const ovr = clamp(rand(78,94) + (id%9===0? 3:0), 75, 97);
  const age = rand(19,33);
  return { id, name, pos, ovr, age };
}
function buildCorePool(n=18){
  const pool=[];
  for(let i=1;i<=n;i++) pool.push(genPlayer(i));
  // 讓池子更像「可選策略」：位置平均一下
  pool.sort((a,b)=>a.pos.localeCompare(b.pos) || b.ovr-a.ovr);
  return pool;
}

/* ====== State machine ======
   phase: "TEAM" -> "CORE" -> "HUB"
*/
function defaultState(){
  return {
    version: 1,
    phase: "TEAM",
    teamLocked: false,
    userTeam: null, // team name
    corePool: buildCorePool(18),
    chosenCoreIds: [], // ids from corePool
    roster: [], // player objects you own
    createdAt: Date.now(),
    updatedAt: Date.now(),
  };
}

let state = loadState() ?? defaultState();
syncLegacyStateIfNeeded();
renderAll();

/* ====== Persistence ====== */
function saveState(){
  state.updatedAt = Date.now();
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}
function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return null;
    const parsed = JSON.parse(raw);
    if(!parsed || typeof parsed !== "object") return null;
    return parsed;
  }catch{ return null; }
}
function hardReset(){
  localStorage.removeItem(LS_KEY);
  state = defaultState();
  renderAll();
}
function syncLegacyStateIfNeeded(){
  // Future-proof hook
}

/* ====== Modal helper ====== */
function openModal({title, bodyHtml, actions}){
  el("modalTitle").textContent = title;
  el("modalBody").innerHTML = bodyHtml;
  const actionsBox = el("modalActions");
  actionsBox.innerHTML = "";
  actions.forEach(a=>{
    const btn = document.createElement("button");
    btn.textContent = a.label;
    btn.className = a.className || "ghost";
    btn.addEventListener("click", ()=>{
      if(a.onClick) a.onClick();
    });
    actionsBox.appendChild(btn);
  });
  el("modalBackdrop").style.display = "flex";
}
function closeModal(){
  el("modalBackdrop").style.display = "none";
}
el("modalBackdrop").addEventListener("click",(e)=>{
  if(e.target === el("modalBackdrop")) closeModal();
});

/* ====== UI rendering ====== */
function setPhaseUI(){
  const phase = state.phase;
  const hdrStatus = el("hdrStatus");

  const screenTeam = el("screenTeam");
  const screenCore = el("screenCore");
  const screenHub  = el("screenHub");

  screenTeam.style.display = (phase==="TEAM") ? "" : "none";
  screenCore.style.display = (phase==="CORE") ? "" : "none";
  screenHub.style.display  = (phase==="HUB")  ? "" : "none";

  let title="選隊", pill="Step 1/3";
  if(phase==="CORE"){ title="選基石"; pill="Step 2/3"; }
  if(phase==="HUB"){ title="主介面"; pill="Step 3/3"; }

  el("phaseTitle").textContent = title;
  el("phasePill").textContent = pill;

  if(state.teamLocked && state.userTeam){
    hdrStatus.textContent = `已選隊：${state.userTeam}`;
  }else{
    hdrStatus.textContent = "未選隊";
  }

  // KPIs
  el("kpiTeam").textContent = state.userTeam ?? "-";
  el("kpiCore").textContent = state.chosenCoreIds.length;
  el("kpiState").textContent =
    phase==="TEAM" ? "請選隊" :
    phase==="CORE" ? "請選基石" :
    "進入主介面";
}

function renderTeamScreen(){
  const grid = el("teamGrid");
  grid.innerHTML = "";

  TEAMS.forEach(t=>{
    const btn = document.createElement("button");
    btn.className = "teamBtn";
    btn.innerHTML = `<div><b>${escapeHtml(t)}</b><div><small>點選後鎖定</small></div></div><span class="pill">選擇</span>`;
    btn.addEventListener("click", ()=>{
      if(state.teamLocked) return;
      openModal({
        title: "確認選隊",
        bodyHtml: `<div class="tiny muted">你確定要選擇：</div>
                  <div style="margin-top:6px;font-size:16px"><b>${escapeHtml(t)}</b></div>
                  <div class="tiny warnTxt" style="margin-top:10px">選完後無法更換（除非 Reset）。</div>`,
        actions: [
          {label:"取消", className:"ghost", onClick: closeModal},
          {label:"確定鎖定", className:"primary", onClick: ()=>{
            closeModal();
            chooseTeam(t);
          }}
        ]
      });
    });
    grid.appendChild(btn);
  });
}

function chooseTeam(teamName){
  state.userTeam = teamName;
  state.teamLocked = true;
  state.phase = "CORE";
  saveState();
  renderAll();
}

function renderCoreScreen(){
  const grid = el("coreGrid");
  grid.innerHTML = "";

  const selected = new Set(state.chosenCoreIds);
  const canFinish = state.chosenCoreIds.length >= 2;

  el("coreCountTag").textContent = `已選 ${state.chosenCoreIds.length}`;
  el("btnFinishCore").disabled = !canFinish;

  state.corePool.forEach(p=>{
    const isSelected = selected.has(p.id);
    const btn = document.createElement("button");
    btn.className = "teamBtn";
    btn.style.border = isSelected ? "1px solid rgba(34,197,94,.7)" : "1px solid var(--stroke)";
    btn.style.background = isSelected ? "rgba(34,197,94,.12)" : "var(--panel)";
    btn.innerHTML = `
      <div>
        <b>${escapeHtml(p.name)} ${isSelected ? `<span class="star">★</span>` : ""}</b>
        <div><small>${escapeHtml(p.pos)} · OVR ${p.ovr} · 年齡 ${p.age}</small></div>
      </div>
      <span class="pill">${isSelected ? "已選" : "選取"}</span>
    `;
    btn.addEventListener("click", ()=>{
      toggleCorePick(p.id);
    });
    grid.appendChild(btn);
  });

  el("btnFinishCore").onclick = ()=>{
    if(state.chosenCoreIds.length < 2) return;
    finalizeCore();
  };
}

function toggleCorePick(playerId){
  const idx = state.chosenCoreIds.indexOf(playerId);
  const selectedCount = state.chosenCoreIds.length;

  if(idx >= 0){
    // unselect
    state.chosenCoreIds.splice(idx,1);
  }else{
    // select
    if(selectedCount >= 3){
      openModal({
        title:"已達上限",
        bodyHtml:`<div class="tiny muted">你最多只能選 <b>3</b> 位基石。</div>`,
        actions:[{label:"OK", className:"primary", onClick: closeModal}]
      });
      return;
    }
    state.chosenCoreIds.push(playerId);
  }
  saveState();
  renderAll();
}

function finalizeCore(){
  // Build roster from chosen core players
  const chosen = new Set(state.chosenCoreIds);
  const roster = state.corePool
    .filter(p=>chosen.has(p.id))
    .map(p=>({...p, isCore:true, team: state.userTeam}));

  state.roster = roster;
  state.phase = "HUB";
  saveState();
  renderAll();
}

function renderHubScreen(){
  el("hubTeamPill").textContent = state.userTeam ? `你的隊伍：${state.userTeam}` : "-";
  const table = el("rosterTable");

  if(!state.roster || state.roster.length===0){
    table.innerHTML = `<tr><td class="muted">目前名單是空的。回到選基石挑 2–3 位。</td></tr>`;
    return;
  }

  const rows = state.roster
    .sort((a,b)=> (b.isCore-a.isCore) || (b.ovr-a.ovr))
    .map(p=>{
      return `
        <tr>
          <td>
            <button class="linkBtn" data-pid="${p.id}">${escapeHtml(p.name)}</button>
            ${p.isCore ? `<span class="star">★</span>` : ""}
            <div class="tiny muted">${escapeHtml(p.pos)} · OVR ${p.ovr}</div>
          </td>
          <td>${p.age}</td>
          <td>${escapeHtml(p.team ?? state.userTeam ?? "-")}</td>
        </tr>
      `;
    }).join("");

  table.innerHTML = `
    <thead>
      <tr><th>球員</th><th>年齡</th><th>球隊</th></tr>
    </thead>
    <tbody>${rows}</tbody>
  `;

  // bind clicks
  table.querySelectorAll("button[data-pid]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const pid = Number(btn.getAttribute("data-pid"));
      const player = state.roster.find(x=>x.id===pid);
      if(player) showPlayerDetail(player);
    });
  });
}

function showPlayerDetail(p){
  openModal({
    title: "球員詳細資訊",
    bodyHtml: `
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <div style="font-size:18px"><b>${escapeHtml(p.name)}</b> ${p.isCore?`<span class="star">★ 基石</span>`:""}</div>
          <div class="tiny muted" style="margin-top:4px">${escapeHtml(p.team ?? "-")}</div>
        </div>
        <span class="pill">OVR ${p.ovr}</span>
      </div>
      <div style="height:10px"></div>
      <div class="row">
        <span class="pill">位置：${escapeHtml(p.pos)}</span>
        <span class="pill">年齡：${p.age}</span>
        <span class="pill">ID：${p.id}</span>
      </div>
      <div style="height:10px"></div>
      <div class="tiny muted">
        （Phase E）下一版你可以在這裡加：技能/潛力/合約/徽章/成長曲線。
      </div>
    `,
    actions:[
      {label:"關閉", className:"primary", onClick: closeModal}
    ]
  });
}

/* ====== Reset / Export / Import ====== */
el("btnReset").addEventListener("click", ()=>{
  openModal({
    title: "Reset（清空全部進度）",
    bodyHtml: `
      <div class="tiny warnTxt"><b>注意：</b>Reset 會清空所有進度，回到選隊畫面。</div>
      <div class="tiny muted" style="margin-top:10px">請在下方輸入 <b>RESET</b>（全大寫）確認。</div>
      <div style="height:10px"></div>
      <input id="resetInput" placeholder="輸入 RESET" />
    `,
    actions:[
      {label:"取消", className:"ghost", onClick: closeModal},
      {label:"確定 Reset", className:"danger", onClick: ()=>{
        const val = (document.getElementById("resetInput")?.value ?? "").trim();
        if(val !== "RESET"){
          openModal({
            title:"輸入錯誤",
            bodyHtml:`<div class="tiny muted">你輸入的是：<b>${escapeHtml(val||"(空)")}</b></div>
                      <div class="tiny warnTxt" style="margin-top:8px">必須完整輸入 <b>RESET</b> 才能清空。</div>`,
            actions:[{label:"OK", className:"primary", onClick: closeModal}]
          });
          return;
        }
        closeModal();
        hardReset();
      }}
    ]
  });
});

el("btnExport").addEventListener("click", ()=>{
  const json = JSON.stringify(state, null, 2);
  // 嘗試複製到剪貼簿
  const tryCopy = async ()=>{
    try{
      await navigator.clipboard.writeText(json);
      openModal({
        title:"Export 成功",
        bodyHtml:`<div class="tiny muted">已把存檔 JSON 複製到剪貼簿。</div>
                  <div class="tiny muted" style="margin-top:8px">你也可以在下方查看：</div>
                  <pre class="tiny" style="white-space:pre-wrap;background:var(--panel);border:1px solid var(--stroke);padding:10px;border-radius:12px;max-height:220px;overflow:auto">${escapeHtml(json)}</pre>`,
        actions:[{label:"關閉", className:"primary", onClick: closeModal}]
      });
    }catch{
      openModal({
        title:"Export",
        bodyHtml:`<div class="tiny muted">瀏覽器不允許自動複製，請手動複製下面內容：</div>
                  <pre class="tiny" style="white-space:pre-wrap;background:var(--panel);border:1px solid var(--stroke);padding:10px;border-radius:12px;max-height:260px;overflow:auto">${escapeHtml(json)}</pre>`,
        actions:[{label:"關閉", className:"primary", onClick: closeModal}]
      });
    }
  };
  tryCopy();
});

el("btnImport").addEventListener("click", ()=>{
  const raw = (el("importBox").value ?? "").trim();
  if(!raw){
    openModal({
      title:"Import 失敗",
      bodyHtml:`<div class="tiny muted">你沒有貼任何 JSON。</div>`,
      actions:[{label:"OK", className:"primary", onClick: closeModal}]
    });
    return;
  }
  openModal({
    title:"確認 Import（覆蓋）",
    bodyHtml:`<div class="tiny warnTxt"><b>注意：</b>Import 會覆蓋你目前進度。</div>
              <div class="tiny muted" style="margin-top:8px">確定要套用貼上的存檔嗎？</div>`,
    actions:[
      {label:"取消", className:"ghost", onClick: closeModal},
      {label:"確定 Import", className:"warn", onClick: ()=>{
        try{
          const parsed = JSON.parse(raw);
          if(!parsed || typeof parsed !== "object") throw new Error("bad json");
          // basic validation
          if(!parsed.phase) throw new Error("missing phase");
          state = parsed;
          saveState();
          closeModal();
          renderAll();
        }catch{
          closeModal();
          openModal({
            title:"Import 失敗",
            bodyHtml:`<div class="tiny muted">JSON 格式不正確或缺少必要欄位。</div>`,
            actions:[{label:"OK", className:"primary", onClick: closeModal}]
          });
        }
      }}
    ]
  });
});

/* ====== Main render ====== */
function renderAll(){
  setPhaseUI();
  if(state.phase==="TEAM"){
    renderTeamScreen();
  }else if(state.phase==="CORE"){
    renderCoreScreen();
  }else if(state.phase==="HUB"){
    renderHubScreen();
  }
}
</script>
</body>
</html>
