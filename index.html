<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NBA GM Game — Phase I</title>
  <style>
    :root{
      --bg:#0b0f14;--card:#111827;--panel:#0b1220;--stroke:#243044;
      --text:#e5e7eb;--muted:#9ca3af;--accent:#22c55e;--warn:#f59e0b;--bad:#ef4444;
      --blue:#60a5fa;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif}
    body{margin:0;background:linear-gradient(180deg,#070a10,#0b0f14);color:var(--text)}
    header{
      padding:14px 16px;border-bottom:1px solid #1f2937;position:sticky;top:0;
      background:rgba(11,15,20,.92);backdrop-filter:blur(10px);z-index:10;
      display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;
    }
    header h1{margin:0;font-size:16px}
    header .muted{color:var(--muted);font-size:12px}
    main{padding:16px;max-width:1240px;margin:0 auto}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:1100px){.grid{grid-template-columns: 430px 1fr}}
    .card{background:rgba(17,24,39,.92);border:1px solid #1f2937;border-radius:12px;padding:12px}
    .panel{background:rgba(7,16,33,.55);border:1px solid #1f2937;border-radius:12px;padding:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row.space{justify-content:space-between}
    button,select,input{
      background:var(--panel);color:var(--text);
      border:1px solid var(--stroke);border-radius:10px;
      padding:10px 10px;font-size:14px
    }
    button{cursor:pointer}
    button.primary{background:linear-gradient(180deg,#22c55e,#16a34a);border:none;color:#041007;font-weight:800}
    button.ghost{background:transparent}
    button.warn{background:rgba(245,158,11,.13);border:1px solid rgba(245,158,11,.5)}
    button.danger{background:rgba(239,68,68,.13);border:1px solid rgba(239,68,68,.5)}
    button.blue{background:rgba(96,165,250,.14);border:1px solid rgba(96,165,250,.5)}
    button:disabled{opacity:.45;cursor:not-allowed}
    select{min-width:180px}
    .pill{padding:4px 8px;border-radius:999px;border:1px solid var(--stroke);color:var(--muted);font-size:12px}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .kpi .box{flex:1 1 120px;background:var(--panel);border:1px solid var(--stroke);border-radius:12px;padding:10px}
    .kpi .box b{font-size:18px}
    .muted{color:var(--muted)}
    .tiny{font-size:12px}
    .bigTitle{font-size:18px;margin:0 0 6px 0}
    .teamGrid{display:grid;grid-template-columns:1fr;gap:8px}
    @media(min-width:860px){.teamGrid{grid-template-columns:1fr 1fr}}
    .teamBtn{
      width:100%;text-align:left;display:flex;justify-content:space-between;align-items:center;gap:10px;
      padding:12px;border-radius:12px
    }
    .teamBtn b{font-size:14px}
    .teamBtn small{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #1f2937;font-size:13px;vertical-align:top}
    th{color:#cbd5e1;text-align:left}
    tr:hover td{background:rgba(255,255,255,.02)}
    .star{color:#fde68a}
    .tag{font-size:12px;color:var(--muted);border:1px solid var(--stroke);border-radius:999px;padding:2px 8px}
    .warnTxt{color:#fcd34d}
    .goodTxt{color:#86efac}
    .badTxt{color:#fca5a5}
    .linkBtn{background:transparent;border:none;padding:0;color:#93c5fd;cursor:pointer}
    .linkBtn:hover{text-decoration:underline}
    .cols2{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:940px){.cols2{grid-template-columns:1fr 1fr}}
    .miniList{max-height:280px;overflow:auto;background:var(--panel);border:1px solid var(--stroke);border-radius:12px;padding:8px}
    .miniList .item{padding:8px;border-bottom:1px solid rgba(255,255,255,.06)}
    .miniList .item:last-child{border-bottom:none}
    .log{max-height:220px;overflow:auto;background:var(--panel);border:1px solid var(--stroke);border-radius:12px;padding:10px}
    .log p{margin:6px 0;font-size:13px}
    /* Modal */
    .modalBackdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.6);
      display:none;align-items:center;justify-content:center;padding:16px;z-index:50;
    }
    .modal{
      width:min(720px,100%);background:rgba(17,24,39,.97);
      border:1px solid #263244;border-radius:14px;padding:14px;
    }
    .modal h2{margin:0 0 8px 0;font-size:18px}
    .modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}
    .modal .body{background:var(--panel);border:1px solid var(--stroke);border-radius:12px;padding:12px}
    .modal input{width:100%}
  </style>
</head>
<body>
<header>
  <div>
    <h1>NBA GM Game — Phase I</h1>
    <div class="muted">基石建隊｜交易｜比賽/賽季/排名｜自由市場（非基石）｜AI補人｜季末選秀｜Reset 需輸入 RESET｜自動存檔</div>
  </div>
  <div class="row">
    <span class="pill" id="hdrStatus">未選隊</span>
    <button class="danger" id="btnReset">Reset</button>
  </div>
</header>

<main>
  <div class="grid">
    <!-- LEFT -->
    <section class="card">
      <div class="row space">
        <div>
          <div class="tiny muted">目前階段</div>
          <div class="row">
            <b id="phaseTitle">選隊</b>
            <span class="pill" id="phasePill">Step 1/6</span>
          </div>
        </div>
        <div class="row">
          <button class="ghost" id="btnExport">Export Save JSON</button>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="kpi">
        <div class="box">
          <div class="tiny muted">賽季</div>
          <b id="kpiSeason">-</b>
        </div>
        <div class="box">
          <div class="tiny muted">進度</div>
          <b id="kpiDay">-</b>
        </div>
        <div class="box">
          <div class="tiny muted">你的戰績</div>
          <b><span id="kpiW">0</span>-<span id="kpiL">0</span></b>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="panel">
        <div class="row space">
          <b>比賽 / 賽季推進</b>
          <span class="pill" id="seasonHint">-</span>
        </div>
        <div style="height:10px"></div>
        <div class="row">
          <button class="primary" id="btnSim1">模擬 1 天</button>
          <button class="ghost" id="btnSim7">模擬 7 天</button>
          <button class="ghost" id="btnSimAll">模擬到季末</button>
          <button class="warn" id="btnNewSeason">新賽季</button>
        </div>
        <div class="tiny muted" style="margin-top:8px">
          1 天 = 全聯盟 15 場。<br/>
          <span class="warnTxt">季末後會進入「休賽季」：選秀 → 新賽季。</span>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="panel">
        <div class="row space">
          <b>事件紀錄</b>
          <button class="ghost danger" id="btnClearLog">清空</button>
        </div>
        <div style="height:8px"></div>
        <div class="log" id="log"></div>
      </div>

      <div style="height:10px"></div>

      <details>
        <summary class="muted">Import Save JSON（貼上覆蓋）</summary>
        <div style="height:8px"></div>
        <input id="importBox" placeholder='把 Export 的 JSON 貼這裡，按 Import' />
        <div style="height:8px"></div>
        <button class="warn" id="btnImport" style="width:100%">Import（覆蓋存檔）</button>
        <div class="tiny muted" style="margin-top:6px">Import 會直接套用你貼上的狀態。</div>
      </details>
    </section>

    <!-- RIGHT -->
    <section class="card">

      <!-- SCREEN: TEAM -->
      <div id="screenTeam">
        <p class="bigTitle">Step 1：選擇你的隊伍</p>
        <p class="muted tiny" style="margin-top:-2px">選完就鎖定，除非 Reset。</p>
        <div class="teamGrid" id="teamGrid"></div>
      </div>

      <!-- SCREEN: CORE -->
      <div id="screenCore" style="display:none">
        <div class="row space">
          <div>
            <p class="bigTitle">Step 2：選 2–3 位基石球員</p>
            <p class="muted tiny" style="margin-top:-2px">選到 2 位才可進主介面，最多 3 位。</p>
          </div>
          <div class="row">
            <span class="tag" id="coreCountTag">已選 0</span>
            <button class="primary" id="btnFinishCore" disabled>完成建隊 →</button>
          </div>
        </div>

        <div class="panel">
          <div class="row space">
            <b>基石球員池（現實 NBA 名字）</b>
            <span class="pill muted">點卡片選取 / 取消</span>
          </div>
          <div style="height:8px"></div>
          <div class="teamGrid" id="coreGrid"></div>
        </div>
      </div>

      <!-- SCREEN: HUB -->
      <div id="screenHub" style="display:none">
        <div class="row space">
          <div>
            <p class="bigTitle">主介面</p>
            <div class="muted tiny">看名單、交易、自由市場補人、推賽季、看排名。</div>
          </div>
          <div class="row">
            <span class="pill" id="hubTeamPill">-</span>
            <button class="ghost" id="btnGoFA">自由市場</button>
            <button class="blue" id="btnGoTrade">交易中心</button>
          </div>
        </div>

        <div class="cols2">
          <div class="panel">
            <div class="row space">
              <b>你的球員名單</b>
              <span class="pill muted" id="rosterCapPill">-</span>
            </div>
            <table id="rosterTable"></table>
          </div>

          <div class="panel">
            <div class="row space">
              <b>聯盟排名</b>
              <span class="pill muted">依勝率排序</span>
            </div>
            <table id="standingsTable"></table>
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="panel">
          <div class="row space">
            <b>聯盟基石概覽</b>
            <span class="pill muted">每隊 2–3 位</span>
          </div>
          <div class="miniList" id="leagueCoresList"></div>
        </div>
      </div>

      <!-- SCREEN: TRADE -->
      <div id="screenTrade" style="display:none">
        <div class="row space">
          <div>
            <p class="bigTitle">交易中心（1 換 1）</p>
            <div class="tiny muted">基石交易代價極高：AI 需求倍率更大。</div>
          </div>
          <div class="row">
            <button class="ghost" id="btnBackHubFromTrade">← 回主介面</button>
          </div>
        </div>

        <div class="panel">
          <div class="row space">
            <b>選擇對手隊伍</b>
            <span class="pill" id="tradeHintPill">-</span>
          </div>
          <div style="height:10px"></div>

          <div class="row">
            <select id="oppSelect"></select>
            <button class="ghost" id="btnRefreshTrade">刷新清單</button>
          </div>

          <div style="height:10px"></div>

          <div class="cols2">
            <div class="panel" style="background:rgba(11,18,32,.8)">
              <b>你送出</b>
              <div class="tiny muted" style="margin-top:6px">選一位你隊球員</div>
              <div style="height:8px"></div>
              <select id="giveSelect" style="width:100%"></select>
              <div class="tiny muted" style="margin-top:8px" id="giveValueInfo">價值：-</div>
              <div style="height:8px"></div>
              <div class="miniList" id="myRosterMini"></div>
            </div>

            <div class="panel" style="background:rgba(11,18,32,.8)">
              <b>你得到</b>
              <div class="tiny muted" style="margin-top:6px">選一位對手球員</div>
              <div style="height:8px"></div>
              <select id="getSelect" style="width:100%"></select>
              <div class="tiny muted" style="margin-top:8px" id="getValueInfo">價值：-</div>
              <div style="height:8px"></div>
              <div class="miniList" id="oppRosterMini"></div>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="row space">
            <div class="tiny muted" id="aiRuleInfo">AI 規則：你的報價價值 ≥ 對手球員價值 × 倍率</div>
            <button class="primary" id="btnTrade">送出交易</button>
          </div>
        </div>
      </div>

      <!-- SCREEN: FREE AGENCY -->
      <div id="screenFA" style="display:none">
        <div class="row space">
          <div>
            <p class="bigTitle">自由市場（非基石補人）</p>
            <div class="tiny muted">你可以直接簽人進隊；AI 也會在推賽季時補人。</div>
          </div>
          <div class="row">
            <button class="ghost" id="btnBackHubFromFA">← 回主介面</button>
          </div>
        </div>

        <div class="panel">
          <div class="row space">
            <b>自由球員清單</b>
            <span class="pill" id="faHintPill">-</span>
          </div>
          <div style="height:10px"></div>

          <div class="row">
            <input id="faSearch" placeholder="搜尋名字（例如 Curry）" style="flex:1;min-width:220px" />
            <select id="faPosFilter">
              <option value="">全部位置</option>
              <option value="PG">PG</option>
              <option value="SG">SG</option>
              <option value="SF">SF</option>
              <option value="PF">PF</option>
              <option value="C">C</option>
            </select>
            <select id="faSort">
              <option value="ovr">OVR 高→低</option>
              <option value="age">年齡 低→高</option>
              <option value="name">名字 A→Z</option>
            </select>
          </div>

          <div style="height:10px"></div>

          <div class="cols2">
            <div class="panel" style="background:rgba(11,18,32,.8)">
              <b>可簽球員（Top 40 顯示）</b>
              <div class="tiny muted" style="margin-top:6px">點名字看詳情；按「簽下」進隊。</div>
              <div style="height:8px"></div>
              <div class="miniList" id="faList"></div>
            </div>

            <div class="panel" style="background:rgba(11,18,32,.8)">
              <b>你的名單</b>
              <div class="tiny muted" style="margin-top:6px">名單滿了就不能簽（你可以用交易調整）。</div>
              <div style="height:8px"></div>
              <div class="miniList" id="faMyRoster"></div>
            </div>
          </div>

          <div class="tiny muted" style="margin-top:10px">
            <b>休賽季選秀：</b>季末會產生新秀，依排名（倒序）每隊選一位。你到你順位會跳出讓你挑。
          </div>
        </div>
      </div>

    </section>
  </div>
</main>

<!-- Modal -->
<div class="modalBackdrop" id="modalBackdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <h2 id="modalTitle">Title</h2>
    <div class="body" id="modalBody"></div>
    <div class="actions" id="modalActions"></div>
  </div>
</div>

<script>
/* =========================
   NBA GM — Phase I
   ========================= */

const LS_KEY = "nba_gm_phaseI_save_v1";

// 名單上限（你想更真實可改 15）
const MAX_ROSTER = 12;

// 一季每隊幾場（你想加長直接改）
const DEFAULT_GAMES_PER_TEAM = 20;

const TEAMS = [
  "Atlanta Hawks","Boston Celtics","Brooklyn Nets","Charlotte Hornets","Chicago Bulls",
  "Cleveland Cavaliers","Dallas Mavericks","Denver Nuggets","Detroit Pistons","Golden State Warriors",
  "Houston Rockets","Indiana Pacers","LA Clippers","Los Angeles Lakers","Memphis Grizzlies",
  "Miami Heat","Milwaukee Bucks","Minnesota Timberwolves","New Orleans Pelicans","New York Knicks",
  "Oklahoma City Thunder","Orlando Magic","Philadelphia 76ers","Phoenix Suns","Portland Trail Blazers",
  "Sacramento Kings","San Antonio Spurs","Toronto Raptors","Utah Jazz","Washington Wizards"
];

const rand = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
const el = id => document.getElementById(id);

function escapeHtml(s){
  return (s??"").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ===== Player pool (real names, simplified numbers) ===== */
const NBA_PLAYER_POOL = [
  {id:1,name:"Nikola Jokic",pos:"C",ovr:98,age:29},
  {id:2,name:"Giannis Antetokounmpo",pos:"PF",ovr:97,age:30},
  {id:3,name:"Luka Doncic",pos:"PG",ovr:97,age:26},
  {id:4,name:"Shai Gilgeous-Alexander",pos:"PG",ovr:95,age:27},
  {id:5,name:"Joel Embiid",pos:"C",ovr:96,age:31},
  {id:6,name:"Jayson Tatum",pos:"SF",ovr:94,age:27},
  {id:7,name:"Stephen Curry",pos:"PG",ovr:95,age:37},
  {id:8,name:"LeBron James",pos:"SF",ovr:94,age:41},
  {id:9,name:"Kevin Durant",pos:"SF",ovr:94,age:37},
  {id:10,name:"Anthony Davis",pos:"PF",ovr:93,age:32},
  {id:11,name:"Devin Booker",pos:"SG",ovr:93,age:29},
  {id:12,name:"Kawhi Leonard",pos:"SF",ovr:92,age:34},
  {id:13,name:"Jimmy Butler",pos:"SF",ovr:91,age:36},
  {id:14,name:"Damian Lillard",pos:"PG",ovr:92,age:35},
  {id:15,name:"Ja Morant",pos:"PG",ovr:92,age:26},
  {id:16,name:"Anthony Edwards",pos:"SG",ovr:93,age:24},
  {id:17,name:"Donovan Mitchell",pos:"SG",ovr:92,age:29},
  {id:18,name:"Tyrese Haliburton",pos:"PG",ovr:90,age:26},
  {id:19,name:"Jalen Brunson",pos:"PG",ovr:89,age:29},
  {id:20,name:"Jaylen Brown",pos:"SG",ovr:89,age:29},
  {id:21,name:"Kyrie Irving",pos:"PG",ovr:89,age:33},
  {id:22,name:"Karl-Anthony Towns",pos:"C",ovr:89,age:30},
  {id:23,name:"Bam Adebayo",pos:"C",ovr:88,age:28},
  {id:24,name:"Domantas Sabonis",pos:"C",ovr:88,age:29},
  {id:25,name:"Zion Williamson",pos:"PF",ovr:88,age:25},
  {id:26,name:"Paul George",pos:"SF",ovr:88,age:35},
  {id:27,name:"De'Aaron Fox",pos:"PG",ovr:88,age:28},
  {id:28,name:"Jamal Murray",pos:"PG",ovr:88,age:28},
  {id:29,name:"Tyrese Maxey",pos:"SG",ovr:87,age:25},
  {id:30,name:"Cade Cunningham",pos:"PG",ovr:87,age:24},
  {id:31,name:"Scottie Barnes",pos:"SF",ovr:87,age:24},
  {id:32,name:"Paolo Banchero",pos:"PF",ovr:87,age:23},
  {id:33,name:"Victor Wembanyama",pos:"C",ovr:90,age:22},
  {id:34,name:"Chet Holmgren",pos:"C",ovr:85,age:23},
  {id:35,name:"Jalen Williams",pos:"SF",ovr:85,age:24},
  {id:36,name:"Alperen Sengun",pos:"C",ovr:86,age:23},
  {id:37,name:"Franz Wagner",pos:"SF",ovr:86,age:24},
  {id:38,name:"Mikal Bridges",pos:"SF",ovr:86,age:29},
  {id:39,name:"Brandon Ingram",pos:"SF",ovr:86,age:28},
  {id:40,name:"Lauri Markkanen",pos:"PF",ovr:86,age:28},
  {id:41,name:"Jaren Jackson Jr.",pos:"PF",ovr:86,age:26},
  {id:42,name:"Desmond Bane",pos:"SG",ovr:85,age:27},
  {id:43,name:"DeMar DeRozan",pos:"SF",ovr:85,age:36},
  {id:44,name:"Bradley Beal",pos:"SG",ovr:84,age:32},
  {id:45,name:"Jrue Holiday",pos:"PG",ovr:84,age:35},
  {id:46,name:"Pascal Siakam",pos:"PF",ovr:85,age:32},
  {id:47,name:"Julius Randle",pos:"PF",ovr:84,age:31},
  {id:48,name:"Kristaps Porzingis",pos:"C",ovr:84,age:30},
  {id:49,name:"Deandre Ayton",pos:"C",ovr:83,age:27},
  {id:50,name:"Darius Garland",pos:"PG",ovr:84,age:26},
  {id:51,name:"Evan Mobley",pos:"PF",ovr:84,age:24},
  {id:52,name:"Jarrett Allen",pos:"C",ovr:83,age:27},
  {id:53,name:"OG Anunoby",pos:"SF",ovr:83,age:28},
  {id:54,name:"Dejounte Murray",pos:"PG",ovr:83,age:29},
  {id:55,name:"Myles Turner",pos:"C",ovr:82,age:29},
  {id:56,name:"Zach LaVine",pos:"SG",ovr:84,age:30},
  {id:57,name:"James Harden",pos:"SG",ovr:84,age:36},
  {id:58,name:"Russell Westbrook",pos:"PG",ovr:78,age:37},
  {id:59,name:"Klay Thompson",pos:"SG",ovr:79,age:35},
  {id:60,name:"Draymond Green",pos:"PF",ovr:79,age:35},
  {id:61,name:"LaMelo Ball",pos:"PG",ovr:85,age:24},
  {id:62,name:"Devin Vassell",pos:"SG",ovr:80,age:25},
  {id:63,name:"Jalen Green",pos:"SG",ovr:80,age:24},
  {id:64,name:"Fred VanVleet",pos:"PG",ovr:81,age:31},
  {id:65,name:"Jerami Grant",pos:"PF",ovr:81,age:31},
  {id:66,name:"Michael Porter Jr.",pos:"SF",ovr:81,age:27},
  {id:67,name:"Aaron Gordon",pos:"PF",ovr:80,age:30},
  {id:68,name:"Austin Reaves",pos:"SG",ovr:80,age:27},
  {id:69,name:"Andrew Wiggins",pos:"SF",ovr:78,age:30},
  {id:70,name:"Chris Paul",pos:"PG",ovr:77,age:40},
  {id:71,name:"Kyle Kuzma",pos:"PF",ovr:81,age:30},
  {id:72,name:"Jordan Poole",pos:"SG",ovr:81,age:26},
  {id:73,name:"Rudy Gobert",pos:"C",ovr:88,age:33},
  {id:74,name:"Brook Lopez",pos:"C",ovr:81,age:37},
  {id:75,name:"Bobby Portis",pos:"PF",ovr:80,age:30},
  {id:76,name:"Dillon Brooks",pos:"SF",ovr:78,age:29},
  {id:77,name:"Caris LeVert",pos:"SG",ovr:78,age:31},
  {id:78,name:"Spencer Dinwiddie",pos:"PG",ovr:77,age:32},
  {id:79,name:"Rui Hachimura",pos:"PF",ovr:78,age:27},
  {id:80,name:"Scoot Henderson",pos:"PG",ovr:77,age:22},
  {id:81,name:"Brandon Miller",pos:"SF",ovr:78,age:23},
  {id:82,name:"Keegan Murray",pos:"PF",ovr:78,age:25},
  {id:83,name:"Jabari Smith Jr.",pos:"PF",ovr:78,age:22},
  {id:84,name:"Amen Thompson",pos:"SG",ovr:77,age:22},
  {id:85,name:"Ausar Thompson",pos:"SF",ovr:77,age:22},
];

function buildCorePool(){
  const sorted = [...NBA_PLAYER_POOL].sort((a,b)=>b.ovr-a.ovr);
  return sorted.slice(0, 24).map(p=>({...p}));
}
function buildFreeAgentPool(){
  const coreIds = new Set(buildCorePool().map(p=>p.id));
  return NBA_PLAYER_POOL
    .filter(p => !coreIds.has(p.id))
    .map(p => ({ ...p, isCore:false, team:null }));
}

/* ====== State machine ======
   phase: "TEAM" -> "CORE" -> "HUB" -> "TRADE" -> "FA"
*/
function defaultState(){
  return {
    version: 4,
    phase: "TEAM",
    teamLocked: false,
    userTeam: null,
    userTeamId: null,
    corePool: buildCorePool(),
    chosenCoreIds: [],
    league: null,
    // non-core
    freeAgents: buildFreeAgentPool(),
    // season
    season: 1,
    gamesPerTeam: DEFAULT_GAMES_PER_TEAM,
    dayIndex: 0,
    scheduleDays: [],
    offseason: { active:false, draftDone:false, rookies:[] },
    log: [],
    createdAt: Date.now(),
    updatedAt: Date.now(),
  };
}

let state = loadState() ?? defaultState();
syncLegacyStateIfNeeded();
renderAll();

/* ====== Persistence ====== */
function saveState(){
  state.updatedAt = Date.now();
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}
function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return null;
    const parsed = JSON.parse(raw);
    if(!parsed || typeof parsed !== "object") return null;
    return parsed;
  }catch{ return null; }
}
function hardReset(){
  localStorage.removeItem(LS_KEY);
  state = defaultState();
  renderAll();
}

function syncLegacyStateIfNeeded(){
  if(!state.corePool || !Array.isArray(state.corePool) || state.corePool.length===0){
    state.corePool = buildCorePool();
  }
  if(!state.log) state.log = [];
  if(!state.gamesPerTeam) state.gamesPerTeam = DEFAULT_GAMES_PER_TEAM;
  if(!state.scheduleDays) state.scheduleDays = [];
  if(!state.freeAgents || !Array.isArray(state.freeAgents)){
    state.freeAgents = buildFreeAgentPool();
  }
  if(!state.offseason) state.offseason = { active:false, draftDone:false, rookies:[] };

  // regenerate schedule if missing
  if(state.league && state.league.length===30 && (!state.scheduleDays || state.scheduleDays.length===0)){
    state.dayIndex = state.dayIndex ?? 0;
    state.scheduleDays = generateSeasonSchedule(state.league.map(t=>t.id), state.gamesPerTeam);
    saveState();
  }
}

/* ====== Modal helper ====== */
function openModal({title, bodyHtml, actions}){
  el("modalTitle").textContent = title;
  el("modalBody").innerHTML = bodyHtml;
  const actionsBox = el("modalActions");
  actionsBox.innerHTML = "";
  actions.forEach(a=>{
    const btn = document.createElement("button");
    btn.textContent = a.label;
    btn.className = a.className || "ghost";
    btn.addEventListener("click", ()=>{ if(a.onClick) a.onClick(); });
    actionsBox.appendChild(btn);
  });
  el("modalBackdrop").style.display = "flex";
}
function closeModal(){ el("modalBackdrop").style.display = "none"; }
el("modalBackdrop").addEventListener("click",(e)=>{
  if(e.target === el("modalBackdrop")) closeModal();
});

/* ===== League helpers ===== */
function buildLeague(teamNames){
  return teamNames.map((name, id)=>({ id, name, w:0, l:0, roster:[] }));
}
function aiPickCoresFromPool(pool, usedIds, min=2, max=3){
  const need = rand(min, max);
  const picked = [];
  const pickedPos = new Set();

  const candidates = pool.filter(p=>!usedIds.has(p.id));
  candidates.sort((a,b)=>b.ovr-a.ovr);

  for(const p of candidates){
    if(picked.length>=need) break;
    if(!pickedPos.has(p.pos)){
      picked.push(p);
      pickedPos.add(p.pos);
      usedIds.add(p.id);
    }
  }
  if(picked.length < need){
    for(const p of candidates){
      if(picked.length>=need) break;
      if(usedIds.has(p.id)) continue;
      picked.push(p);
      usedIds.add(p.id);
    }
  }
  return picked;
}

/* ===== Trade logic (your 3.B) ===== */
function playerValue(p){
  let v = p.ovr;
  if(p.isCore) v += 22;
  return v;
}
function tradeMultiplier(give, get){
  const coreInvolved = !!(give?.isCore || get?.isCore);
  return coreInvolved ? 1.80 : 1.10;
}
function doTrade(oppTeamId, givePlayerId, getPlayerId){
  const myTeam = state.league[state.userTeamId];
  const oppTeam = state.league[oppTeamId];

  const give = myTeam.roster.find(p=>p.id===givePlayerId);
  const get  = oppTeam.roster.find(p=>p.id===getPlayerId);

  if(!give || !get) return { ok:false, reason:"找不到球員" };

  const giveV = playerValue(give);
  const getV  = playerValue(get);
  const mult  = tradeMultiplier(give, get);

  if(giveV < getV * mult){
    return { ok:false, reason:`對方拒絕：你的報價 ${giveV.toFixed(0)} 太低，需求 ≥ ${(getV*mult).toFixed(0)}` };
  }

  myTeam.roster = myTeam.roster.filter(p=>p.id!==givePlayerId);
  oppTeam.roster = oppTeam.roster.filter(p=>p.id!==getPlayerId);

  myTeam.roster.push({...get, team: myTeam.name});
  oppTeam.roster.push({...give, team: oppTeam.name});

  saveState();
  return { ok:true, give, get, mult, giveV, getV };
}

/* ===== Free Agency (non-core into team) ===== */
function rosterFull(team){ return (team.roster?.length ?? 0) >= MAX_ROSTER; }

function signFreeAgent(teamId, playerId){
  const team = state.league[teamId];
  if(rosterFull(team)) return { ok:false, reason:"名單已滿" };

  const idx = state.freeAgents.findIndex(p=>p.id===playerId);
  if(idx<0) return { ok:false, reason:"找不到自由球員" };

  const p = state.freeAgents[idx];
  state.freeAgents.splice(idx,1);

  team.roster.push({ ...p, isCore:false, team: team.name });
  saveState();
  return { ok:true, player:p };
}

// AI 每天有機率補 0~1 人（避免太快被簽光）
function aiSignFreeAgentsDaily(){
  if(!state.league || !state.freeAgents || state.freeAgents.length===0) return;

  // 優先把名單較少的隊補到更像真聯盟
  const teams = [...state.league].sort((a,b)=>(a.roster.length-b.roster.length));
  for(const team of teams){
    if(state.freeAgents.length===0) break;
    if(rosterFull(team)) continue;

    // 60% 機率今天補一人（推賽季時聯盟會慢慢變厚）
    if(Math.random() > 0.60) continue;

    // 以 OVR 為主，稍微偏向隊內缺的位置（簡化版）
    const needPos = mostNeededPos(team);
    let candidates = [...state.freeAgents];
    candidates.sort((x,y)=> (y.ovr-x.ovr) - (x.age-y.age));

    let pick = candidates.find(p=>p.pos===needPos) || candidates[0];
    if(!pick) continue;

    const res = signFreeAgent(team.id, pick.id);
    if(res.ok){
      // 不要刷太多 log，只記錄強一點的
      if(res.player.ovr >= 83) log(`AI 簽下：${team.name} 簽下 ${res.player.name}（${res.player.pos} ${res.player.ovr}）`, "muted");
    }
  }
}
function mostNeededPos(team){
  const count = {PG:0,SG:0,SF:0,PF:0,C:0};
  for(const p of team.roster) count[p.pos] = (count[p.pos]||0) + 1;
  // 找最少的
  let best="PG", min=Infinity;
  for(const k of Object.keys(count)){
    if(count[k] < min){ min=count[k]; best=k; }
  }
  return best;
}

/* ===== Season / games ===== */
function teamOVR(team){
  const roster = team.roster || [];
  if(roster.length===0) return 60;
  const values = roster.map(p=>p.ovr + (p.isCore ? 2 : 0));
  const avg = values.reduce((s,x)=>s+x,0)/values.length;
  return Math.round(avg);
}
function winProb(ovrA, ovrB){
  const diff = ovrA - ovrB;
  return 1/(1+Math.pow(10, -diff/15));
}
function simulateGame(teamA, teamB){
  const oA = teamOVR(teamA);
  const oB = teamOVR(teamB);
  const pA = winProb(oA, oB);
  const aWin = Math.random() < pA;

  const base = 98 + rand(-6, 10);
  const spread = clamp(Math.round((oA-oB)/2) + rand(-10,10), -22, 22);
  let scoreA = base + Math.max(0, spread) + rand(-8,8);
  let scoreB = base + Math.max(0, -spread) + rand(-8,8);
  if(scoreA===scoreB){ scoreA += rand(1,5); }

  if(aWin){
    if(scoreA<scoreB) [scoreA,scoreB]=[scoreB,scoreA];
    teamA.w++; teamB.l++;
  }else{
    if(scoreB<scoreA) [scoreA,scoreB]=[scoreB,scoreA];
    teamB.w++; teamA.l++;
  }
  return { aWin, scoreA, scoreB, oA, oB, pA };
}
function generateSeasonSchedule(teamIds, days){
  const schedule = [];
  for(let d=0; d<days; d++){
    const arr = [...teamIds];
    shuffle(arr);
    const matchups = [];
    for(let i=0;i<arr.length;i+=2){
      matchups.push([arr[i], arr[i+1]]);
    }
    schedule.push(matchups);
  }
  return schedule;
}
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j = rand(0,i);
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function standingsSorted(){
  return [...state.league].sort((x,y)=>{
    const px = x.w/(x.w+x.l || 1);
    const py = y.w/(y.w+y.l || 1);
    if(py!==px) return py-px;
    return teamOVR(y)-teamOVR(x);
  });
}

/* ===== Draft (rookies always non-core) ===== */
function genRookiePool(seasonNum, count=30){
  // 簡化：每季產生 30 名新秀（每隊一位）
  const firstNames = ["Jay","Dee","Kai","Noah","Liam","Evan","Jalen","Ty","Aiden","Mason","Zion","Cole","Drew","Max","Jordan","Cam","Troy","Kobe","Leo","Miles"];
  const lastNames  = ["Carter","Johnson","Williams","Brown","Davis","Miller","Taylor","Moore","Jackson","Martin","Lee","Walker","Harris","Young","Allen","Scott","Green","Baker","Hill","Reed"];
  const positions = ["PG","SG","SF","PF","C"];

  // 讓 rookie id 不會撞到 NBA_PLAYER_POOL：用大數字
  const baseId = 100000 + seasonNum*1000;

  const rookies = [];
  for(let i=0;i<count;i++){
    const fn = firstNames[rand(0,firstNames.length-1)];
    const ln = lastNames[rand(0,lastNames.length-1)];
    const pos = positions[rand(0,positions.length-1)];
    const ovr = rand(72, 80); // 新秀初始能力（之後可做潛力）
    const age = rand(19, 22);
    rookies.push({
      id: baseId + i,
      name: `${fn} ${ln}`,
      pos,
      ovr,
      age,
      isCore:false,
      team:null,
      rookie:true
    });
  }
  // 強一點的放前面，方便選秀
  rookies.sort((a,b)=>b.ovr-a.ovr);
  return rookies;
}

function beginOffseasonIfNeeded(){
  if(state.offseason?.active) return;

  state.offseason = state.offseason || {active:false,draftDone:false,rookies:[]};
  state.offseason.active = true;
  state.offseason.draftDone = false;
  state.offseason.rookies = genRookiePool(state.season, 30);

  saveState();

  openModal({
    title:"休賽季開始",
    bodyHtml: `
      <div class="tiny muted">例行賽結束，進入休賽季流程：</div>
      <ul class="tiny muted" style="margin:8px 0 0 18px;line-height:1.6">
        <li>選秀（每隊一位新秀，依排名倒序）</li>
        <li>你可以去自由市場補人</li>
        <li>準備好後按「新賽季」</li>
      </ul>
      <div class="tiny warnTxt" style="margin-top:10px">建議先選秀再開新賽季。</div>
    `,
    actions:[
      {label:"先去自由市場", className:"ghost", onClick: ()=>{ closeModal(); state.phase="FA"; saveState(); renderAll(); }},
      {label:"開始選秀", className:"primary", onClick: ()=>{ closeModal(); runDraft(); }}
    ]
  });
}

function runDraft(){
  if(!state.offseason.active || state.offseason.draftDone) {
    openModal({
      title:"選秀狀態",
      bodyHtml:`<div class="tiny muted">選秀已完成或尚未進入休賽季。</div>`,
      actions:[{label:"OK", className:"primary", onClick: closeModal}]
    });
    return;
  }
  const order = standingsSorted().slice().reverse().map(t=>t.id); // 倒序：戰績差先選
  const myId = state.userTeamId;

  const rookies = state.offseason.rookies;

  const pickLoop = (idx)=>{
    if(idx>=order.length){
      state.offseason.draftDone = true;
      saveState();
      log(`選秀完成：所有球隊各選 1 位新秀。`, "warnTxt");
      openModal({
        title:"選秀完成",
        bodyHtml:`<div class="tiny muted">休賽季：選秀已完成。</div>
                  <div class="tiny muted" style="margin-top:8px">你可以去自由市場補人，準備好後按「新賽季」。</div>`,
        actions:[
          {label:"去自由市場", className:"ghost", onClick: ()=>{ closeModal(); state.phase="FA"; saveState(); renderAll(); }},
          {label:"OK", className:"primary", onClick: closeModal}
        ]
      });
      return;
    }

    const teamId = order[idx];
    const team = state.league[teamId];

    if(rosterFull(team)){
      // 名單已滿，跳過
      pickLoop(idx+1);
      return;
    }

    if(teamId === myId){
      // 玩家回合：給你選 Top 5
      const options = rookies.slice(0,5);
      const rows = options.map(r=>`
        <div class="row space" style="padding:8px;border-bottom:1px solid rgba(255,255,255,.06)">
          <div>
            <b>${escapeHtml(r.name)}</b>
            <div class="tiny muted">${escapeHtml(r.pos)} · OVR ${r.ovr} · 年齡 ${r.age}</div>
          </div>
          <button class="primary" data-pick="${r.id}">選他</button>
        </div>
      `).join("");

      openModal({
        title:`你的選秀順位：${team.name}`,
        bodyHtml: `
          <div class="tiny muted">從前 5 新秀中選 1 位加入球隊（非基石）。</div>
          <div style="height:10px"></div>
          <div class="body" id="draftOptions" style="padding:0">${rows}</div>
        `,
        actions:[
          {label:"取消（先不選）", className:"ghost", onClick: closeModal}
        ]
      });

      // bind buttons
      setTimeout(()=>{
        const box = document.getElementById("draftOptions");
        if(!box) return;
        box.querySelectorAll("button[data-pick]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const pid = Number(btn.getAttribute("data-pick"));
            const rIdx = rookies.findIndex(x=>x.id===pid);
            if(rIdx<0) return;
            const rookie = rookies.splice(rIdx,1)[0];
            team.roster.push({ ...rookie, team: team.name });
            saveState();
            closeModal();
            log(`你選到新秀：${rookie.name}（${rookie.pos} ${rookie.ovr}）`, "goodTxt");
            pickLoop(idx+1);
          });
        });
      },0);

    }else{
      // AI 回合：拿最強且能補位置
      const needPos = mostNeededPos(team);
      let pickIndex = rookies.findIndex(r=>r.pos===needPos);
      if(pickIndex<0) pickIndex = 0;
      const rookie = rookies.splice(pickIndex,1)[0];
      if(rookie){
        team.roster.push({ ...rookie, team: team.name });
      }
      pickLoop(idx+1);
    }
  };

  pickLoop(0);
}

/* ===== Logging ===== */
function log(msg, cls=""){
  state.log.unshift({ t: Date.now(), msg, cls });
  if(state.log.length>200) state.log.length = 200;
}
function renderLog(){
  const box = el("log");
  box.innerHTML = state.log.slice(0,90).map(x=>{
    const time = new Date(x.t).toLocaleTimeString("zh-TW",{hour:"2-digit",minute:"2-digit"});
    return `<p class="${x.cls}"><span class="muted">[${time}]</span> ${escapeHtml(x.msg)}</p>`;
  }).join("") || `<p class="muted">（還沒有事件）</p>`;
}

/* ===== Sim day ===== */
function simulateOneDay(){
  if(!state.league) return;

  if(state.offseason?.active){
    log("目前是休賽季，請先完成選秀/補人，然後按「新賽季」。", "warnTxt");
    return;
  }

  if(state.dayIndex >= state.gamesPerTeam){
    log("季末已到，進入休賽季。", "warnTxt");
    beginOffseasonIfNeeded();
    return;
  }

  const today = state.scheduleDays[state.dayIndex];
  const myId = state.userTeamId;
  let myGameSummary = null;

  for(const [aId,bId] of today){
    const A = state.league[aId];
    const B = state.league[bId];
    const res = simulateGame(A,B);

    if(aId===myId || bId===myId){
      const me = (aId===myId) ? A : B;
      const opp= (aId===myId) ? B : A;
      const meScore = (aId===myId) ? res.scoreA : res.scoreB;
      const oppScore= (aId===myId) ? res.scoreB : res.scoreA;
      const win = (meScore > oppScore);
      myGameSummary = `${me.name} ${meScore}–${oppScore} ${opp.name}（${win?"勝":"敗"}）`;
    }
  }

  // AI 補人（非基石）— 每天一點點，聯盟會慢慢變厚
  aiSignFreeAgentsDaily();

  state.dayIndex++;
  if(myGameSummary) log(`Day ${state.dayIndex}: ${myGameSummary}`, "goodTxt");

  if(state.dayIndex >= state.gamesPerTeam){
    const top8 = standingsSorted().slice(0,8).map((t,i)=>`${i+1}. ${t.name}`).join("<br/>");
    log("例行賽結束！Top 8 已產生。", "warnTxt");
    openModal({
      title:"季末結算（Top 8）",
      bodyHtml:`<div class="tiny muted">賽季 S${state.season} 例行賽結束。</div>
               <div style="height:10px"></div>
               <div class="body tiny" style="line-height:1.6">${top8}</div>
               <div class="tiny warnTxt" style="margin-top:10px">接著進入休賽季：選秀 → 新賽季。</div>`,
      actions:[{label:"OK", className:"primary", onClick: ()=>{ closeModal(); beginOffseasonIfNeeded(); }}]
    });
  }

  saveState();
}

/* ===== Start new season ===== */
function startNewSeason(){
  if(!state.league) return;

  // 建議：休賽季如果未選秀，先提醒
  if(state.offseason?.active && !state.offseason.draftDone){
    openModal({
      title:"建議先選秀",
      bodyHtml:`<div class="tiny warnTxt"><b>你還沒完成選秀</b>（每隊一位新秀）。</div>
               <div class="tiny muted" style="margin-top:8px">要直接跳過也可以，但少一個補強機會。</div>`,
      actions:[
        {label:"現在選秀", className:"primary", onClick: ()=>{ closeModal(); runDraft(); }},
        {label:"先不選，直接開季", className:"warn", onClick: ()=>{ closeModal(); reallyStartNewSeason(); }}
      ]
    });
    return;
  }
  reallyStartNewSeason();
}
function reallyStartNewSeason(){
  state.season += 1;
  state.dayIndex = 0;
  for(const t of state.league){ t.w=0; t.l=0; }
  state.scheduleDays = generateSeasonSchedule(state.league.map(t=>t.id), state.gamesPerTeam);

  // 清除休賽季狀態
  state.offseason = { active:false, draftDone:false, rookies:[] };

  log(`新賽季 S${state.season} 開始（每隊 ${state.gamesPerTeam} 場）。`, "warnTxt");
  saveState();
}

/* ====== UI ====== */
function setPhaseUI(){
  const phase = state.phase;
  const hdrStatus = el("hdrStatus");

  const screenTeam = el("screenTeam");
  const screenCore = el("screenCore");
  const screenHub  = el("screenHub");
  const screenTrade= el("screenTrade");
  const screenFA   = el("screenFA");

  screenTeam.style.display  = (phase==="TEAM") ? "" : "none";
  screenCore.style.display  = (phase==="CORE") ? "" : "none";
  screenHub.style.display   = (phase==="HUB")  ? "" : "none";
  screenTrade.style.display = (phase==="TRADE")? "" : "none";
  screenFA.style.display    = (phase==="FA")   ? "" : "none";

  let title="選隊", pill="Step 1/6";
  if(phase==="CORE"){ title="選基石"; pill="Step 2/6"; }
  if(phase==="HUB"){ title="主介面"; pill="Step 3/6"; }
  if(phase==="TRADE"){ title="交易"; pill="Step 4/6"; }
  if(phase==="FA"){ title="自由市場"; pill="Step 5/6"; }

  el("phaseTitle").textContent = title;
  el("phasePill").textContent = pill;

  hdrStatus.textContent = (state.teamLocked && state.userTeam) ? `已選隊：${state.userTeam}` : "未選隊";

  // KPIs
  el("kpiSeason").textContent = state.league ? `S${state.season}` : "-";
  el("kpiDay").textContent = state.league ? (state.offseason?.active ? `休賽季` : `Day ${Math.min(state.dayIndex+1, state.gamesPerTeam)}/${state.gamesPerTeam}`) : "-";

  const myTeam = (state.league && state.userTeamId!=null) ? state.league[state.userTeamId] : null;
  el("kpiW").textContent = myTeam ? myTeam.w : 0;
  el("kpiL").textContent = myTeam ? myTeam.l : 0;

  el("seasonHint").textContent = state.league
    ? (state.offseason?.active ? `休賽季：選秀/補人` : `每隊 ${state.gamesPerTeam} 場`)
    : "尚未建立聯盟";
}

function renderTeamScreen(){
  const grid = el("teamGrid");
  grid.innerHTML = "";
  TEAMS.forEach(t=>{
    const btn = document.createElement("button");
    btn.className = "teamBtn";
    btn.innerHTML = `<div><b>${escapeHtml(t)}</b><div><small>點選後鎖定</small></div></div><span class="pill">選擇</span>`;
    btn.addEventListener("click", ()=>{
      if(state.teamLocked) return;
      openModal({
        title: "確認選隊",
        bodyHtml: `<div class="tiny muted">你確定要選擇：</div>
                  <div style="margin-top:6px;font-size:16px"><b>${escapeHtml(t)}</b></div>
                  <div class="tiny warnTxt" style="margin-top:10px">選完後無法更換（除非 Reset）。</div>`,
        actions: [
          {label:"取消", className:"ghost", onClick: closeModal},
          {label:"確定鎖定", className:"primary", onClick: ()=>{ closeModal(); chooseTeam(t); }}
        ]
      });
    });
    grid.appendChild(btn);
  });
}
function chooseTeam(teamName){
  state.userTeam = teamName;
  state.teamLocked = true;
  state.phase = "CORE";
  state.corePool = buildCorePool();
  state.chosenCoreIds = [];
  saveState();
  renderAll();
}

function renderCoreScreen(){
  const grid = el("coreGrid");
  grid.innerHTML = "";

  const selected = new Set(state.chosenCoreIds);
  const canFinish = state.chosenCoreIds.length >= 2;

  el("coreCountTag").textContent = `已選 ${state.chosenCoreIds.length}`;
  el("btnFinishCore").disabled = !canFinish;

  state.corePool.forEach(p=>{
    const isSelected = selected.has(p.id);
    const btn = document.createElement("button");
    btn.className = "teamBtn";
    btn.style.border = isSelected ? "1px solid rgba(34,197,94,.7)" : "1px solid var(--stroke)";
    btn.style.background = isSelected ? "rgba(34,197,94,.12)" : "var(--panel)";
    btn.innerHTML = `
      <div>
        <b>${escapeHtml(p.name)} ${isSelected ? `<span class="star">★</span>` : ""}</b>
        <div><small>${escapeHtml(p.pos)} · OVR ${p.ovr} · 年齡 ${p.age}</small></div>
      </div>
      <span class="pill">${isSelected ? "已選" : "選取"}</span>
    `;
    btn.addEventListener("click", ()=>toggleCorePick(p.id));
    grid.appendChild(btn);
  });

  el("btnFinishCore").onclick = ()=>{
    if(state.chosenCoreIds.length < 2) return;
    finalizeCoreAndLeague();
  };
}
function toggleCorePick(playerId){
  const idx = state.chosenCoreIds.indexOf(playerId);
  if(idx >= 0){
    state.chosenCoreIds.splice(idx,1);
  }else{
    if(state.chosenCoreIds.length >= 3){
      openModal({
        title:"已達上限",
        bodyHtml:`<div class="tiny muted">你最多只能選 <b>3</b> 位基石。</div>`,
        actions:[{label:"OK", className:"primary", onClick: closeModal}]
      });
      return;
    }
    state.chosenCoreIds.push(playerId);
  }
  saveState();
  renderAll();
}

function finalizeCoreAndLeague(){
  state.league = buildLeague(TEAMS);
  state.userTeamId = TEAMS.indexOf(state.userTeam);

  const chosen = new Set(state.chosenCoreIds);
  const myCores = state.corePool
    .filter(p=>chosen.has(p.id))
    .map(p=>({...p, isCore:true, team: state.userTeam}));

  const usedIds = new Set(myCores.map(p=>p.id));
  state.league[state.userTeamId].roster = myCores;

  const pool = [...NBA_PLAYER_POOL].sort((a,b)=>b.ovr-a.ovr);
  for(const team of state.league){
    if(team.id === state.userTeamId) continue;
    const aiCores = aiPickCoresFromPool(pool, usedIds, 2, 3).map(p=>({...p, isCore:true, team: team.name}));
    team.roster = aiCores;
  }

  state.dayIndex = 0;
  state.scheduleDays = generateSeasonSchedule(state.league.map(t=>t.id), state.gamesPerTeam);

  // 初始化自由市場（保證是非基石）
  state.freeAgents = buildFreeAgentPool();

  // 休賽季關掉
  state.offseason = { active:false, draftDone:false, rookies:[] };

  log(`你已完成建隊：${state.userTeam}（基石 ${myCores.length} 位）。`, "goodTxt");
  log(`賽季 S${state.season} 開始（每隊 ${state.gamesPerTeam} 場）。`, "warnTxt");

  state.phase = "HUB";
  saveState();
  renderAll();
}

function renderHubScreen(){
  const myTeam = state.league?.[state.userTeamId];
  el("hubTeamPill").textContent = state.userTeam ? `你的隊伍：${state.userTeam}` : "-";
  el("rosterCapPill").textContent = myTeam ? `名單：${myTeam.roster.length}/${MAX_ROSTER}` : "-";

  el("btnGoTrade").onclick = ()=>{
    state.phase = "TRADE";
    saveState();
    renderAll();
  };
  el("btnGoFA").onclick = ()=>{
    state.phase = "FA";
    saveState();
    renderAll();
  };

  const table = el("rosterTable");
  const roster = myTeam?.roster ?? [];

  if(roster.length===0){
    table.innerHTML = `<tr><td class="muted">目前名單是空的。</td></tr>`;
  }else{
    const rows = [...roster]
      .sort((a,b)=> (b.isCore-a.isCore) || (b.ovr-a.ovr))
      .map(p=>`
        <tr>
          <td>
            <button class="linkBtn" data-pid="${p.id}">${escapeHtml(p.name)}</button>
            ${p.isCore ? `<span class="star">★</span>` : ""}
            ${p.rookie ? `<span class="pill">R</span>` : ""}
            <div class="tiny muted">${escapeHtml(p.pos)} · OVR ${p.ovr}</div>
          </td>
          <td>${p.age}</td>
          <td>${escapeHtml(p.team ?? state.userTeam ?? "-")}</td>
        </tr>
      `).join("");
    table.innerHTML = `
      <thead><tr><th>球員</th><th>年齡</th><th>球隊</th></tr></thead>
      <tbody>${rows}</tbody>
    `;
    table.querySelectorAll("button[data-pid]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const pid = Number(btn.getAttribute("data-pid"));
        const player = roster.find(x=>x.id===pid);
        if(player) showPlayerDetail(player);
      });
    });
  }

  renderStandings();
  renderLeagueCores();
}

function renderStandings(){
  const tbl = el("standingsTable");
  if(!state.league){
    tbl.innerHTML = `<tr><td class="muted">聯盟尚未建立。</td></tr>`;
    return;
  }
  const sorted = standingsSorted();
  const myId = state.userTeamId;
  const rows = sorted.map((t,i)=>{
    const gp = t.w+t.l;
    const pct = gp? (t.w/gp) : 0;
    const ovr = teamOVR(t);
    const highlight = (t.id===myId) ? `style="background:rgba(34,197,94,.08)"` : "";
    return `
      <tr ${highlight}>
        <td>${i+1}</td>
        <td>${escapeHtml(t.name)}</td>
        <td>${t.w}-${t.l}</td>
        <td>${pct.toFixed(3)}</td>
        <td>${ovr}</td>
      </tr>
    `;
  }).join("");
  tbl.innerHTML = `
    <thead><tr><th>#</th><th>球隊</th><th>戰績</th><th>勝率</th><th>隊伍OVR</th></tr></thead>
    <tbody>${rows}</tbody>
  `;
}

function renderLeagueCores(){
  const list = el("leagueCoresList");
  if(!state.league){
    list.innerHTML = `<div class="item muted">聯盟尚未建立。</div>`;
    return;
  }
  list.innerHTML = state.league.map(team=>{
    const cores = (team.roster||[])
      .filter(p=>p.isCore)
      .map(p=>`${escapeHtml(p.name)} <span class="muted tiny">(${escapeHtml(p.pos)} ${p.ovr})</span> <span class="star">★</span>`)
      .join("<br/>");
    return `
      <div class="item">
        <b>${escapeHtml(team.name)}</b>
        <div class="tiny" style="margin-top:6px">${cores || `<span class="muted">（空）</span>`}</div>
      </div>
    `;
  }).join("");
}

/* ===== Trade UI ===== */
function renderTradeScreen(){
  const myTeam = state.league[state.userTeamId];
  el("tradeHintPill").textContent = `你的隊伍：${myTeam.name}`;

  const oppSel = el("oppSelect");
  oppSel.innerHTML = "";
  state.league.forEach(t=>{
    if(t.id===state.userTeamId) return;
    const opt = document.createElement("option");
    opt.value = t.id;
    opt.textContent = t.name;
    oppSel.appendChild(opt);
  });

  setupTradeForOpponent(Number(oppSel.value));
  oppSel.onchange = ()=>setupTradeForOpponent(Number(oppSel.value));
  el("btnRefreshTrade").onclick = ()=>setupTradeForOpponent(Number(oppSel.value));

  el("btnBackHubFromTrade").onclick = ()=>{
    state.phase = "HUB";
    saveState();
    renderAll();
  };

  el("btnTrade").onclick = ()=>{
    const oppTeamId = Number(oppSel.value);
    const giveId = Number(el("giveSelect").value);
    const getId  = Number(el("getSelect").value);

    const res = doTrade(oppTeamId, giveId, getId);
    if(!res.ok){
      openModal({
        title:"交易失敗",
        bodyHtml:`<div class="tiny badTxt">${escapeHtml(res.reason)}</div>`,
        actions:[{label:"OK", className:"primary", onClick: closeModal}]
      });
      return;
    }

    log(`交易成功：送出 ${res.give.name}，得到 ${res.get.name}。`, "goodTxt");

    openModal({
      title:"交易成功",
      bodyHtml: `
        <div class="tiny goodTxt"><b>完成交易！</b></div>
        <div style="height:8px"></div>
        <div class="tiny muted">你送出：</div>
        <div><b>${escapeHtml(res.give.name)}</b> ${res.give.isCore?`<span class="star">★</span>`:""} <span class="muted tiny">(${escapeHtml(res.give.pos)} ${res.give.ovr})</span></div>
        <div style="height:8px"></div>
        <div class="tiny muted">你得到：</div>
        <div><b>${escapeHtml(res.get.name)}</b> ${res.get.isCore?`<span class="star">★</span>`:""} <span class="muted tiny">(${escapeHtml(res.get.pos)} ${res.get.ovr})</span></div>
        <div style="height:10px"></div>
        <div class="tiny muted">倍率：${res.mult.toFixed(2)}（牽涉基石更難）</div>
      `,
      actions:[{label:"OK", className:"primary", onClick: ()=>{ closeModal(); renderAll(); }}]
    });
  };
}

function setupTradeForOpponent(oppTeamId){
  const myTeam = state.league[state.userTeamId];
  const oppTeam = state.league[oppTeamId];

  const giveSel = el("giveSelect");
  const getSel  = el("getSelect");
  giveSel.innerHTML = "";
  getSel.innerHTML = "";

  const myRoster = [...myTeam.roster].sort((a,b)=>(b.isCore-a.isCore)||(b.ovr-a.ovr));
  const oppRoster= [...oppTeam.roster].sort((a,b)=>(b.isCore-a.isCore)||(b.ovr-a.ovr));

  myRoster.forEach(p=>{
    const opt = document.createElement("option");
    opt.value = p.id;
    opt.textContent = `${p.isCore?"★ ":""}${p.name} (${p.pos} ${p.ovr})`;
    giveSel.appendChild(opt);
  });
  oppRoster.forEach(p=>{
    const opt = document.createElement("option");
    opt.value = p.id;
    opt.textContent = `${p.isCore?"★ ":""}${p.name} (${p.pos} ${p.ovr})`;
    getSel.appendChild(opt);
  });

  el("myRosterMini").innerHTML = myRoster.map(p=>`
    <div class="item">
      <button class="linkBtn" data-pid="${p.id}">${escapeHtml(p.name)}</button>
      ${p.isCore?`<span class="star">★</span>`:""}
      ${p.rookie?`<span class="pill">R</span>`:""}
      <div class="tiny muted">${escapeHtml(p.pos)} · OVR ${p.ovr} · 價值 ${playerValue(p).toFixed(0)}</div>
    </div>
  `).join("");

  el("oppRosterMini").innerHTML = oppRoster.map(p=>`
    <div class="item">
      <button class="linkBtn" data-opid="${p.id}">${escapeHtml(p.name)}</button>
      ${p.isCore?`<span class="star">★</span>`:""}
      ${p.rookie?`<span class="pill">R</span>`:""}
      <div class="tiny muted">${escapeHtml(p.pos)} · OVR ${p.ovr} · 價值 ${playerValue(p).toFixed(0)}</div>
    </div>
  `).join("");

  el("myRosterMini").querySelectorAll("button[data-pid]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const pid = Number(btn.getAttribute("data-pid"));
      const p = myTeam.roster.find(x=>x.id===pid);
      if(p) showPlayerDetail(p);
    });
  });
  el("oppRosterMini").querySelectorAll("button[data-opid]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const pid = Number(btn.getAttribute("data-opid"));
      const p = oppTeam.roster.find(x=>x.id===pid);
      if(p) showPlayerDetail(p);
    });
  });

  function refreshValueInfo(){
    const give = myTeam.roster.find(p=>p.id===Number(giveSel.value));
    const get  = oppTeam.roster.find(p=>p.id===Number(getSel.value));
    const mult = tradeMultiplier(give, get);
    el("giveValueInfo").textContent = give ? `價值：${playerValue(give).toFixed(0)}${give.isCore?"（基石加權）":""}` : "價值：-";
    el("getValueInfo").textContent  = get  ? `價值：${playerValue(get).toFixed(0)}${get.isCore?"（基石加權）":""}` : "價值：-";
    el("aiRuleInfo").innerHTML = `AI 規則：你的報價價值 ≥ 對手球員價值 × <b>${mult.toFixed(2)}</b>（牽涉基石更難）`;
  }
  giveSel.onchange = refreshValueInfo;
  getSel.onchange  = refreshValueInfo;
  refreshValueInfo();
}

/* ===== Free Agency UI ===== */
function renderFAScreen(){
  const myTeam = state.league[state.userTeamId];
  el("faHintPill").textContent = `自由球員：${state.freeAgents.length}｜你的名單：${myTeam.roster.length}/${MAX_ROSTER}`;

  el("btnBackHubFromFA").onclick = ()=>{
    state.phase = "HUB";
    saveState();
    renderAll();
  };

  const searchBox = el("faSearch");
  const posFilter = el("faPosFilter");
  const sortSel   = el("faSort");

  const renderFALists = ()=>{
    let list = [...state.freeAgents];

    const q = (searchBox.value||"").trim().toLowerCase();
    if(q){
      list = list.filter(p=>p.name.toLowerCase().includes(q));
    }
    const pos = posFilter.value;
    if(pos){
      list = list.filter(p=>p.pos===pos);
    }
    const sort = sortSel.value;
    if(sort==="ovr") list.sort((a,b)=>b.ovr-a.ovr);
    if(sort==="age") list.sort((a,b)=>a.age-b.age);
    if(sort==="name") list.sort((a,b)=>a.name.localeCompare(b.name));

    const show = list.slice(0,40);
    const box = el("faList");
    box.innerHTML = show.map(p=>`
      <div class="item">
        <div class="row space">
          <div>
            <button class="linkBtn" data-faid="${p.id}">${escapeHtml(p.name)}</button>
            <div class="tiny muted">${escapeHtml(p.pos)} · OVR ${p.ovr} · 年齡 ${p.age}</div>
          </div>
          <button class="primary" data-sign="${p.id}" ${rosterFull(myTeam) ? "disabled" : ""}>簽下</button>
        </div>
      </div>
    `).join("") || `<div class="item muted">（沒有符合條件的自由球員）</div>`;

    // bind
    box.querySelectorAll("button[data-faid]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const pid = Number(btn.getAttribute("data-faid"));
        const p = state.freeAgents.find(x=>x.id===pid);
        if(p) showPlayerDetail(p);
      });
    });
    box.querySelectorAll("button[data-sign]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const pid = Number(btn.getAttribute("data-sign"));
        const res = signFreeAgent(state.userTeamId, pid);
        if(!res.ok){
          openModal({ title:"簽約失敗", bodyHtml:`<div class="tiny badTxt">${escapeHtml(res.reason)}</div>`, actions:[{label:"OK", className:"primary", onClick: closeModal}]});
          return;
        }
        log(`你簽下：${res.player.name}（${res.player.pos} ${res.player.ovr}）`, "goodTxt");
        saveState();
        renderAll();
      });
    });

    // my roster mini
    const myBox = el("faMyRoster");
    const roster = [...myTeam.roster].sort((a,b)=>(b.isCore-a.isCore)||(b.ovr-a.ovr));
    myBox.innerHTML = roster.map(p=>`
      <div class="item">
        <button class="linkBtn" data-mepid="${p.id}">${escapeHtml(p.name)}</button>
        ${p.isCore?`<span class="star">★</span>`:""}
        ${p.rookie?`<span class="pill">R</span>`:""}
        <div class="tiny muted">${escapeHtml(p.pos)} · OVR ${p.ovr}</div>
      </div>
    `).join("") || `<div class="item muted">（空）</div>`;

    myBox.querySelectorAll("button[data-mepid]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const pid = Number(btn.getAttribute("data-mepid"));
        const p = myTeam.roster.find(x=>x.id===pid);
        if(p) showPlayerDetail(p);
      });
    });

    el("faHintPill").textContent = `自由球員：${state.freeAgents.length}｜你的名單：${myTeam.roster.length}/${MAX_ROSTER}`;
  };

  searchBox.oninput = renderFALists;
  posFilter.onchange = renderFALists;
  sortSel.onchange = renderFALists;

  renderFALists();
}

/* ===== Player detail ===== */
function showPlayerDetail(p){
  openModal({
    title: "球員詳細資訊",
    bodyHtml: `
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <div style="font-size:18px"><b>${escapeHtml(p.name)}</b>
            ${p.isCore?` <span class="star">★ 基石</span>`:""}
            ${p.rookie?` <span class="pill">R 新秀</span>`:""}
          </div>
          <div class="tiny muted" style="margin-top:4px">${escapeHtml(p.team ?? "自由球員")}</div>
        </div>
        <span class="pill">OVR ${p.ovr}</span>
      </div>
      <div style="height:10px"></div>
      <div class="row">
        <span class="pill">位置：${escapeHtml(p.pos)}</span>
        <span class="pill">年齡：${p.age}</span>
        <span class="pill">價值：${playerValue(p).toFixed(0)}${p.isCore?"（基石加權）":""}</span>
        <span class="pill">ID：${p.id}</span>
      </div>
      <div style="height:10px"></div>
      <div class="tiny muted">
        非基石進隊方式：自由市場簽下 / 選秀加入 / 交易拿到。<br/>
        （下一步要做「薪資/合約/潛力」也很好接。）
      </div>
    `,
    actions:[{label:"關閉", className:"primary", onClick: closeModal}]
  });
}

/* ===== Controls: Sim / new season / log ===== */
el("btnSim1").addEventListener("click", ()=>{
  if(!state.league){ log("請先完成選隊與選基石。", "warnTxt"); renderAll(); return; }
  simulateOneDay();
  renderAll();
});
el("btnSim7").addEventListener("click", ()=>{
  if(!state.league){ log("請先完成選隊與選基石。", "warnTxt"); renderAll(); return; }
  for(let i=0;i<7;i++){
    if(state.offseason?.active) break;
    simulateOneDay();
  }
  renderAll();
});
el("btnSimAll").addEventListener("click", ()=>{
  if(!state.league){ log("請先完成選隊與選基石。", "warnTxt"); renderAll(); return; }
  while(!state.offseason?.active){
    simulateOneDay();
    if(state.dayIndex>=state.gamesPerTeam) break;
  }
  renderAll();
});
el("btnNewSeason").addEventListener("click", ()=>{
  if(!state.league){ log("請先完成選隊與選基石。", "warnTxt"); renderAll(); return; }
  openModal({
    title:"開始新賽季",
    bodyHtml:`<div class="tiny muted">會把全聯盟戰績清零，重新生成賽程。</div>
             <div class="tiny warnTxt" style="margin-top:8px">（你的球員、交易、簽約、新秀都保留）</div>`,
    actions:[
      {label:"取消", className:"ghost", onClick: closeModal},
      {label:"開始", className:"primary", onClick: ()=>{ closeModal(); startNewSeason(); renderAll(); }}
    ]
  });
});

el("btnClearLog").addEventListener("click", ()=>{
  state.log = [];
  saveState();
  renderAll();
});

/* ===== Reset / Export / Import ===== */
el("btnReset").addEventListener("click", ()=>{
  openModal({
    title: "Reset（清空全部進度）",
    bodyHtml: `
      <div class="tiny warnTxt"><b>注意：</b>Reset 會清空所有進度，回到選隊畫面。</div>
      <div class="tiny muted" style="margin-top:10px">請在下方輸入 <b>RESET</b>（全大寫）確認。</div>
      <div style="height:10px"></div>
      <input id="resetInput" placeholder="輸入 RESET" />
    `,
    actions:[
      {label:"取消", className:"ghost", onClick: closeModal},
      {label:"確定 Reset", className:"danger", onClick: ()=>{
        const val = (document.getElementById("resetInput")?.value ?? "").trim();
        if(val !== "RESET"){
          openModal({
            title:"輸入錯誤",
            bodyHtml:`<div class="tiny muted">你輸入的是：<b>${escapeHtml(val||"(空)")}</b></div>
                      <div class="tiny warnTxt" style="margin-top:8px">必須完整輸入 <b>RESET</b> 才能清空。</div>`,
            actions:[{label:"OK", className:"primary", onClick: closeModal}]
          });
          return;
        }
        closeModal();
        hardReset();
      }}
    ]
  });
});

el("btnExport").addEventListener("click", ()=>{
  const json = JSON.stringify(state, null, 2);
  const tryCopy = async ()=>{
    try{
      await navigator.clipboard.writeText(json);
      openModal({
        title:"Export 成功",
        bodyHtml:`<div class="tiny muted">已把存檔 JSON 複製到剪貼簿。</div>
                  <div class="tiny muted" style="margin-top:8px">你也可以在下方查看：</div>
                  <pre class="tiny" style="white-space:pre-wrap;background:var(--panel);border:1px solid var(--stroke);padding:10px;border-radius:12px;max-height:240px;overflow:auto">${escapeHtml(json)}</pre>`,
        actions:[{label:"關閉", className:"primary", onClick: closeModal}]
      });
    }catch{
      openModal({
        title:"Export",
        bodyHtml:`<div class="tiny muted">瀏覽器不允許自動複製，請手動複製下面內容：</div>
                  <pre class="tiny" style="white-space:pre-wrap;background:var(--panel);border:1px solid var(--stroke);padding:10px;border-radius:12px;max-height:260px;overflow:auto">${escapeHtml(json)}</pre>`,
        actions:[{label:"關閉", className:"primary", onClick: closeModal}]
      });
    }
  };
  tryCopy();
});

el("btnImport").addEventListener("click", ()=>{
  const raw = (el("importBox").value ?? "").trim();
  if(!raw){
    openModal({
      title:"Import 失敗",
      bodyHtml:`<div class="tiny muted">你沒有貼任何 JSON。</div>`,
      actions:[{label:"OK", className:"primary", onClick: closeModal}]
    });
    return;
  }
  openModal({
    title:"確認 Import（覆蓋）",
    bodyHtml:`<div class="tiny warnTxt"><b>注意：</b>Import 會覆蓋你目前進度。</div>
              <div class="tiny muted" style="margin-top:8px">確定要套用貼上的存檔嗎？</div>`,
    actions:[
      {label:"取消", className:"ghost", onClick: closeModal},
      {label:"確定 Import", className:"warn", onClick: ()=>{
        try{
          const parsed = JSON.parse(raw);
          if(!parsed || typeof parsed !== "object") throw new Error("bad json");
          if(!parsed.phase) throw new Error("missing phase");
          state = parsed;
          syncLegacyStateIfNeeded();
          saveState();
          closeModal();
          renderAll();
        }catch{
          closeModal();
          openModal({
            title:"Import 失敗",
            bodyHtml:`<div class="tiny muted">JSON 格式不正確或缺少必要欄位。</div>`,
            actions:[{label:"OK", className:"primary", onClick: closeModal}]
          });
        }
      }}
    ]
  });
});

/* ===== Main render ===== */
function renderAll(){
  setPhaseUI();
  renderLog();

  if(state.phase==="TEAM"){
    renderTeamScreen();
  }else if(state.phase==="CORE"){
    renderCoreScreen();
  }else if(state.phase==="HUB"){
    renderHubScreen();
  }else if(state.phase==="TRADE"){
    renderTradeScreen();
  }else if(state.phase==="FA"){
    renderFAScreen();
  }

  const ready = !!state.league;

  el("btnSim1").disabled = !ready;
  el("btnSim7").disabled = !ready;
  el("btnSimAll").disabled = !ready;
  el("btnNewSeason").disabled = !ready;
}
</script>
</body>
</html>
